/**
 * æµ‹è¯„è®¡åˆ†å’ŒæŠ¥å‘Šç”Ÿæˆé€»è¾‘ - ä¸“ä¸šä¼˜åŒ–ç‰ˆ
 * æ”¯æŒ35é¢˜ + 9ç»´åº¦ + æ•ˆåº¦æ£€éªŒ + AIä¸ªæ€§åŒ–åˆ†æ
 */

import { generatePersonalizedAnalysis, generateEnhancedAnalysis } from './aiService.js'

// ==================== æ•ˆåº¦æ£€éªŒ ====================
function checkValidity(answers) {
  const q34 = answers[34]
  const q35 = answers[35]
  
  let isValid = true
  let warnings = []
  
  // æ£€æŸ¥Q34ï¼šä»æœªç´§å¼ è¿‡ï¼ˆä¸ç¬¦åˆå®é™…ï¼Œscoreä¸º-999ï¼‰
  if (q34 === -999) {
    warnings.push('æ£€æµ‹åˆ°ç–‘ä¼¼æ— æ•ˆä½œç­”ï¼ˆQ34é€‰æ‹©äº†"ä»æœªç´§å¼ "ï¼‰')
    isValid = false
  }
  
  // æ£€æŸ¥Q35ï¼šéšä¾¿é€‰çš„ï¼ˆä½è´¨é‡ä½œç­”ï¼Œscoreä¸º-888ï¼‰
  if (q35 === -888) {
    warnings.push('æ£€æµ‹åˆ°ä½è´¨é‡ä½œç­”ï¼ˆQ35æ‰¿è®¤éšæ„ä½œç­”ï¼‰')
    isValid = false
  }
  
  return { isValid, warnings }
}

// ==================== è®¡ç®—å„ç»´åº¦å¾—åˆ† ====================
export function calculateScores(answers) {
  const dimensions = {
    scene_fear: [1, 2, 3, 4, 5],                    // ç¤¾äº¤åœºæ™¯ææƒ§ï¼ˆ5é¢˜ï¼‰
    avoidance: [6, 7, 8, 9],                        // å›é¿è¡Œä¸ºç¨‹åº¦ï¼ˆ4é¢˜ï¼‰
    anticipation: [10, 11, 12, 13],                 // é¢„æœŸç„¦è™‘å¼ºåº¦ï¼ˆ4é¢˜ï¼‰
    fear_of_negative_evaluation: [14, 15, 16, 17, 18], // è´Ÿé¢è¯„ä»·ææƒ§ï¼ˆ5é¢˜ï¼‰â­æ–°å¢
    rumination: [19, 20, 21, 22],                   // ç¤¾äº¤åååˆï¼ˆ4é¢˜ï¼‰
    physical: [23, 24, 25],                         // ç”Ÿç†ååº”å¼ºåº¦ï¼ˆ3é¢˜ï¼‰
    functional_impairment: [26, 27, 28, 29],        // åŠŸèƒ½æŸå®³ç¨‹åº¦ï¼ˆ4é¢˜ï¼‰â­æ–°å¢
    self_efficacy: [30, 31, 32, 33]                 // ç¤¾äº¤è‡ªæˆ‘æ•ˆèƒ½ï¼ˆ4é¢˜ï¼‰
  }
  
  let totalScore = 0
  let dimensionScores = {}
  
  Object.entries(dimensions).forEach(([key, questionIds]) => {
    let sum = 0
    questionIds.forEach(id => {
      const score = parseInt(answers[id] || 0)
      // æ’é™¤æ•ˆåº¦é¢˜çš„è´Ÿåˆ†
      if (score > 0) {
        sum += score
      }
    })
    dimensionScores[key] = sum
    totalScore += sum
  })
  
  return {
    total: totalScore,
    dimensions: dimensionScores
  }
}

// ==================== åŸºäºåŸºç¡€ä¿¡æ¯çš„ä¸ªæ€§åŒ–ç­‰çº§åˆ¤æ–­ ====================
export function getLevel(score, basicInfo = {}) {
  // åŸºç¡€é˜ˆå€¼ï¼š100åˆ†åˆ¶ï¼ˆä»165åˆ†åˆ¶è½¬æ¢è€Œæ¥ï¼‰
  // åŸ165åˆ†åˆ¶ï¼šnormal: 49, mild: 82, moderate: 115, severe: 148
  // è½¬æ¢ä¸º100åˆ†åˆ¶ï¼šnormal: 30, mild: 50, moderate: 70, severe: 90
  let thresholds = {
    normal: 30,    // ç¤¾äº¤è‡ªå¦‚å‹ï¼ˆçº¦29.7åˆ†ï¼Œå››èˆäº”å…¥ä¸º30ï¼‰
    mild: 50,      // è½»åº¦ï¼ˆçº¦49.7åˆ†ï¼Œå››èˆäº”å…¥ä¸º50ï¼‰
    moderate: 70,  // ä¸­åº¦ï¼ˆçº¦69.7åˆ†ï¼Œå››èˆäº”å…¥ä¸º70ï¼‰
    severe: 90     // é‡åº¦ï¼ˆçº¦89.7åˆ†ï¼Œå››èˆäº”å…¥ä¸º90ï¼‰
  }
  
  // ========== å¹´é¾„æ®µæ ¡æ­£å› å­ ==========
  // å¿ƒç†å­¦ç ”ç©¶ï¼šå¹´è½»äººçš„ç¤¾äº¤ç„¦è™‘æ›´å¸¸è§ï¼Œé˜ˆå€¼å¯ä»¥é€‚å½“æ”¾å®½
  // ä¸­å¹´äººç¤¾äº¤ç„¦è™‘æ›´å€¼å¾—å…³æ³¨ï¼Œé˜ˆå€¼å¯ä»¥æ›´ä¸¥æ ¼
  const ageFactor = {
    teen: 0.95,        // 12-17å²ï¼šé˜ˆå€¼æ”¾å®½5%ï¼ˆæ›´å®½å®¹ï¼‰
    college: 0.92,     // 18-22å²ï¼šé˜ˆå€¼æ”¾å®½8%ï¼ˆå¤§å­¦ç”Ÿç¤¾æå¾ˆå¸¸è§ï¼‰
    young_adult: 1.0,  // 23-29å²ï¼šåŸºå‡†å€¼
    adult: 1.05,       // 30-39å²ï¼šé˜ˆå€¼æ”¶ç´§5%ï¼ˆéœ€è¦æ›´å…³æ³¨ï¼‰
    mature: 1.08       // 40+å²ï¼šé˜ˆå€¼æ”¶ç´§8%ï¼ˆæ›´éœ€è¦å…³æ³¨ï¼‰
  }
  
  const age = basicInfo.age || 'young_adult'
  const ageMultiplier = ageFactor[age] || 1.0
  
  // ========== æ€§åˆ«æ ¡æ­£å› å­ ==========
  // å¿ƒç†å­¦ç ”ç©¶ï¼šå¥³æ€§åœ¨ç¤¾äº¤ç„¦è™‘çš„æŸäº›ç»´åº¦å¯èƒ½æ›´æ•æ„Ÿ
  // ä½†è¿™ä¸æ˜¯è¯´å¥³æ€§æ›´ä¸¥é‡ï¼Œè€Œæ˜¯è¡¨ç°æ–¹å¼ä¸åŒ
  const genderFactor = {
    female: 1.02,  // å¥³æ€§ï¼šè½»å¾®æ”¶ç´§ï¼ˆ2%ï¼‰
    male: 1.0,     // ç”·æ€§ï¼šåŸºå‡†å€¼
    other: 1.0     // å…¶ä»–ï¼šåŸºå‡†å€¼
  }
  
  const gender = basicInfo.gender || 'other'
  const genderMultiplier = genderFactor[gender] || 1.0
  
  // ========== ç¤¾äº¤é¢‘ç‡æ ¡æ­£å› å­ ==========
  // ç¤¾äº¤é¢‘ç‡è¶Šä½ï¼Œè¯´æ˜å›é¿è¶Šä¸¥é‡ï¼Œéœ€è¦æ›´ä¸¥æ ¼çš„é˜ˆå€¼
  const frequencyFactor = {
    rarely: 1.10,      // å‡ ä¹ä¸å‚åŠ ï¼šé˜ˆå€¼æ”¶ç´§10%ï¼ˆæ›´ä¸¥é‡ï¼‰
    occasional: 1.05,  // 1-2æ¬¡/å‘¨ï¼šé˜ˆå€¼æ”¶ç´§5%
    regular: 1.0,     // 3-4æ¬¡/å‘¨ï¼šåŸºå‡†å€¼
    frequent: 0.98     // 5æ¬¡ä»¥ä¸Šï¼šé˜ˆå€¼æ”¾å®½2%ï¼ˆæ›´æ´»è·ƒï¼‰
  }
  
  const freq = basicInfo.social_frequency || 'regular'
  const freqMultiplier = frequencyFactor[freq] || 1.0
  
  // ========== ç»¼åˆæ ¡æ­£ ==========
  // å–å¹³å‡å€¼ï¼Œé¿å…è¿‡åº¦æ ¡æ­£
  const totalMultiplier = (ageMultiplier + genderMultiplier + freqMultiplier) / 3
  
  // åº”ç”¨æ ¡æ­£åçš„é˜ˆå€¼
  thresholds = {
    normal: Math.round(thresholds.normal * totalMultiplier),
    mild: Math.round(thresholds.mild * totalMultiplier),
    moderate: Math.round(thresholds.moderate * totalMultiplier),
    severe: Math.round(thresholds.severe * totalMultiplier)
  }
  
  // ========== åˆ¤æ–­ç­‰çº§ ==========
  if (score <= thresholds.normal) {
    return { 
      name: 'ç¤¾äº¤è‡ªå¦‚å‹', 
      color: '#10b981', 
      desc: 'ä½ åœ¨ç¤¾äº¤åœºåˆè¡¨ç°è‡ªç„¶ï¼Œå¾ˆå°‘æ„Ÿåˆ°ç„¦è™‘ã€‚' 
    }
  }
  
  if (score <= thresholds.mild) {
    return { 
      name: 'è½»åº¦ç¤¾äº¤ç„¦è™‘', 
      color: '#3b82f6', 
      desc: 'æŸäº›ç¤¾äº¤åœºæ™¯ä¼šè®©ä½ ç´§å¼ ï¼Œä½†æ€»ä½“å¯æ§ã€‚' 
    }
  }
  
  if (score <= thresholds.moderate) {
    return { 
      name: 'ä¸­åº¦ç¤¾äº¤ç„¦è™‘', 
      color: '#f59e0b', 
      desc: 'ç¤¾äº¤ç„¦è™‘å·²æ˜æ˜¾å½±å“æ—¥å¸¸ç”Ÿæ´»' 
    }
  }
  
  if (score <= thresholds.severe) {
    return { 
      name: 'é‡åº¦ç¤¾äº¤ç„¦è™‘', 
      color: '#ef4444', 
      desc: 'ç¤¾äº¤ç„¦è™‘ä¸¥é‡å½±å“ç”Ÿæ´»è´¨é‡' 
    }
  }
  
  return { 
    name: 'æé‡åº¦ç¤¾äº¤ç„¦è™‘', 
    color: '#991b1b', 
    desc: 'å»ºè®®å°½å¿«å’¨è¯¢ä¸“ä¸šå¿ƒç†åŒ»ç”Ÿ' 
  }
}

// ==================== è®¡ç®—ç™¾åˆ†ä½ï¼ˆå·²ç§»é™¤ï¼Œä¸å†ä½¿ç”¨ï¼‰ ====================
// ä¸å†è®¡ç®—ç™¾åˆ†ä½ï¼Œé¿å…"å‡»è´¥å…¨å›½"çš„è¡¨è¿°

// ==================== åŸºäºåŸºç¡€ä¿¡æ¯çš„ä¸ªæ€§åŒ–ç±»å‹åˆ¤æ–­ ====================
export function getType(dimensions, basicInfo = {}) {
  // è´Ÿé¢è¯„ä»·ææƒ§å‹ï¼ˆæ–°å¢ï¼‰ï¼šæ ¸å¿ƒç‰¹å¾æ˜¯å®³æ€•è¢«è¯„ä»·
  // æ ¹æ®å¹´é¾„å’Œæ€§åˆ«è°ƒæ•´é˜ˆå€¼
  const age = basicInfo.age || 'young_adult'
  const gender = basicInfo.gender || 'other'
  
  // å¹´è½»å¥³æ€§æ›´å®¹æ˜“å‡ºç°è´Ÿé¢è¯„ä»·ææƒ§
  let fearThreshold = 20
  let ruminationThreshold = 15
  
  if (age === 'teen' || age === 'college') {
    fearThreshold = 18  // å¹´è½»äººé˜ˆå€¼é™ä½
    ruminationThreshold = 14
  }
  
  if (gender === 'female') {
    fearThreshold = 19  // å¥³æ€§å¯èƒ½æ›´æ•æ„Ÿ
  }
  
  if (dimensions.fear_of_negative_evaluation >= fearThreshold && dimensions.rumination >= ruminationThreshold) {
    return {
      id: 'fear_evaluation',
      name: 'è´Ÿé¢è¯„ä»·ææƒ§å‹ç¤¾æ',
      englishName: 'Fear of Negative Evaluation Type',
      features: [
        'æåº¦åœ¨æ„åˆ«äººçš„çœ¼å…‰å’Œè¯„ä»·',
        'æ€»è§‰å¾—åˆ«äººåœ¨å®¡è§†å’Œæ‰¹è¯„è‡ªå·±',
        'äº‹ååå¤å›æƒ³"ä»–ä»¬æ€ä¹ˆçœ‹æˆ‘"',
        'ä¸ºäº†é¿å…è¢«è´Ÿé¢è¯„ä»·è€Œå›é¿ç¤¾äº¤'
      ],
      rootCauses: [
        { title: 'ä½è‡ªæˆ‘ä»·å€¼æ„Ÿ', desc: 'å†…å¿ƒæ·±å¤„ä¸ç›¸ä¿¡è‡ªå·±æ˜¯å€¼å¾—è¢«å–œæ¬¢çš„' },
        { title: 'è¿‡å¾€åˆ›ä¼¤ç»å†', desc: 'æ›¾ç»è¢«å˜²ç¬‘ã€æ‰¹è¯„æˆ–æ’æ–¥çš„ç—›è‹¦è®°å¿†' },
        { title: 'å®Œç¾ä¸»ä¹‰å€¾å‘', desc: 'å¯¹è‡ªå·±è¦æ±‚è¿‡é«˜ï¼Œæ— æ³•æ¥å—ä¸å®Œç¾çš„è¡¨ç°' }
      ],
      positiveReframe: 'ä½ å¯¹ä»–äººæƒ…ç»ªçš„æ•æ„Ÿåº¦å¾ˆé«˜ï¼Œè¿™æ„å‘³ç€ä½ æœ‰å¾ˆå¼ºçš„å…±æƒ…èƒ½åŠ›ã€‚å­¦ä¼šæ¥çº³"ä¸å®Œç¾"çš„è‡ªå·±ï¼Œä½ ä¼šå‘ç°å¤§å¤šæ•°äººå…¶å®æ²¡é‚£ä¹ˆåœ¨æ„ä½ çš„è¡¨ç°ã€‚'
    }
  }

  // åŠŸèƒ½æŸå®³å‹ï¼ˆæ–°å¢ï¼‰ï¼šç¤¾æå·²ä¸¥é‡å½±å“ç”Ÿæ´»
  // æ ¹æ®èŒä¸šå’Œç¤¾äº¤é¢‘ç‡è°ƒæ•´é˜ˆå€¼
  const occupation = basicInfo.occupation || 'other'
  const socialFreq = basicInfo.social_frequency || 'regular'
  
  let impairmentThreshold = 16
  let avoidanceThreshold = 15
  
  // å­¦ç”Ÿå’ŒèŒåœºäººå¯¹åŠŸèƒ½æŸå®³çš„æ„Ÿå—ä¸åŒ
  if (occupation === 'student') {
    impairmentThreshold = 15  // å­¦ç”Ÿæ›´æ•æ„Ÿ
  } else if (occupation === 'employee' || occupation === 'entrepreneur') {
    impairmentThreshold = 17  // èŒåœºäººå¯èƒ½éœ€è¦æ›´é«˜é˜ˆå€¼
  }
  
  // ç¤¾äº¤é¢‘ç‡è¶Šä½ï¼Œè¯´æ˜å›é¿è¶Šä¸¥é‡
  if (socialFreq === 'rarely') {
    avoidanceThreshold = 14  // å‡ ä¹ä¸å‚åŠ ï¼Œé˜ˆå€¼é™ä½
  }
  
  if (dimensions.functional_impairment >= impairmentThreshold && dimensions.avoidance >= avoidanceThreshold) {
    return {
      id: 'functional_impairment',
      name: 'ç¤¾äº¤å›°éš¾æˆ·',
      englishName: 'Social Struggle Survivor',
      features: [
        'å› ç¤¾äº¤ç„¦è™‘é”™è¿‡äº†å¾ˆå¤šé‡è¦æœºä¼š',
        'å·¥ä½œ/å­¦ä¹ å—åˆ°æ˜æ˜¾å½±å“',
        'äººé™…å…³ç³»è´¨é‡ä¸¥é‡ä¸‹é™',
        'ç”Ÿæ´»è´¨é‡æ˜æ˜¾é™ä½'
      ],
      rootCauses: [
        { title: 'é•¿æœŸå›é¿çš„æ¶æ€§å¾ªç¯', desc: 'è¶Šå›é¿è¶Šç„¦è™‘ï¼Œè¶Šç„¦è™‘è¶Šå›é¿' },
        { title: 'ç¤¾äº¤æŠ€èƒ½ä¸¥é‡æ¬ ç¼º', desc: 'ç¼ºä¹è¶³å¤Ÿçš„ç¤¾äº¤ç»ƒä¹ å’Œç»éªŒ' },
        { title: 'è‡ªæˆ‘éš”ç¦»çš„é˜²å¾¡æœºåˆ¶', desc: 'ç”¨å›é¿æ¥ä¿æŠ¤è‡ªå·±å…å—ä¼¤å®³' }
      ],
      positiveReframe: 'æ„è¯†åˆ°é—®é¢˜æœ¬èº«å°±æ˜¯æ”¹å˜çš„ç¬¬ä¸€æ­¥ã€‚ä»æœ€å°çš„ç¤¾äº¤å¼€å§‹ï¼Œé€æ­¥é‡å»ºä¿¡å¿ƒã€‚ä¸“ä¸šå¸®åŠ©ï¼ˆå¿ƒç†å’¨è¯¢ï¼‰ä¼šè®©è¿™ä¸ªè¿‡ç¨‹æ›´é¡ºåˆ©ã€‚'
    }
  }
  
  // é¢„æ¼”å‹ï¼šé¢„æœŸç„¦è™‘é«˜ + ç¤¾äº¤ååˆé«˜
  if (dimensions.anticipation >= 16 && dimensions.rumination >= 14) {
    return {
      id: 'rehearsal',
      name: 'è„‘å†…å½©æ’ä¸€ç™¾éæ˜Ÿäºº',
      englishName: 'Anticipatory Catastrophizer',
      features: [
        'äº‹å‰è¿‡åº¦æ‹…å¿ƒï¼Œè„‘è¡¥å„ç§ç³Ÿç³•åœºæ™¯',
        'åå¤é¢„æ¼”å¯¹è¯ï¼Œå‡†å¤‡"å®Œç¾"è¡¨ç°',
        'å®é™…ç¤¾äº¤æ—¶åè€Œè¿˜å¥½',
        'äº‹ååˆå¼€å§‹ååˆå’Œæ‡Šæ‚”'
      ],
      rootCauses: [
        { title: 'å®Œç¾ä¸»ä¹‰å€¾å‘', desc: 'å®³æ€•åœ¨ä»–äººé¢å‰å±•ç°"ä¸å®Œç¾"çš„è‡ªå·±' },
        { title: 'ä½è‡ªæˆ‘æ¥çº³', desc: 'å¯¹è‡ªå·±è¦æ±‚è¿‡é«˜ï¼Œå®¹é”™ç‡å¤ªä½' },
        { title: 'è¿‡åº¦å…³æ³¨ä»–äººè¯„ä»·', desc: '"ä»–ä»¬ä¼šæ€ä¹ˆçœ‹æˆ‘"æˆä¸ºæœ€å¤§å‹åŠ›æº' }
      ],
      positiveReframe: 'é¢„æ¼”å‹ç¤¾æè€…å¾€å¾€å…±æƒ…èƒ½åŠ›å¼ºã€å–„äºè§‚å¯Ÿç»†èŠ‚ã€å†…å¿ƒç»†è…»æ•æ„Ÿã€‚è¿™ä¸æ˜¯ç¼ºé™·ï¼Œè€Œæ˜¯ç‰¹è´¨ã€‚å…³é”®æ˜¯å­¦ä¼šæ¥çº³"ä¸å®Œç¾"çš„ç¤¾äº¤ï¼Œè€Œéè¿½æ±‚"å®Œç¾"è¡¨ç°ã€‚'
    }
  }

  // å›é¿å‹ï¼šå›é¿è¡Œä¸ºé«˜ + ç¤¾äº¤åœºæ™¯ææƒ§é«˜
  if (dimensions.avoidance >= 15 && dimensions.scene_fear >= 18) {
    return {
      id: 'avoidant',
      name: 'ç¤¾äº¤éšèº«æœ¯ä¿®ç‚¼è€…',
      englishName: 'Social Invisibility Practitioner',
      features: [
        'ä¸»åŠ¨é¿å…ç¤¾äº¤åœºåˆ',
        'èƒ½ä¸å‚åŠ å°±ä¸å‚åŠ ',
        'å¯¹ç¤¾äº¤æœ‰å¼ºçƒˆçš„ææƒ§æ„Ÿ',
        'æ›´å€¾å‘ç‹¬å¤„å’Œå®‰å…¨ç¯å¢ƒ'
      ],
      rootCauses: [
        { title: 'ææƒ§è¢«æ‹’ç»', desc: 'å®³æ€•è¢«ä»–äººå¦å®šå’Œæ’æ–¥' },
        { title: 'ä½è‡ªæˆ‘ä»·å€¼æ„Ÿ', desc: 'ä¸ç›¸ä¿¡è‡ªå·±å€¼å¾—è¢«å–œæ¬¢' },
        { title: 'è¿‡å¾€è´Ÿé¢ç»å†', desc: 'æ›¾ç»çš„ç¤¾äº¤åˆ›ä¼¤å½¢æˆé˜²å¾¡æœºåˆ¶' }
      ],
      positiveReframe: 'å›é¿å‹ç¤¾æè€…å¾€å¾€æ›´åŠ ç‹¬ç«‹ã€å–„äºè‡ªæˆ‘ç›¸å¤„ã€‚å­¦ä¼šåœ¨ç‹¬å¤„å’Œç¤¾äº¤ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ï¼Œé€æ­¥æ‰©å±•èˆ’é€‚åŒºï¼Œè€Œéå®Œå…¨å›é¿ã€‚'
    }
  }

  // è¡¨æ¼”å‹ï¼šç”Ÿç†ååº”é«˜ + è´Ÿé¢è¯„ä»·ææƒ§é«˜
  if (dimensions.physical >= 12 && dimensions.fear_of_negative_evaluation >= 18) {
    return {
      id: 'performance',
      name: 'åˆ«äººçœ¼å…‰æ”¾å¤§é•œæ˜Ÿäºº',
      englishName: 'Spotlight Effect Amplifier',
      features: [
        'åœ¨éœ€è¦è¡¨ç°çš„åœºåˆç‰¹åˆ«ç´§å¼ ',
        'èº«ä½“ååº”å¼ºçƒˆï¼ˆå¿ƒè·³ã€å‡ºæ±—ç­‰ï¼‰',
        'æ‹…å¿ƒåˆ«äººæ³¨æ„åˆ°è‡ªå·±çš„ç´§å¼ ',
        'å®³æ€•åœ¨ä¼—äººé¢å‰å‡ºä¸‘'
      ],
      rootCauses: [
        { title: 'å®³æ€•è¢«è¯„åˆ¤', desc: 'è¿‡åº¦åœ¨æ„ä»–äººçš„çœ¼å…‰å’Œè¯„ä»·' },
        { title: 'ç¼ºä¹è‡ªä¿¡', desc: 'ä¸ç›¸ä¿¡è‡ªå·±èƒ½åšå¥½' },
        { title: 'èº«å¿ƒè¿æ¥æ•æ„Ÿ', desc: 'æƒ…ç»ªå®¹æ˜“å¼•å‘æ˜æ˜¾çš„ç”Ÿç†ååº”' }
      ],
      positiveReframe: 'è¡¨æ¼”å‹ç¤¾æè€…å¾€å¾€å¯¹è‡ªå·±è¦æ±‚è¾ƒé«˜ã€è¿½æ±‚å“è¶Šã€‚å­¦ä¼šæ¥çº³ä¸å®Œç¾çš„è¡¨ç°ï¼Œç†è§£ç´§å¼ æ˜¯æ­£å¸¸ååº”ï¼Œè€Œéå¤±è´¥çš„ä¿¡å·ã€‚'
    }
  }

  // é»˜è®¤ï¼šç»¼åˆå‹æˆ–è½»åº¦ç¤¾æ
  return {
    id: 'general',
    name: 'ç¤¾äº¤å°çº ç»“ä½“è´¨',
    englishName: 'General Social Anxiety',
    features: [
      'åœ¨å¤šç§ç¤¾äº¤æƒ…å¢ƒä¸­éƒ½ä¼šæ„Ÿåˆ°ä¸é€‚',
      'ç„¦è™‘ç¨‹åº¦å› åœºåˆè€Œå¼‚',
      'æ—¢æœ‰é¢„æœŸç„¦è™‘ä¹Ÿæœ‰å›é¿è¡Œä¸º',
      'å„æ–¹é¢éƒ½æœ‰è½»åº¦åˆ°ä¸­åº¦çš„è¡¨ç°'
    ],
    rootCauses: [
      { title: 'å¤šå› ç´ ç»¼åˆ', desc: 'æ€§æ ¼ã€æˆé•¿ç¯å¢ƒã€ç»å†ç­‰å¤šæ–¹é¢å½±å“' },
      { title: 'é€‚åº”æ€§ç„¦è™‘', desc: 'å¯¹ä¸ç¡®å®šç¤¾äº¤æƒ…å¢ƒçš„è‡ªç„¶ååº”' },
      { title: 'ç¤¾äº¤æŠ€èƒ½æ¬ ç¼º', desc: 'ç¼ºä¹è¶³å¤Ÿçš„ç¤¾äº¤ç»éªŒå’ŒæŠ€å·§' }
    ],
    positiveReframe: 'ç»¼åˆå‹ç¤¾ææ„å‘³ç€æ²¡æœ‰ç‰¹åˆ«çªå‡ºçš„é—®é¢˜ç‚¹ï¼Œè¿™åè€Œæ›´å®¹æ˜“å…¨é¢æ”¹å–„ã€‚é€šè¿‡ç³»ç»Ÿæ€§çš„ç»ƒä¹ å’Œè®¤çŸ¥è°ƒæ•´ï¼Œå¯ä»¥è·å¾—æ˜¾è‘—è¿›æ­¥ã€‚'
  }
}

// ==================== è·å–ç»´åº¦çº§åˆ« ====================
export function getDimensionLevel(score, maxScore = 25) {
  const percentage = (score / maxScore) * 100
  if (percentage <= 40) return { level: 'è¿˜å¥½å•¦', icon: 'âœ“' }
  if (percentage <= 60) return { level: 'æœ‰ç‚¹å°ç´§å¼ ', icon: '' }
  if (percentage <= 80) return { level: 'éœ€è¦å…³æ³¨', icon: '' }
  return { level: 'é‡ç‚¹æ”¹å–„åŒº', icon: 'âš ' }
}

// ==================== è·å–ç»´åº¦è§£è¯» ====================
export function getDimensionInterpretation(dimension, score, maxScore) {
  const interpretations = {
    scene_fear: {
      low: 'ä½ åœ¨å¤§å¤šæ•°ç¤¾äº¤åœºåˆéƒ½èƒ½ä¿æŒç›¸å¯¹è‡ªç„¶',
      medium: 'åœ¨æŸäº›ç¤¾äº¤åœºåˆä¼šæ„Ÿåˆ°ç´§å¼ ',
      high: 'åœ¨å¤šäººèšä¼šã€å…¬å¼€åœºåˆå®¹æ˜“æ„Ÿåˆ°ç´§å¼ ',
      veryHigh: 'å¯¹å¤§éƒ¨åˆ†ç¤¾äº¤åœºæ™¯éƒ½æœ‰æ˜æ˜¾çš„ææƒ§æ„Ÿ'
    },
    avoidance: {
      low: 'ä½ å¾ˆå°‘å› ä¸ºç„¦è™‘è€Œå›é¿ç¤¾äº¤',
      medium: 'ä¼šé€‰æ‹©æ€§å‚åŠ ç¤¾äº¤æ´»åŠ¨',
      high: 'ç»å¸¸æ‰¾ç†ç”±é¿å…å‚åŠ ç¤¾äº¤æ´»åŠ¨',
      veryHigh: 'ä¼šä¸»åŠ¨é¿å…å‡ ä¹æ‰€æœ‰ç¤¾äº¤åœºåˆ'
    },
    anticipation: {
      low: 'å¯¹å³å°†åˆ°æ¥çš„ç¤¾äº¤ä¸ä¼šè¿‡åº¦æ‹…å¿ƒ',
      medium: 'ä¼šæå‰æœ‰ä¸€äº›æ‹…å¿ƒå’Œå‡†å¤‡',
      high: 'äº‹å‰è¿‡åº¦æ‹…å¿ƒæ˜¯ä½ çš„ç—›ç‚¹',
      veryHigh: 'ä¼šé•¿æ—¶é—´æå‰ç„¦è™‘ï¼Œä¸¥é‡å½±å“å¿ƒæƒ…'
    },
    fear_of_negative_evaluation: {
      low: 'ä¸å¤ªåœ¨æ„åˆ«äººçš„è¯„ä»·',
      medium: 'æœ‰æ—¶ä¼šæ‹…å¿ƒåˆ«äººçš„çœ‹æ³•',
      high: 'éå¸¸åœ¨æ„åˆ«äººæ€ä¹ˆçœ‹è‡ªå·±',
      veryHigh: 'æåº¦å®³æ€•è¢«è´Ÿé¢è¯„ä»·ï¼Œè¿™æ˜¯æœ€å¤§çš„ææƒ§æº'
    },
    rumination: {
      low: 'ç¤¾äº¤åä¸ä¼šè¿‡åº¦åæ€',
      medium: 'æœ‰æ—¶ä¼šå›æƒ³ç¤¾äº¤ä¸­çš„ç»†èŠ‚',
      high: 'äº‹åç»å¸¸åæ‚”è¯´é”™è¯',
      veryHigh: 'ä¼šé•¿æ—¶é—´åå¤å›æƒ³å’Œæ‡Šæ‚”'
    },
    physical: {
      low: 'èº«ä½“ååº”ä¸ç®—ä¸¥é‡',
      medium: 'æœ‰ä¸€å®šçš„ç”Ÿç†ååº”',
      high: 'ä¼šå‡ºç°æ˜æ˜¾çš„ç”Ÿç†ååº”',
      veryHigh: 'ç”Ÿç†ååº”å¼ºçƒˆï¼Œå½±å“æ­£å¸¸è¡¨ç°'
    },
    functional_impairment: {
      low: 'ç¤¾äº¤ç„¦è™‘å¯¹ç”Ÿæ´»å½±å“å¾ˆå°',
      medium: 'æœ‰ä¸€äº›å½±å“ï¼Œä½†è¿˜èƒ½åº”å¯¹',
      high: 'æ˜æ˜¾å½±å“å·¥ä½œã€å­¦ä¹ æˆ–äººé™…å…³ç³»',
      veryHigh: 'ä¸¥é‡å½±å“ç”Ÿæ´»è´¨é‡ï¼Œé”™è¿‡å¾ˆå¤šæœºä¼š'
    },
    self_efficacy: {
      low: 'ä¸å¤ªç›¸ä¿¡è‡ªå·±èƒ½å¤„ç†å¥½ç¤¾äº¤æƒ…å¢ƒ',
      medium: 'å¯¹è‡ªå·±çš„ç¤¾äº¤èƒ½åŠ›ä¿¡å¿ƒä¸€èˆ¬',
      high: 'åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ç›¸ä¿¡è‡ªå·±',
      veryHigh: 'å¯¹è‡ªå·±çš„ç¤¾äº¤èƒ½åŠ›å¾ˆæœ‰ä¿¡å¿ƒ'
    }
  }
  
  const percentage = (score / maxScore) * 100
  let level = 'medium'
  
  if (percentage <= 40) level = 'low'
  else if (percentage <= 60) level = 'medium'
  else if (percentage <= 80) level = 'high'
  else level = 'veryHigh'
  
  return interpretations[dimension]?.[level] || ''
}

// ==================== ç”Ÿæˆå®Œæ•´æŠ¥å‘Š ====================
export async function generateReport(answers, basicInfo = {}) {
  // å…ˆæ£€æŸ¥æ•ˆåº¦
  const validity = checkValidity(answers)
  
  if (!validity.isValid) {
    return {
      isValid: false,
      warnings: validity.warnings,
      message: 'æ£€æµ‹åˆ°ä½œç­”è´¨é‡é—®é¢˜ï¼Œå»ºè®®é‡æ–°è®¤çœŸä½œç­”ã€‚è¿™ä¸ä¼šå½±å“ä½ çš„ä»»ä½•è®°å½•ï¼Œè¯·æ”¾å¿ƒé‡æ–°æµ‹è¯„ã€‚'
    }
  }
  
  // è®¡ç®—åˆ†æ•°
  const scores = calculateScores(answers)
  
  // ä½¿ç”¨åŸºç¡€ä¿¡æ¯è¿›è¡Œä¸ªæ€§åŒ–ç±»å‹åˆ¤æ–­ï¼ˆé»˜è®¤è§„åˆ™ï¼‰
  let type = getType(scores.dimensions, basicInfo)
  
  // ç»´åº¦é…ç½®ï¼ˆåŒ…å«æœ€é«˜åˆ†ï¼‰- åªæ˜¾ç¤º6å¤§æ ¸å¿ƒç»´åº¦
  const dimensionConfig = {
    scene_fear: { name: 'ç¤¾äº¤åœºæ™¯ææƒ§', maxScore: 25, icon: 'ğŸ˜°' },
    avoidance: { name: 'å›é¿è¡Œä¸ºç¨‹åº¦', maxScore: 20, icon: 'ğŸšª' },
    anticipation: { name: 'é¢„æœŸç„¦è™‘å¼ºåº¦', maxScore: 20, icon: 'â°' },
    fear_of_negative_evaluation: { name: 'åˆ«äººçœ¼å…‰åœ¨æ„åº¦', maxScore: 25, icon: 'ğŸ‘€' },
    rumination: { name: 'ç¤¾äº¤åååˆ', maxScore: 20, icon: 'ğŸ”„' },
    functional_impairment: { name: 'åŠŸèƒ½æŸå®³ç¨‹åº¦', maxScore: 20, icon: 'ğŸ“‰' }
  }
  
  // åªå¤„ç†6å¤§æ ¸å¿ƒç»´åº¦ï¼ˆæ’é™¤physicalå’Œself_efficacyï¼‰
  const coreDimensionKeys = Object.keys(dimensionConfig)
  const dimensions = coreDimensionKeys.map(key => {
    const score = scores.dimensions[key] || 0
    const config = dimensionConfig[key]
    return {
      key,
      name: config.name,
      score,
      maxScore: config.maxScore,
      percentage: Math.round((score / config.maxScore) * 100),
      level: getDimensionLevel(score, config.maxScore),
      interpretation: getDimensionInterpretation(key, score, config.maxScore),
      icon: config.icon
    }
  })
  
  // å°†æ€»åˆ†è½¬æ¢ä¸º100åˆ†åˆ¶ï¼ˆåŸå§‹åˆ†/165*100ï¼‰
  const totalScore100 = Math.round((scores.total / 165) * 100)
  
  // ä½¿ç”¨100åˆ†åˆ¶è¿›è¡Œç­‰çº§åˆ¤æ–­
  const level100 = getLevel(totalScore100, basicInfo)
  
  // æ„å»ºåŸºç¡€æŠ¥å‘Š
  const baseReport = {
    isValid: true,
    testDate: new Date().toISOString(),
    basicInfo, // åŒ…å«ç”¨æˆ·çš„åŸºç¡€ä¿¡æ¯ï¼ˆç”¨äºç®—æ³•ï¼Œä¸åœ¨å‰ç«¯æ˜¾ç¤ºï¼‰
    totalScore: totalScore100,
    maxScore: 100, // 100åˆ†åˆ¶
    level: level100,
    type,
    dimensions,
    suggestions: null // å…ˆè®¾ä¸ºnullï¼Œåé¢å¡«å……
  }
  
  // ğŸ¯ å°è¯•ä½¿ç”¨æ·±åº¦åˆ†æå¼•æ“ï¼Œå¤±è´¥åˆ™ä½¿ç”¨æœ¬åœ°è§„åˆ™
  try {
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
    console.log('ğŸ¯ [æŠ¥å‘Šç”Ÿæˆ] å¼€å§‹æ·±åº¦ä¸ªæ€§åŒ–åˆ†æ')
    console.log(`ğŸ“Š [æŠ¥å‘Šç”Ÿæˆ] æ€»åˆ†: ${totalScore100}/100`)
    console.log(`ğŸ“ˆ [æŠ¥å‘Šç”Ÿæˆ] ç­‰çº§: ${level100.name}`)
    console.log(`ğŸ·ï¸  [æŠ¥å‘Šç”Ÿæˆ] åˆæ­¥ç±»å‹: ${type.name}`)
    console.log(`ğŸ‘¤ [æŠ¥å‘Šç”Ÿæˆ] ç”¨æˆ·ä¿¡æ¯: å¹´é¾„=${basicInfo.age}, æ€§åˆ«=${basicInfo.gender}, èŒä¸š=${basicInfo.occupation}`)
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
    
    const personalizedType = await generatePersonalizedAnalysis(baseReport, answers, basicInfo)
    
    if (personalizedType) {
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
      console.log('âœ… [æŠ¥å‘Šç”Ÿæˆ] AIæ·±åº¦åˆ†ææˆåŠŸï¼')
      console.log(`ğŸ“ [æŠ¥å‘Šç”Ÿæˆ] ç”Ÿæˆç±»å‹: ${personalizedType.name}`)
      console.log(`ğŸŒ [æŠ¥å‘Šç”Ÿæˆ] è‹±æ–‡åç§°: ${personalizedType.englishName}`)
      console.log(`âœ¨ [æŠ¥å‘Šç”Ÿæˆ] ç‰¹å¾æ•°é‡: ${personalizedType.features.length}`)
      console.log(`ğŸ” [æŠ¥å‘Šç”Ÿæˆ] æ ¹æºæ•°é‡: ${personalizedType.rootCauses.length}`)
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
      type = personalizedType
      baseReport.type = personalizedType
      baseReport.aiGenerated = true // å†…éƒ¨æ ‡è®°ï¼Œç”¨æˆ·çœ‹ä¸åˆ°
    } else {
      // æ·±åº¦åˆ†æå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å¢å¼ºè§„åˆ™
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
      console.log('âš ï¸ [æŠ¥å‘Šç”Ÿæˆ] AIåˆ†ææœªæˆåŠŸï¼Œä½¿ç”¨å¤‡ç”¨åˆ†æå¼•æ“')
      console.log('ğŸ”„ [æŠ¥å‘Šç”Ÿæˆ] æ­£åœ¨ç”Ÿæˆæœ¬åœ°å¢å¼ºåˆ†æ...')
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
      const enhancedType = generateEnhancedAnalysis(baseReport, answers, basicInfo)
      console.log('âœ… [æŠ¥å‘Šç”Ÿæˆ] æœ¬åœ°å¢å¼ºåˆ†æå®Œæˆ')
      console.log(`ğŸ“ [æŠ¥å‘Šç”Ÿæˆ] ç”Ÿæˆç±»å‹: ${enhancedType.name}`)
      type = enhancedType
      baseReport.type = enhancedType
      baseReport.aiGenerated = false
    }
  } catch (error) {
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
    console.error('âŒ [æŠ¥å‘Šç”Ÿæˆ] æ·±åº¦åˆ†æå¼‚å¸¸:', error)
    console.error(`ğŸ“„ [æŠ¥å‘Šç”Ÿæˆ] é”™è¯¯ç±»å‹: ${error.name}`)
    console.error(`ğŸ“„ [æŠ¥å‘Šç”Ÿæˆ] é”™è¯¯ä¿¡æ¯: ${error.message}`)
    console.log('ğŸ”„ [æŠ¥å‘Šç”Ÿæˆ] ä½¿ç”¨æœ¬åœ°å¢å¼ºè§„åˆ™ä½œä¸ºé™çº§æ–¹æ¡ˆ')
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')
    // ä½¿ç”¨æœ¬åœ°å¢å¼ºè§„åˆ™ä½œä¸ºé™çº§æ–¹æ¡ˆ
    const enhancedType = generateEnhancedAnalysis(baseReport, answers, basicInfo)
    console.log(`âœ… [æŠ¥å‘Šç”Ÿæˆ] æœ¬åœ°å¢å¼ºåˆ†æå®Œæˆ: ${enhancedType.name}`)
    type = enhancedType
    baseReport.type = enhancedType
    baseReport.aiGenerated = false
  }
  
  // ç”Ÿæˆæ”¹å–„å»ºè®®
  baseReport.suggestions = getSuggestions(type, scores, basicInfo)
  
  return baseReport
}

// ==================== è·å–æ”¹å–„å»ºè®® ====================
function getSuggestions(type, scores, basicInfo) {
  const suggestions = {
    immediate: [],
    weekly: {},
    longTerm: {
      books: [
        { title: 'ã€Šç¤¾äº¤ç„¦è™‘è‡ªåŠ©æ‰‹å†Œã€‹', author: 'å‰è‰æ©Â·å·´ç‰¹å‹’' },
        { title: 'ã€Šè¢«è®¨åŒçš„å‹‡æ°”ã€‹', author: 'å²¸è§ä¸€éƒ' },
        { title: 'ã€Šè›¤èŸ†å…ˆç”Ÿå»çœ‹å¿ƒç†åŒ»ç”Ÿã€‹', author: 'ç½—ä¼¯ç‰¹Â·æˆ´åšå¾·' }
      ],
      practices: [
        'æ¯å¤©å†¥æƒ³10åˆ†é’Ÿï¼ˆå¸®ä½ å¹³é™ä¸‹æ¥ï¼‰',
        'è®°å½•è‡ªå·±çš„æƒ³æ³•å’Œæ„Ÿå—ï¼ˆçœ‹æ¸…æ¥šè‡ªå·±åœ¨æƒ³ä»€ä¹ˆï¼‰',
        'ä¸€ç‚¹ç‚¹å°è¯•å®³æ€•çš„åœºæ™¯ï¼ˆæ…¢æ…¢å°±ä¸é‚£ä¹ˆæ€•äº†ï¼‰'
      ],
      note: 'æ”¹å–„éœ€è¦æ—¶é—´ï¼Œä¸€èˆ¬è¦åšæŒ3-6ä¸ªæœˆã€‚åˆ«ç€æ€¥ï¼Œæ¯ä¸€å°æ­¥éƒ½ç®—è¿›æ­¥ã€‚'
    },
    warning: {
      title: 'ä»€ä¹ˆæ—¶å€™è¯¥æ‰¾ä¸“ä¸šäººå£«èŠèŠï¼Ÿ',
      conditions: [
        'å·²ç»ä¸¥é‡å½±å“å·¥ä½œæˆ–å­¦ä¹ äº†',
        'å‡ ä¹ä¸æ•¢å‡ºé—¨è§äººäº†',
        'åŒæ—¶è¿˜æ„Ÿåˆ°å¾ˆæŠ‘éƒï¼Œæˆ–è€…ä¼šçªç„¶å¿ƒæ…Œå¾—å‰å®³',
        'è¿™ç§çŠ¶æ€æŒç»­åŠå¹´ä»¥ä¸Šï¼Œæ²¡æœ‰å¥½è½¬'
      ],
      advice: 'æ‰¾ä¸ªä¸“ä¸šçš„å¿ƒç†å’¨è¯¢å¸ˆæˆ–åŒ»ç”ŸèŠèŠï¼ŒçœŸçš„ä¼šæœ‰å¸®åŠ©ã€‚å…¨å›½å¿ƒç†æ´åŠ©çƒ­çº¿ï¼š12355'
    }
  }

  // ===== åŸºäºç”¨æˆ·ä¿¡æ¯ç”Ÿæˆç¨³å®šéšæœºç§å­ï¼Œä¿è¯å¤šæ ·ä½†åŒä¸€ç”¨æˆ·ä¸€è‡´ =====
  const seedBase = JSON.stringify({
    age: basicInfo.age || 'na',
    gender: basicInfo.gender || 'na',
    occupation: basicInfo.occupation || 'na',
    social_frequency: basicInfo.social_frequency || 'na',
    type: type?.id || 'general'
  })
  const rng = buildSeededRng(hashString(seedBase))

  // ===== è®¡ç®—ä¸¥é‡åº¦å¸¦ï¼Œå†³å®šä»»åŠ¡å‰‚é‡ä¸å¼ºåº¦ =====
  const total100 = Math.round((scores.total / 165) * 100)
  const severity = total100 <= 30 ? 'normal' : total100 <= 50 ? 'mild' : total100 <= 70 ? 'moderate' : total100 <= 90 ? 'severe' : 'very_severe'

  // ===== è¯†åˆ«é«˜é£é™©ç»´åº¦ä¸ä¿æŠ¤æ€§å› å­ =====
  const dim = scores.dimensions || {}
  const highDims = Object.entries(dim)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 3)
    .map(([k]) => k)
  const protective = []
  if ((dim.self_efficacy || 0) >= 14) protective.push('self_efficacy')
  if ((dim.scene_fear || 0) <= 10) protective.push('low_scene_fear')

  // ===== ç«‹å³å»ºè®®æ± ï¼ˆæŒ‰ç»´åº¦/ç±»å‹ç»„è£…ï¼Œå†å»é‡æŠ½æ ·ï¼‰ =====
  const pool = []

  const pushItem = (item) => {
    if (!pool.find(i => i.title === item.title)) pool.push(item)
  }

  // é€šç”¨CBT/è¡Œä¸ºç­–ç•¥æ¨¡æ¿
  const genericTemplates = [
    {
      title: 'SMARTç›®æ ‡ï¼šæœ¬å‘¨æœ€å°å¯è¡Œç¤¾äº¤',
      content: 'å…·ä½“(S)ï¼šå‘1ä½åŒäº‹/åŒå­¦ä¸»åŠ¨å‘èµ·2åˆ†é’Ÿå¯¹è¯ï¼›å¯è¡¡é‡(M)ï¼š1æ¬¡ï¼›å¯è¾¾æˆ(A)ï¼šæå‰å‡†å¤‡è¯é¢˜ï¼›ç›¸å…³(R)ï¼šä¸ç¤¾äº¤è‡ªä¿¡æå‡ç›¸å…³ï¼›æœ‰æ—¶é™(T)ï¼š72å°æ—¶å†…å®Œæˆã€‚',
      metric: 'å®Œæˆæ¬¡æ•°â‰¥1ï¼›ä¸»è§‚ç„¦è™‘(SUDs)ä»é¢„æœŸåˆ°å®é™…ä¸‹é™â‰¥2åˆ†'
    },
    {
      title: 'æƒ…ç»ª-æƒ³æ³•-è¡Œä¸ºè®°å½•ï¼ˆTFBï¼‰',
      content: 'ä¸€æ¬¡ç¤¾äº¤åï¼Œè®°å½•æƒ…å¢ƒã€è‡ªåŠ¨åŒ–æƒ³æ³•ã€æƒ…ç»ªå¼ºåº¦(0-10)ã€è¯æ®æ”¯æŒ/åé©³ã€æ›¿ä»£æ€§æƒ³æ³•ã€åç»­è¡Œä¸ºã€‚æ¯æ¬¡â‰¤5åˆ†é’Ÿã€‚',
      metric: 'æ¯å‘¨â‰¥3æ¡è®°å½•'
    },
    {
      title: 'å®‰å…¨è¡Œä¸ºæ£€æŸ¥è¡¨',
      content: 'è¯†åˆ«å¹¶å‡å°‘å®‰å…¨è¡Œä¸ºï¼šé¿å…çœ¼ç¥ã€åå¤æ¶¦è‰²æ¶ˆæ¯ã€å¼ºè¿«å‡†å¤‡ç­‰ã€‚æ¯æ¬¡ç¤¾äº¤å‰å‹¾é€‰1é¡¹å‡å°‘ã€‚',
      metric: 'æ¯å‘¨è‡³å°‘å‡å°‘1ä¸ªå®‰å…¨è¡Œä¸ºï¼Œä¿æŒ2æ¬¡'
    }
  ]

  // ç»´åº¦å®šåˆ¶æ¨¡æ¿
  const byDimension = {
    anticipation: [
      { title: 'æ‹…å¿§æ—¶é™æ³•', content: 'ä¸ºâ€œé¢„æœŸç„¦è™‘â€è®¾å®š5åˆ†é’Ÿæ‹…å¿§çª—å£ï¼Œåˆ°ç‚¹åœæ­¢å¹¶è¡ŒåŠ¨ã€‚é…åˆ5-4-3-2-1åœ°é¢åŒ–ã€‚', metric: 'é¢„æœŸSUDsè¾ƒä¸Šå‘¨ä¸‹é™â‰¥2' }
    ],
    rumination: [
      { title: 'åååˆè®¡æ—¶å™¨', content: 'ç¤¾äº¤åè®¾ç½®10åˆ†é’Ÿâ€œå…è®¸åæ€â€è®¡æ—¶ï¼Œç»“æŸåå†™ä¸‹3ä»¶å®Œæˆçš„è¿˜ä¸é”™çš„ç»†èŠ‚ï¼Œç»ˆæ­¢ç»§ç»­ååˆã€‚', metric: 'ååˆæ—¶é•¿â‰¤10åˆ†é’Ÿ/æ¬¡' }
    ],
    avoidance: [
      { title: 'æ¸è¿›å¼æš´éœ²æ¸…å•', content: 'æ„å»º10çº§éš¾åº¦é˜¶æ¢¯ï¼Œä»1åˆ†å°ä»»åŠ¡å¼€å§‹ï¼ˆè§ä¸‹æ–¹æš´éœ²é˜¶æ¢¯ï¼‰ã€‚æ¯ä¸ªç­‰çº§å®Œæˆ3-5æ¬¡åå‡çº§ã€‚', metric: 'æœ¬å‘¨å®Œæˆâ‰¥2ä¸ª1-3çº§ä»»åŠ¡' }
    ],
    scene_fear: [
      { title: 'åœºæ™¯è„±æ•æ¼”ç»ƒ', content: 'ä½¿ç”¨æ„è±¡æš´éœ²ï¼šé—­çœ¼å›æƒ³å…·ä½“ç¤¾äº¤åœºæ™¯ï¼Œé€æ­¥å»¶é•¿è‡³3-5åˆ†é’Ÿï¼Œå¹¶é…åˆç¼“æ…¢å‘¼å¸ã€‚', metric: 'æ„è±¡æš´éœ²å®Œæˆâ‰¥3æ¬¡/å‘¨' }
    ],
    physical: [
      { title: 'å‘¼å¸-è‚Œè‚‰æ”¾æ¾ç»„åˆ', content: '4-4-6å‘¼å¸Ã—3ç»„ + æ¸è¿›å¼è‚Œè‚‰æ”¾æ¾ï¼ˆæ‰‹è‡‚/è‚©é¢ˆ/ä¸‹é¢Œï¼‰ã€‚', metric: 'ç´§å¼ åœºåˆä½¿ç”¨â‰¥2æ¬¡' }
    ],
    fear_of_negative_evaluation: [
      { title: 'èšå…‰ç¯æ•ˆåº”çº å', content: 'æ”¶é›†â€œä»–äººæ³¨æ„æˆ‘â€ä¸â€œå®é™…è¢«æ³¨æ„â€çš„è¯æ®å¯¹ç…§ï¼Œæ¯æ¬¡è‡³å°‘å†™3æ¡åä¾‹ã€‚', metric: 'æ¯å‘¨â‰¥2æ¬¡è¯æ®æ—¥å¿—' }
    ],
    functional_impairment: [
      { title: 'åŠŸèƒ½ä¼˜å…ˆçº§ä¿®å¤', content: 'åˆ—å‡ºå—å½±å“çš„3ä¸ªåŠŸèƒ½é¢†åŸŸï¼ˆå­¦ä¸š/å·¥ä½œ/å…³ç³»ï¼‰ï¼Œå„é€‰æ‹©1ä¸ªæœ€ä½æˆæœ¬çš„ä¿®å¤è¡ŒåŠ¨ã€‚', metric: 'æœ¬å‘¨å®Œæˆâ‰¥2é¡¹' }
    ],
    self_efficacy: [
      { title: 'å¾®èƒœåˆ©æ¸…å•', content: 'æ¯å¤©è®°å½•1ä¸ªå®Œæˆçš„å¾®ç¤¾äº¤è¡ŒåŠ¨å’Œç§¯æåé¦ˆï¼Œç§¯ç´¯10æ¡ä»¥ä¸Šã€‚', metric: '7å¤©â‰¥5æ¡å¾®èƒœåˆ©' }
    ]
  }

  genericTemplates.forEach(t => pushItem(t))
  highDims.forEach(k => (byDimension[k] || []).forEach(t => pushItem(t)))

  // æŒ‰ä¸¥é‡åº¦æ‰©å±•å¼ºåº¦/èµ„æº
  if (severity === 'severe' || severity === 'very_severe') {
    pushItem({
      title: 'ä¼˜å…ˆè”ç³»ä¸“ä¸šæ”¯æŒ',
      content: 'å»ºè®®æ¯å‘¨1æ¬¡å¿ƒç†å’¨è¯¢ï¼ˆCBT/æš´éœ²ç–—æ³•ï¼‰ï¼Œæˆ–è‡³æ­£è§„åŒ»é™¢ç²¾ç¥å¿ƒç†ç§‘è¯„ä¼°ã€‚å¯å…ˆè¿›è¡Œç”µè¯æˆ–è§†é¢‘å’¨è¯¢ä»¥é™ä½è¿›å…¥æˆæœ¬ã€‚',
      metric: 'é¢„çº¦å®Œæˆ+é¦–æ¬¡ä¼šè°ˆå®Œæˆ'
    })
  }

  // ä»æ± ä¸­æŒ‰ç§å­éšæœºé€‰æ‹©4-6æ¡
  const pickCount = severity === 'mild' ? 4 : severity === 'moderate' ? 5 : 6
  const immediate = sampleDistinct(pool, pickCount, rng)

  // ===== æš´éœ²é˜¶æ¢¯ï¼ˆæ ¹æ®æœ€é«˜çš„ä¸¤ä¸ªç»´åº¦å®šåˆ¶ï¼‰ =====
  const topTwo = highDims.slice(0, 2)
  const ladder = buildExposureLadder(topTwo, rng)

  // ===== æ¯å‘¨è®¡åˆ’ï¼ˆå‰‚é‡éšä¸¥é‡åº¦è°ƒæ•´ï¼‰ =====
  const weekly = buildWeeklyPlan(basicInfo, severity)

  // ===== é•¿æœŸè·¯å¾„ï¼ˆé˜¶æ®µåŒ–ï¼šè®¤çŸ¥â†’æš´éœ²â†’æŠ€èƒ½â†’å…³ç³»â†’ç»´æŠ¤ï¼‰ =====
  const longTermPath = buildLongTermPath(severity, type, highDims)

  // ===== æŒ‡æ ‡ä¸è¿½è¸ªï¼ˆé‡åŒ–æ”¹å–„ï¼‰ =====
  const metrics = buildMetrics(severity, highDims)

  // ===== ä¼˜åŠ¿ä¸è§¦å‘å› ç´ ç”»åƒ =====
  const strengths = buildStrengths(protective, basicInfo)
  const triggers = buildTriggers(highDims)

  suggestions.immediate = immediate
  suggestions.weekly = weekly
  suggestions.exposureLadder = ladder
  suggestions.longTermPath = longTermPath
  suggestions.metrics = metrics
  suggestions.strengths = strengths
  suggestions.triggers = triggers
  
  // æ ¹æ®ç±»å‹æä¾›é’ˆå¯¹æ€§å»ºè®®
  if (type.id === 'fear_evaluation') {
    // è´Ÿé¢è¯„ä»·ææƒ§å‹
    suggestions.immediate = [
      {
        title: 'è®°ä½"èšå…‰ç¯æ•ˆåº”"',
        content: `å¿ƒç†å­¦ç ”ç©¶å‘ç°ï¼Œæˆ‘ä»¬æ€»æ˜¯é«˜ä¼°åˆ«äººå¯¹è‡ªå·±çš„å…³æ³¨åº¦ã€‚

å®éªŒè¯æ˜ï¼š
Â· ä½ è§‰å¾—100%çš„äººæ³¨æ„åˆ°ä½ çš„å°´å°¬
Â· å®é™…ä¸Šåªæœ‰ä¸åˆ°20%çš„äººæ³¨æ„åˆ°
Â· è€Œä¸”ä»–ä»¬å¾ˆå¿«å°±å¿˜äº†

ä¸‹æ¬¡æ‹…å¿ƒ"åˆ«äººæ€ä¹ˆçœ‹æˆ‘"æ—¶ï¼Œé—®è‡ªå·±ï¼š
"æˆ‘è¿˜è®°å¾—ä¸Šå‘¨æŸä¸ªé™Œç”Ÿäººçš„å°´å°¬ç¬é—´å—ï¼Ÿ"
ç­”æ¡ˆé€šå¸¸æ˜¯"ä¸è®°å¾—"â€”â€”åˆ«äººå¯¹ä½ ä¹Ÿä¸€æ ·ã€‚`
      },
      {
        title: 'ç»ƒä¹ "è‡ªæˆ‘è‚¯å®šè¯­å¥"',
        steps: [
          'æ¯å¤©æ—©ä¸Šå¯¹é•œå­è¯´ï¼š"æˆ‘ä¸éœ€è¦æ‰€æœ‰äººéƒ½å–œæ¬¢æˆ‘"',
          'ç¤¾äº¤å‰é»˜å¿µï¼š"åšä¸å®Œç¾çš„è‡ªå·±ä¹Ÿæ²¡å…³ç³»"',
          'è¢«æ‰¹è¯„æ—¶å‘Šè¯‰è‡ªå·±ï¼š"ä¸€ä¸ªäººçš„è¯„ä»·ä¸ä»£è¡¨æˆ‘çš„å…¨éƒ¨"',
          'äº‹åæé†’ï¼š"æˆ‘å°½åŠ›äº†ï¼Œè¿™å°±å¤Ÿäº†"'
        ],
        reason: 'é‡å¤çš„ç§¯ææš—ç¤ºå¯ä»¥é‡å¡‘å¤§è„‘çš„æ€ç»´æ¨¡å¼ï¼Œé™ä½å¯¹è´Ÿé¢è¯„ä»·çš„è¿‡åº¦æ•æ„Ÿã€‚'
      }
    ]
  } else if (type.id === 'functional_impairment') {
    // åŠŸèƒ½æŸå®³å‹
    suggestions.immediate = [
      {
        title: 'ğŸ†˜ ä¼˜å…ˆäº‹é¡¹ï¼šå¯»æ±‚ä¸“ä¸šå¸®åŠ©',
        content: `ä½ çš„ç¤¾äº¤ç„¦è™‘å·²ç»ä¸¥é‡å½±å“ç”Ÿæ´»è´¨é‡ï¼Œè¿™ä¸æ˜¯"æ€§æ ¼å†…å‘"ï¼Œè€Œæ˜¯éœ€è¦å¹²é¢„çš„å¿ƒç†å›°æ‰°ã€‚

å¼ºçƒˆå»ºè®®ï¼š
âœ… é¢„çº¦å¿ƒç†å’¨è¯¢å¸ˆï¼ˆCBTè®¤çŸ¥è¡Œä¸ºç–—æ³•æœ€æœ‰æ•ˆï¼‰
âœ… å¦‚æœ‰æ¡ä»¶ï¼Œè€ƒè™‘æ­£è§„åŒ»é™¢ç²¾ç¥å¿ƒç†ç§‘
âœ… å‘Šè¯‰ä¿¡ä»»çš„æœ‹å‹/å®¶äººï¼Œå¯»æ±‚æ”¯æŒ

è¿™ä¸æ˜¯è½¯å¼±ï¼Œè€Œæ˜¯å¯¹è‡ªå·±è´Ÿè´£çš„å‹‡æ°”ã€‚`
      },
      {
        title: 'ä»"æœ€å°ç¤¾äº¤å•å…ƒ"å¼€å§‹é‡å»º',
        steps: [
          'ç¬¬1å‘¨ï¼šæ¯å¤©å’Œ1ä¸ªç†Ÿäººå‘è¯­éŸ³ï¼ˆä¸æ˜¯æ–‡å­—ï¼‰',
          'ç¬¬2å‘¨ï¼šå»è¶…å¸‚é—®åº—å‘˜1ä¸ªé—®é¢˜',
          'ç¬¬3å‘¨ï¼šä¸»åŠ¨ç»™1ä¸ªæœ‹å‹æ‰“ç”µè¯',
          'ç¬¬4å‘¨ï¼šå’Œ1ä¸ªäººå•ç‹¬è§é¢30åˆ†é’Ÿ'
        ],
        reason: 'é•¿æœŸå›é¿å¯¼è‡´ç¤¾äº¤è‚Œè‚‰èç¼©ï¼Œéœ€è¦ä»æå°çš„æ­¥éª¤é‡æ–°è®­ç»ƒã€‚ä¸“ä¸šå¸®åŠ©å¯ä»¥è®©è¿™ä¸ªè¿‡ç¨‹æ›´æœ‰æ•ˆã€‚'
      }
    ]
  } else if (type.id === 'rehearsal') {
    // é¢„æ¼”å‹
    suggestions.immediate = [
      {
        title: 'ä½¿ç”¨"5ç§’æ³•åˆ™"æ‰“æ–­ç„¦è™‘',
        steps: [
          'å½“ä½ å¼€å§‹è„‘è¡¥ç³Ÿç³•åœºæ™¯æ—¶',
          'æ•°5ä¸ªæ•°(5-4-3-2-1)',
          'ç«‹å³è½¬ç§»æ³¨æ„åŠ›ï¼ˆåšåˆ«çš„äº‹ï¼‰',
          'ä¸ç»™å¤§è„‘"é¢„æ¼”"çš„æœºä¼š'
        ],
        reason: 'å¤§è„‘çš„é¢„æœŸç„¦è™‘éœ€è¦æ—¶é—´ç´¯ç§¯ï¼Œå¿«é€Ÿæ‰“æ–­å¯ä»¥é˜²æ­¢é™·å…¥æ¶æ€§å¾ªç¯ã€‚'
      },
      {
        title: 'å‡†å¤‡3ä¸ª"ä¸‡èƒ½è¯é¢˜"',
        content: `è¯é¢˜æ¸…å•ï¼š
Â· æœ€è¿‘çœ‹çš„å‰§/ä¹¦/ç»¼è‰º - "ä½ æœ€è¿‘åœ¨è¿½ä»€ä¹ˆå‰§?"
Â· è¯¢é—®å¯¹æ–¹è¿‘å†µ - "ä½ æœ€è¿‘å¿™ä»€ä¹ˆå‘¢?"
Â· åˆ†äº«è½»æ¾å°äº‹ - "ä»Šå¤©é‡åˆ°ä¸ªå¥½ç©çš„äº‹..."

æŠ€å·§ï¼šä½¿ç”¨å¼€æ”¾å¼é—®é¢˜ï¼ˆä¸èƒ½yes/noå›ç­”ï¼‰ï¼Œè®©å¯¹æ–¹å¤šè¯´ï¼Œä½ å°±è½»æ¾äº†ã€‚`
      }
    ]
  } else if (type.id === 'avoidant') {
    // å›é¿å‹
    suggestions.immediate = [
      {
        title: 'å»ºç«‹"ç¤¾äº¤æš´éœ²é˜¶æ¢¯"',
        content: `æŠŠææƒ§åœºæ™¯æŒ‰éš¾åº¦æ’åºï¼ˆ1-10åˆ†ï¼‰ï¼š
1åˆ†ï¼šç»™å¿«é€’å‘˜è¯´"è°¢è°¢"
3åˆ†ï¼šè¶…å¸‚é—®åº—å‘˜ä½ç½®
5åˆ†ï¼šå’ŒåŒäº‹é—²èŠ5åˆ†é’Ÿ
7åˆ†ï¼šå‚åŠ 3äººå°èš
10åˆ†ï¼šå‚åŠ é™Œç”Ÿäººèšä¼š

è§„åˆ™ï¼šä»1åˆ†å¼€å§‹ï¼Œæ¯ä¸ªç­‰çº§é‡å¤3-5æ¬¡åå†å‡çº§ã€‚
ä¸è¦è·³çº§ï¼Œç¨³æ‰ç¨³æ‰“ã€‚`
      },
      {
        title: 'è®¾ç½®"ç¤¾äº¤é…é¢"',
        steps: [
          'æ¯å‘¨è‡³å°‘1æ¬¡å°ç¤¾äº¤ï¼ˆä¸èƒ½å–æ¶ˆï¼‰',
          'å¯ä»¥æå‰ç¦»å¼€ï¼Œä½†å¿…é¡»å»',
          'å®Œæˆåå¥–åŠ±è‡ªå·±ï¼ˆçœ‹å‰§ã€ç¾é£Ÿç­‰ï¼‰',
          'è®°å½•æ„Ÿå—ï¼šå®é™…ç„¦è™‘ vs é¢„æœŸç„¦è™‘'
        ],
        reason: 'å›é¿åªä¼šå¼ºåŒ–ææƒ§ï¼Œé€æ­¥æš´éœ²æ‰èƒ½æ‰“ç ´å¾ªç¯ã€‚'
      }
    ]
  } else if (type.id === 'performance') {
    // è¡¨æ¼”å‹
    suggestions.immediate = [
      {
        title: 'æ¥çº³ä½ çš„èº«ä½“ååº”',
        content: `å¿ƒè·³åŠ é€Ÿã€å‡ºæ±—ã€è„¸çº¢â€”â€”è¿™äº›éƒ½æ˜¯æ­£å¸¸çš„ï¼

æ”¹å˜è®¤çŸ¥ï¼š
âŒ "ç³Ÿäº†ï¼Œæˆ‘åœ¨å‘æŠ–ï¼Œåˆ«äººè‚¯å®šè§‰å¾—æˆ‘å¾ˆå¥‡æ€ª"
âœ… "æˆ‘çš„èº«ä½“åœ¨å¸®æˆ‘å‡†å¤‡åº”å¯¹æŒ‘æˆ˜ï¼Œè¿™æ˜¯æ­£å¸¸ååº”"

ç ”ç©¶è¡¨æ˜ï¼š
Â· ä½ è§‰å¾—è‡ªå·±çš„ç´§å¼ éå¸¸æ˜æ˜¾
Â· å®é™…ä¸Šåˆ«äººå‡ ä¹æ³¨æ„ä¸åˆ°
Â· å³ä½¿æ³¨æ„åˆ°ï¼Œä¹Ÿä¸ä¼šå› æ­¤å¦å®šä½ `
      },
      {
        title: 'ä½¿ç”¨"æ·±å‘¼å¸+è‚Œè‚‰æ”¾æ¾"',
        steps: [
          'å¸æ°”4ç§’ â†’ æ†‹æ°”4ç§’ â†’ å‘¼æ°”6ç§’',
          'é‡å¤3-5æ¬¡ï¼Œæ¿€æ´»å‰¯äº¤æ„Ÿç¥ç»',
          'åŒæ—¶ç»·ç´§æ‹³å¤´3ç§’ï¼Œç„¶åå®Œå…¨æ”¾æ¾',
          'æƒ³è±¡ç´§å¼ åƒæ°´ä¸€æ ·ä»æŒ‡å°–æµèµ°'
        ],
        reason: 'ç”Ÿç†æ”¾æ¾ä¼šåå‘å½±å“å¿ƒç†çŠ¶æ€ï¼Œé™ä½ç„¦è™‘æ„Ÿã€‚'
      }
    ]
  } else {
    // ç»¼åˆå‹
    suggestions.immediate = [
      {
        title: 'å»ºç«‹"ç¤¾äº¤æ—¥è®°"',
        content: `æ¯æ¬¡ç¤¾äº¤åè®°å½•ï¼š
1. é¢„æœŸç„¦è™‘ï¼ˆ1-10åˆ†ï¼‰
2. å®é™…ç„¦è™‘ï¼ˆ1-10åˆ†ï¼‰
3. å‘ç”Ÿçš„"ç³Ÿç³•"äº‹æƒ…
4. å®é™…åæœ

ä½ ä¼šå‘ç°ï¼š
â†’ å®é™…ç„¦è™‘é€šå¸¸ä½äºé¢„æœŸ
â†’ "ç³Ÿç³•"çš„äº‹æƒ…å¾ˆå°‘å‘ç”Ÿ
â†’ å³ä½¿å‘ç”Ÿï¼Œåæœæ²¡é‚£ä¹ˆä¸¥é‡`
      },
      {
        title: 'æ¯å¤©åš1ä»¶"å¾®ç¤¾äº¤"',
        content: `ä¸éœ€è¦å‚åŠ èšä¼šï¼Œä»å°äº‹å¼€å§‹ï¼š
Â· å’Œä¾¿åˆ©åº—åº—å‘˜è¯´"è¾›è‹¦äº†"
Â· ç»™åŒäº‹/åŒå­¦å‘ä¸ªè¡¨æƒ…åŒ…
Â· åœ¨ç¾¤é‡Œå›å¤1æ¡æ¶ˆæ¯
Â· ç”µæ¢¯é‡Œå’Œäººå¾®ç¬‘ç‚¹å¤´

ç§¯ç´¯å°æˆåŠŸï¼Œå»ºç«‹ä¿¡å¿ƒã€‚`
      }
    ]
  }
  
  // 4å‘¨æ¸è¿›è®¡åˆ’ï¼ˆæ ¹æ®å¹´é¾„å’ŒèŒä¸šè°ƒæ•´ï¼‰
  const age = basicInfo.age || 'young_adult'
  const isStudent = basicInfo.occupation === 'student'
  
  suggestions.weekly = {
    week1: {
      title: isStudent ? 'ç¬¬1å‘¨ï¼šçº¿ä¸Šè¯­éŸ³ç»ƒä¹ ' : 'ç¬¬1å‘¨ï¼šä½å‹åŠ›ç¤¾äº¤',
      tasks: isStudent ? [
        'å¾®ä¿¡è¯­éŸ³èŠå¤©ï¼ˆvsæ–‡å­—ï¼‰',
        'æ¯å¤©è‡³å°‘1æ¬¡ï¼Œ3åˆ†é’Ÿä»¥ä¸Š',
        'å¯ä»¥å…ˆæ‰¾æœ€ç†Ÿçš„æœ‹å‹'
      ] : [
        'å’ŒåŒäº‹é—²èŠ5åˆ†é’Ÿ',
        'ä¸»åŠ¨é—®å€™è‡³å°‘3ä¸ªäºº',
        'å‚åŠ 1æ¬¡çº¿ä¸Šä¼šè®®å¹¶å‘è¨€1æ¬¡'
      ]
    },
    week2: {
      title: 'ç¬¬2å‘¨ï¼šé™Œç”Ÿäººç®€çŸ­äº’åŠ¨',
      tasks: [
        'ç»™ä¸ç†Ÿçš„äººæ‰“ç”µè¯ï¼ˆå¿«é€’ã€å¤–å–ã€å®¢æœï¼‰',
        'è¶…å¸‚é—®åº—å‘˜é—®é¢˜',
        'æå‰å‡†å¤‡è¦è¯´çš„è¯'
      ]
    },
    week3: {
      title: 'ç¬¬3å‘¨ï¼šç†Ÿäººå•ç‹¬è§é¢',
      tasks: [
        'ä¸»åŠ¨çº¦1ä¸ªç†Ÿäºº',
        'é€‰è½»æ¾åœºæ‰€ï¼ˆå’–å•¡å…ã€å…¬å›­ï¼‰',
        'æ§åˆ¶åœ¨1-2å°æ—¶'
      ]
    },
    week4: {
      title: 'ç¬¬4å‘¨ï¼šå°è§„æ¨¡ç¾¤ä½“ç¤¾äº¤',
      tasks: [
        'å‚åŠ 3-5äººå°èš',
        'å¯å¸¦ç†ŸäººåŒå»',
        'å…è®¸è‡ªå·±æå‰ç¦»å¼€ï¼ˆä½†å¿…é¡»å»ï¼‰'
      ]
    },
    principle: 'ä»èˆ’é€‚åŒºè¾¹ç¼˜å¼€å§‹ï¼Œé€æ­¥æ‰©å±•ã€‚æ¯å‘¨è‡³å°‘å®Œæˆ1ä¸ªä»»åŠ¡ï¼Œä¸è¦ä¸€æ¬¡æ€§å…¨åšå®Œã€‚'
  }
  
  return suggestions
}

// ========== å·¥å…·ä¸æ„å»ºå™¨ ==========
function hashString(str) {
  let h = 2166136261 >>> 0
  for (let i = 0; i < str.length; i++) {
    h ^= str.charCodeAt(i)
    h = Math.imul(h, 16777619)
  }
  return h >>> 0
}

function buildSeededRng(seed) {
  let s = seed >>> 0
  return function next() {
    // xorshift32
    s ^= s << 13
    s ^= s >>> 17
    s ^= s << 5
    return ((s >>> 0) % 1e9) / 1e9
  }
}

function sampleDistinct(arr, count, rng) {
  const indices = Array.from({ length: arr.length }, (_, i) => i)
  for (let i = indices.length - 1; i > 0; i--) {
    const j = Math.floor(rng() * (i + 1))
    const t = indices[i]
    indices[i] = indices[j]
    indices[j] = t
  }
  return indices.slice(0, Math.max(0, Math.min(count, arr.length))).map(i => arr[i])
}

function buildExposureLadder(topDims, rng) {
  const templates = {
    anticipation: [
      'åœ¨ç”µæ¢¯é‡Œä¸1äººå¾®ç¬‘ç‚¹å¤´',
      'é—®å‰å°ä¸€ä¸ªç®€å•é—®é¢˜',
      'ç»™æœ‹å‹å‘30ç§’è¯­éŸ³',
      'åœ¨ä¼šè®®ä¸­è¯´1å¥æ”¯æŒæ€§è¯„è®º',
      'ä¸»åŠ¨ç»„ç»‡1æ¬¡3äººçº¿ä¸Šå°èŠ'
    ],
    avoidance: [
      'ç»™å¤–å–å‘˜è¯´â€œè¾›è‹¦äº†â€',
      'ä¾¿åˆ©åº—è¯¢é—®è´§æ¶ä½ç½®',
      'ä¸åŒäº‹å¯’æš„3åˆ†é’Ÿ',
      'å‚åŠ å°ç»„ä¾‹ä¼šå¹¶å‘è¨€',
      'å‚åŠ çº¿ä¸‹å°èšå¹¶åœç•™30åˆ†é’Ÿ'
    ],
    scene_fear: [
      'åœ¨è¶…å¸‚æ’é˜Ÿæ—¶ä¸å‰åå„è¯´1å¥è¯',
      'ä¸»åŠ¨ä¸åŒå­¦/åŒäº‹æ‰“æ‹›å‘¼',
      'åœ¨å°ç»„å†…åš1åˆ†é’Ÿæ±‡æŠ¥',
      'å‘é™Œç”Ÿäººé—®è·¯',
      'å‚ä¸5äººå°ç»„è®¨è®ºå¹¶å‘è¨€2æ¬¡'
    ],
    fear_of_negative_evaluation: [
      'åœ¨ç¾¤é‡Œå‘é€1æ¡éå®Œç¾ä½†çœŸå®çš„æ¶ˆæ¯',
      'æå‡º1ä¸ªå°é—®é¢˜ï¼ˆå…è®¸ä¸å®Œç¾ï¼‰',
      'åˆ†äº«ä¸€æ¬¡â€œå°å¤±è´¥â€çš„ç»éªŒ',
      'è‡ªæˆ‘æš´éœ²ï¼šè¯´å‡º1ä¸ªå°ç¼ºç‚¹',
      'åšä¸€ä¸ªä¸å®Œç¾çš„æ¼”ç¤ºï¼ˆåˆ»æ„ä¿ç•™å°ç‘•ç–µï¼‰'
    ],
    rumination: [
      'ç¤¾äº¤åç«‹å³å†™ä¸‹3æ¡æ­£å‘è¯æ®',
      'è®¾ç½®10åˆ†é’Ÿååˆè®¡æ—¶å¹¶å‡†æ—¶åœæ­¢',
      'ä¸æœ‹å‹å¤ç›˜è€Œéè‡ªæˆ‘è´£å¤‡',
      'è¿›è¡Œ5åˆ†é’Ÿæ­£å¿µå‘¼å¸',
      'å†™ä¸‹â€œæœ€ç³Ÿä¹Ÿå¯æ‰¿å—â€çš„å¤‡é€‰æ–¹æ¡ˆ'
    ],
    physical: [
      'ç¤¾äº¤å‰åš3è½®4-4-6å‘¼å¸',
      'ç´§å¼ æ—¶è¿›è¡Œæ‰‹æŒæ”¾æ¾è®­ç»ƒ',
      'ä¿æŒç¨³å®šçš„çœ¼ç¥æ¥è§¦2ç§’',
      'å–æ¸©æ°´å¹¶æ”¾æ…¢è¯´è¯é€Ÿåº¦',
      'ä¼šå‰ç«™ç«‹å¼ä¼¸å±•1åˆ†é’Ÿ'
    ],
    functional_impairment: [
      'åˆ—ä¸€é¡¹ä¸å·¥ä½œ/å­¦ä¸šç›´æ¥ç›¸å…³çš„å°ç¤¾äº¤ä»»åŠ¡',
      'ç”¨è®¡æ—¶æ³•å®Œæˆ1ä¸ªå¿…è¦æ²Ÿé€šï¼ˆâ‰¤5åˆ†é’Ÿï¼‰',
      'æ¯å¤©ä¸‹ç­åè®°å½•1ä¸ªå®Œæˆçš„ç¤¾äº¤è¡ŒåŠ¨',
      'çº¦1ä½åŒäº‹/åŒå­¦10åˆ†é’Ÿäº¤æµ',
      'ä¸å¯¼å¸ˆ/ä¸Šçº§çº¦ä¸€æ¬¡åé¦ˆæ²Ÿé€š'
    ]
  }
  const source = (templates[topDims[0]] || []).concat(templates[topDims[1]] || [])
  const picked = sampleDistinct(source, 6, rng)
  return picked.map((task, index) => ({ level: index + 1, task }))
}

function buildWeeklyPlan(basicInfo, severity) {
  const isStudent = basicInfo.occupation === 'student'
  const base = {
    week1: {
      title: isStudent ? 'ç¬¬1å‘¨ï¼šçº¿ä¸Šè¯­éŸ³ç»ƒä¹ ' : 'ç¬¬1å‘¨ï¼šä½å‹åŠ›ç¤¾äº¤',
      tasks: isStudent ? [
        'å¾®ä¿¡è¯­éŸ³èŠå¤©ï¼ˆvsæ–‡å­—ï¼‰',
        'æ¯å¤©è‡³å°‘1æ¬¡ï¼Œ3åˆ†é’Ÿä»¥ä¸Š',
        'å¯ä»¥å…ˆæ‰¾æœ€ç†Ÿçš„æœ‹å‹'
      ] : [
        'å’ŒåŒäº‹é—²èŠ5åˆ†é’Ÿ',
        'ä¸»åŠ¨é—®å€™è‡³å°‘3ä¸ªäºº',
        'å‚åŠ 1æ¬¡çº¿ä¸Šä¼šè®®å¹¶å‘è¨€1æ¬¡'
      ]
    },
    week2: {
      title: 'ç¬¬2å‘¨ï¼šé™Œç”Ÿäººç®€çŸ­äº’åŠ¨',
      tasks: [
        'ç»™ä¸ç†Ÿçš„äººæ‰“ç”µè¯ï¼ˆå¿«é€’ã€å¤–å–ã€å®¢æœï¼‰',
        'è¶…å¸‚é—®åº—å‘˜é—®é¢˜',
        'æå‰å‡†å¤‡è¦è¯´çš„è¯'
      ]
    },
    week3: {
      title: 'ç¬¬3å‘¨ï¼šç†Ÿäººå•ç‹¬è§é¢',
      tasks: [
        'ä¸»åŠ¨çº¦1ä¸ªç†Ÿäºº',
        'é€‰è½»æ¾åœºæ‰€ï¼ˆå’–å•¡å…ã€å…¬å›­ï¼‰',
        'æ§åˆ¶åœ¨1-2å°æ—¶'
      ]
    },
    week4: {
      title: 'ç¬¬4å‘¨ï¼šå°è§„æ¨¡ç¾¤ä½“ç¤¾äº¤',
      tasks: [
        'å‚åŠ 3-5äººå°èš',
        'å¯å¸¦ç†ŸäººåŒå»',
        'å…è®¸è‡ªå·±æå‰ç¦»å¼€ï¼ˆä½†å¿…é¡»å»ï¼‰'
      ]
    },
    principle: 'ä»èˆ’é€‚åŒºè¾¹ç¼˜å¼€å§‹ï¼Œé€æ­¥æ‰©å±•ã€‚æ¯å‘¨è‡³å°‘å®Œæˆ1ä¸ªä»»åŠ¡ï¼Œä¸è¦ä¸€æ¬¡æ€§å…¨åšå®Œã€‚'
  }
  // å‰‚é‡è°ƒæ•´
  if (severity === 'mild') base.principle += 'ï¼ˆè½»åº¦ï¼šæ¯å‘¨â‰¥1ä¸ªä»»åŠ¡ï¼‰'
  else if (severity === 'moderate') base.principle += 'ï¼ˆä¸­åº¦ï¼šæ¯å‘¨â‰¥2ä¸ªä»»åŠ¡ï¼‰'
  else base.principle += 'ï¼ˆé‡åº¦ï¼šæ¯å‘¨â‰¥3ä¸ªä»»åŠ¡ï¼Œå»ºè®®ä¸“ä¸šæ”¯æŒï¼‰'
  return base
}

function buildLongTermPath(severity, type, highDims) {
  const weeks = severity === 'mild' ? '4-6å‘¨' : severity === 'moderate' ? '8-12å‘¨' : '12-16å‘¨+'
  const focusDim = highDims[0] || 'anticipation'
  return [
    { stage: 'é˜¶æ®µ1ï¼šè®¤çŸ¥é‡å»º', duration: '1-2å‘¨', goal: 'è¯†åˆ«å¹¶ä¿®æ­£éç†æ€§ä¿¡å¿µ', modules: ['è‡ªåŠ¨åŒ–æƒ³æ³•è¯†åˆ«', 'è¯æ®å¯¹ç…§', 'æ›¿ä»£æ€§æ€ç»´'], emphasis: type.id === 'fear_evaluation' ? 'èšç„¦ä»–äººè¯„ä»·ç›¸å…³ä¿¡å¿µ' : 'èšç„¦æ³›åŒ–æ¶ˆæä¿¡å¿µ' },
    { stage: 'é˜¶æ®µ2ï¼šç³»ç»Ÿæš´éœ²', duration: weeks, goal: 'é€æ­¥é¢å¯¹ææƒ§æƒ…å¢ƒ', modules: ['æš´éœ²é˜¶æ¢¯', 'å®‰å…¨è¡Œä¸ºå‡å°‘', 'æ„è±¡â†’çº¿ä¸‹è¿‡æ¸¡'], emphasis: `ä¼˜å…ˆå¤„ç†ç»´åº¦ï¼š${focusDim}` },
    { stage: 'é˜¶æ®µ3ï¼šæŠ€èƒ½è®­ç»ƒ', duration: '2-4å‘¨', goal: 'å»ºç«‹ç¨³å®šç¤¾äº¤æŠ€èƒ½', modules: ['å¼€å¯è¯é¢˜', 'ç»´æŒå¯¹è¯', 'è¾¹ç•Œä¸æ‹’ç»'], emphasis: 'æŠŠæŠ€èƒ½ç»ƒåˆ°â€œå¤Ÿç”¨â€ï¼Œè€Œéå®Œç¾' },
    { stage: 'é˜¶æ®µ4ï¼šå…³ç³»æ‹“å±•', duration: '2-4å‘¨', goal: 'æå‡å…³ç³»è´¨é‡', modules: ['æ‰©å¤§å¼±å…³ç³»ç½‘ç»œ', 'é«˜è´¨é‡è¿æ¥', 'åé¦ˆæ€§æ²Ÿé€š'], emphasis: 'æ¯å‘¨æ–°å¢1ä¸ªä½é£é™©è¿æ¥' },
    { stage: 'é˜¶æ®µ5ï¼šç»´æŠ¤ä¸å¤å‘é¢„é˜²', duration: 'é•¿æœŸ', goal: 'å·©å›ºæˆæœï¼Œé˜²æ­¢åå¼¹', modules: ['é¢„è­¦ä¿¡å·æ¸…å•', 'å¤å‘åº”å¯¹è®¡åˆ’', 'é«˜å³°-ä½è°·æ­£å¸¸åŒ–'], emphasis: 'å‡ºç°å€’é€€æ—¶ç”¨â€œå›åˆ°ç¬¬1ä¸ªæœ‰æ•ˆåŠ¨ä½œâ€' }
  ]
}

function buildMetrics(severity, highDims) {
  const baseline = severity === 'mild' ? 6 : severity === 'moderate' ? 8 : 10
  return [
    { name: 'ä¸»è§‚ç„¦è™‘SUDsï¼ˆ0-10ï¼‰', target: `è¾ƒåŸºçº¿ä¸‹é™â‰¥${severity === 'mild' ? 2 : 3}` },
    { name: 'æ¯å‘¨ç¤¾äº¤è¡ŒåŠ¨æ¬¡æ•°', target: `â‰¥${baseline}` },
    { name: 'ååˆæ—¶é•¿ï¼ˆåˆ†é’Ÿ/æ¬¡ï¼‰', target: 'â‰¤10' },
    { name: 'å®‰å…¨è¡Œä¸ºä½¿ç”¨æ•°', target: 'é€å‘¨ä¸‹é™' },
    { name: 'è‡ªæˆ‘æ•ˆèƒ½è¯„åˆ†ï¼ˆ0-10ï¼‰', target: 'é€å‘¨ä¸Šå‡' }
  ]
}

function buildStrengths(protective, basicInfo) {
  const list = []
  if (protective.includes('self_efficacy')) list.push('å…·å¤‡ä¸€å®šçš„è‡ªæˆ‘æ•ˆèƒ½ï¼Œæ¢å¤å¼¹æ€§è¾ƒå¥½')
  if (protective.includes('low_scene_fear')) list.push('åœ¨éƒ¨åˆ†åœºæ™¯ä¸­èƒ½å¤Ÿä¿æŒç¨³å®š')
  if (basicInfo.social_frequency === 'regular' || basicInfo.social_frequency === 'frequent') list.push('å·²æœ‰ç¤¾äº¤ä¹ æƒ¯åŸºç¡€ï¼Œä¾¿äºæŒç»­ç»ƒä¹ ')
  if (basicInfo.occupation === 'student') list.push('æ ¡å›­ç¯å¢ƒæä¾›å®‰å…¨çš„ç»ƒä¹ åœŸå£¤')
  if (list.length === 0) list.push('æ„¿æ„é¢å¯¹é—®é¢˜å¹¶è¡ŒåŠ¨ï¼Œè¿™æ˜¯æœ€å¤§çš„ä¼˜åŠ¿')
  return list
}

function buildTriggers(highDims) {
  const mapping = {
    anticipation: 'äº‹ä»¶å‰çš„è¿‡åº¦é¢„æ¼”ä¸ä¸ç¡®å®šæ€§',
    rumination: 'äº‹ä»¶åçš„è‡ªæˆ‘è‹›è´£ä¸åå¤å›æƒ³',
    avoidance: 'å¯¹å¯èƒ½è¢«è¯„åˆ¤çš„åœºæ™¯çš„é€ƒé¿',
    scene_fear: 'äººç¾¤ã€ç›®å…‰é›†ä¸­æˆ–é™Œç”Ÿåœºåˆ',
    physical: 'çªå‘çš„ç”Ÿç†ååº”è¢«è¯¯è¯»ä¸ºâ€œå±é™©â€',
    fear_of_negative_evaluation: 'å…³æ³¨ä»–äººè¯„ä»·ä¸è‡ªæˆ‘ä»·å€¼ç»‘å®š',
    functional_impairment: 'é•¿æœŸç´¯ç§¯çš„è´Ÿæ€§åé¦ˆä¸æœºä¼šæµå¤±'
  }
  return highDims.map(k => mapping[k]).filter(Boolean)
}

export default {
  calculateScores,
  getLevel,
  getType,
  getDimensionLevel,
  getDimensionInterpretation,
  generateReport
}
