# 激活码每日次数限制修复报告

## 问题描述

用户反馈：激活码 `GMBW-C26A-A9VD` 今天已经测试了三次，按理说不能再使用了。但是在激活页面输入该激活码时，仍然可以填写并尝试进入测试页面，直到进入测评页面后才被拦截提示"今日测评次数已用完"。

**期望行为**：在激活页面输入激活码时，就应该检测到今日次数已用完，并直接提示"今日已测试了三次，改日再来"，不让用户进入测评页面。

## 问题根源分析

### 原有逻辑流程

1. **激活页面验证**（`ActivationPage.vue`）
   - 用户输入激活码
   - 调用 `verifyActivationCode()` 验证激活码
   - 如果验证通过（`valid: true`），跳转到测评页面
   - 如果验证失败（`valid: false`），显示错误提示

2. **后端验证逻辑**（`backend/activationService.js` 的 `verifyActivationCode` 函数）
   - 查找激活记录：`WHERE activation_code = ? AND user_device_id = ?`
   - **问题所在**：只查找当前设备的激活记录
   - 如果找到当前设备的记录，检查今日使用次数
   - 如果没有找到当前设备的记录（新设备或清除了缓存），**直接创建新记录，跳过今日使用次数检查**

3. **测评页面检查**（`AssessmentPage.vue`）
   - 进入页面时调用 `getActivationStatus()` 检查激活状态
   - 检查今日剩余次数，如果为 0 则拦截

### 问题场景

当用户在同一个激活码下：
- 设备 A 使用了 3 次（今日次数用完）
- 设备 B（或清除了浏览器缓存的设备 A）尝试使用同一个激活码
- 后端在验证时，因为找不到设备 B 的激活记录，会创建新记录
- **跳过了今日使用次数的检查**，返回 `valid: true`
- 用户可以进入测评页面，直到提交时才被拦截

### 设计缺陷

原有逻辑只在 `recordUsage` 函数（记录使用时）检查所有设备的总使用次数，但在 `verifyActivationCode` 函数（验证激活码时）没有检查所有设备的总使用次数。

这导致了一个漏洞：用户可以通过更换设备或清除浏览器缓存来绕过激活页面的次数检查。

## 修复方案

### 修改内容

修改 `backend/activationService.js` 中的 `verifyActivationCode` 函数，在验证激活码时**优先检查所有设备的今日总使用次数**。

### 修复后的逻辑流程

1. **先检查所有设备的今日总使用次数**（第 62-85 行）
   ```javascript
   // 查询该激活码在所有设备上的使用记录
   const [allRecordsForCode] = await pool.query(
     'SELECT usage_by_date FROM activation_records WHERE code_id = ?',
     [code.id]
   );
   
   // 计算今日总使用次数
   let totalUsedToday = 0;
   for (const rec of allRecordsForCode) {
     const usageByDate = JSON.parse(rec.usage_by_date || '{}');
     totalUsedToday += (usageByDate[today] || 0);
   }
   
   // 如果今日使用次数已达上限，直接拒绝（无论是否是新设备）
   if (totalUsedToday >= code.daily_limit) {
     return {
       valid: false,
       error: `今日使用次数已达上限（${code.daily_limit}次）`,
       remainingToday: 0,
       dailyLimit: code.daily_limit
     };
   }
   ```

2. **再检查当前设备的激活记录**（第 87-109 行）
   - 如果当前设备已激活，检查是否过期
   - 返回激活信息，包括所有设备的总使用次数

3. **如果当前设备未激活，创建新记录**（第 111-136 行）
   - 创建新的激活记录
   - 返回激活信息，包括所有设备的总使用次数

### 关键改进

1. ✅ **跨设备次数限制**：无论用户在哪个设备上使用，同一个激活码每天总共只能使用 3 次
2. ✅ **激活页面拦截**：在激活页面就能检测到今日次数已用完，不让用户进入测评页面
3. ✅ **友好的错误提示**：前端已有完善的错误处理逻辑，会显示"今日测评次数已用完，明天再来吧～"

## 测试验证

### 测试场景 1：同一设备多次使用

1. 使用激活码 `GMBW-C26A-A9VD` 完成 3 次测评
2. 再次在激活页面输入该激活码
3. **预期结果**：显示"今日使用次数已达上限（3次）"，不能进入测评页面

### 测试场景 2：跨设备使用

1. 设备 A 使用激活码 `GMBW-C26A-A9VD` 完成 3 次测评
2. 设备 B 在激活页面输入该激活码
3. **预期结果**：显示"今日使用次数已达上限（3次）"，不能进入测评页面

### 测试场景 3：清除缓存后使用

1. 使用激活码 `GMBW-C26A-A9VD` 完成 3 次测评
2. 清除浏览器缓存
3. 再次在激活页面输入该激活码
4. **预期结果**：显示"今日使用次数已达上限（3次）"，不能进入测评页面

### 测试场景 4：部分使用后跨设备

1. 设备 A 使用激活码 `GMBW-C26A-A9VD` 完成 2 次测评
2. 设备 B 在激活页面输入该激活码
3. **预期结果**：验证成功，显示"激活成功！有效期 X 天，每天 3 次测评机会"
4. 设备 B 完成 1 次测评
5. 设备 A 或设备 B 再次尝试使用
6. **预期结果**：显示"今日使用次数已达上限（3次）"

## 影响范围

### 修改的文件

- `backend/activationService.js`：修改 `verifyActivationCode` 函数

### 不需要修改的文件

- `src/views/ActivationPage.vue`：前端逻辑已经正确处理了 `valid: false` 的情况
- `src/utils/activation.js`：错误解析逻辑已经能够识别"今日使用次数已达上限"的错误

### 兼容性

- ✅ 向后兼容：不影响现有的激活码和激活记录
- ✅ 不影响其他功能：只修改了验证逻辑，不影响记录使用、查询状态等功能

## 部署说明

1. 停止后端服务
2. 更新 `backend/activationService.js` 文件
3. 重启后端服务
4. 无需更新前端代码
5. 无需更新数据库结构

## 提示信息优化

### 优化目标

让用户在不同情况下收到更加准确、友好的提示信息，特别是区分：
1. **今日次数已用完**：激活码还有效，但今天的 3 次机会已用完，明天可以继续使用
2. **激活码已过期**：激活码的 7 天有效期已结束，无法再使用

### 关键改进

#### 1. 后端返回剩余天数

修改后端 `verifyActivationCode` 函数，在今日次数已用完时返回剩余天数：

```javascript
// 计算剩余天数（基于最早的激活记录）
let daysLeft = code.validity_days;
if (earliestExpiresAt) {
  const msLeft = earliestExpiresAt.getTime() - Date.now();
  daysLeft = Math.max(0, Math.ceil(msLeft / (24 * 60 * 60 * 1000)));
}

// 如果今日使用次数已达上限，返回详细信息（包括剩余天数）
if (totalUsedToday >= code.daily_limit) {
  return {
    valid: false,
    error: `今日使用次数已达上限（${code.daily_limit}次）`,
    remainingToday: 0,
    dailyLimit: code.daily_limit,
    daysLeft: daysLeft, // 返回剩余天数
    isActivated: allRecordsForCode.length > 0
  };
}
```

#### 2. 前端根据剩余天数显示不同提示

修改前端 `parseBackendError` 函数，根据剩余天数生成不同的提示：

| 剩余天数 | 主要信息 | 详细提示 | 图标 |
|---------|---------|---------|------|
| 0 天 | 今日测评次数已用完，激活码今天到期 | 该激活码今天到期，明天将无法使用。如需继续测评，请联系客服获取新码 | ⏰ |
| 1 天 | 今日测评次数已用完，明天再来吧～ | 激活码还剩 1 天有效期，明天 00:00 恢复 3 次测评机会 | 😊 |
| 2-3 天 | 今日测评次数已用完，明天再来吧～ | 激活码还剩 X 天有效期，明天 00:00 恢复 3 次测评机会 | 😊 |
| 4-7 天 | 今日测评次数已用完，明天再来吧～ | 激活码还剩 X 天有效期，每天可测评 3 次 | 😊 |

### 用户体验提升

**优化前**：
- ❌ 所有"今日次数已用完"的情况都显示相同的提示
- ❌ 用户不知道激活码还剩多少天
- ❌ 容易混淆"今日次数已用完"和"激活码已过期"

**优化后**：
- ✅ 根据剩余天数显示不同的提示
- ✅ 用户清楚知道激活码还能用多久
- ✅ 明确区分"今日次数已用完"（明天可以继续用）和"激活码已过期"（无法再用）
- ✅ 提示语气更加友好和准确

详细说明请参考：[激活码提示信息优化说明.md](./激活码提示信息优化说明.md)

## 总结

本次修复解决了激活码每日次数限制的两个重要问题：

### 1. 跨设备次数限制漏洞

**问题**：用户可以通过更换设备或清除浏览器缓存来绕过激活页面的次数检查。

**修复**：在验证激活码时检查所有设备的今日总使用次数，确保跨设备次数限制生效。

### 2. 提示信息不够准确

**问题**：所有"今日次数已用完"的情况都显示相同的提示，用户容易混淆"今日次数已用完"和"激活码已过期"。

**修复**：根据剩余天数显示不同的提示，明确区分两种情况，提升用户体验。

修复后，激活码的每日次数限制将在**所有设备**上生效，用户在激活页面就能得到**准确、友好**的提示，不会浪费时间填写测评问卷后才发现无法提交。

这大大提升了用户体验，也确保了激活码的使用次数限制得到正确执行。

