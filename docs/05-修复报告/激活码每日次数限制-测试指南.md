# 激活码每日次数限制修复 - 测试指南

## 快速测试

### 1. 运行测试脚本

在项目根目录下运行：

```bash
node test-daily-limit-fix.js
```

这个脚本会：
- 查找激活码 `GMBW-C26A-A9VD`
- 显示该激活码的所有激活记录
- 计算今日总使用次数
- 判断验证逻辑是否正确

### 2. 启动后端服务

```bash
cd backend
npm start
```

### 3. 启动前端服务

在另一个终端：

```bash
npm run dev
```

## 手动测试步骤

### 测试场景 1：今日次数已用完

**前提条件**：激活码 `GMBW-C26A-A9VD` 今天已经使用了 3 次

**测试步骤**：
1. 打开浏览器，访问激活页面
2. 输入激活码：`GMBW-C26A-A9VD`
3. 点击"开始测评"按钮

**预期结果**：
- ❌ 不能进入测评页面
- ✅ 显示错误提示："今日测评次数已用完，明天再来吧～"
- ✅ 显示提示信息："每天可测评 3 次，明天 00:00 自动恢复"
- ✅ Toast 提示显示为 warning 样式（黄色）

**实际效果截图位置**：
- 输入框下方显示错误信息
- 页面顶部显示 Toast 提示

### 测试场景 2：今日还有剩余次数

**前提条件**：激活码今天使用了 0-2 次

**测试步骤**：
1. 打开浏览器，访问激活页面
2. 输入激活码
3. 点击"开始测评"按钮

**预期结果**：
- ✅ 显示成功提示："激活成功！有效期 X 天，每天 3 次测评机会"
- ✅ 2 秒后自动跳转到测评页面
- ✅ Toast 提示显示为 success 样式（绿色）

### 测试场景 3：跨设备使用（关键测试）

**前提条件**：
- 设备 A 使用激活码完成了 3 次测评
- 设备 B 是新设备（或清除了浏览器缓存）

**测试步骤**：
1. 在设备 B 打开浏览器，访问激活页面
2. 输入相同的激活码
3. 点击"开始测评"按钮

**预期结果**：
- ❌ 不能进入测评页面（这是修复的关键点！）
- ✅ 显示错误提示："今日测评次数已用完，明天再来吧～"
- ✅ 即使是新设备，也会被正确拦截

**修复前的错误行为**：
- ❌ 可以进入测评页面
- ❌ 可以填写问卷
- ❌ 提交时才被拦截

### 测试场景 4：部分使用后跨设备

**前提条件**：
- 设备 A 使用激活码完成了 2 次测评
- 设备 B 是新设备

**测试步骤**：
1. 在设备 B 打开浏览器，访问激活页面
2. 输入相同的激活码
3. 点击"开始测评"按钮
4. 完成 1 次测评
5. 在设备 A 或设备 B 再次尝试使用

**预期结果**：
- ✅ 第一次使用时可以进入测评页面（剩余 1 次）
- ✅ 完成测评后，显示"今日剩余 0 次"
- ❌ 再次尝试时，在激活页面就被拦截

## 数据库验证

### 查询激活码使用情况

```sql
-- 查询激活码信息
SELECT * FROM activation_codes WHERE code = 'GMBW-C26A-A9VD';

-- 查询该激活码的所有激活记录
SELECT 
  ar.id,
  ar.user_device_id,
  ar.usage_count,
  ar.usage_by_date,
  ar.expires_at,
  ar.created_at
FROM activation_records ar
JOIN activation_codes ac ON ar.code_id = ac.id
WHERE ac.code = 'GMBW-C26A-A9VD';
```

### 手动设置今日使用次数（用于测试）

```sql
-- 设置某个激活记录今日使用了 3 次
UPDATE activation_records 
SET usage_by_date = JSON_SET(
  COALESCE(usage_by_date, '{}'),
  CONCAT('$."', CURDATE(), '"'),
  3
)
WHERE id = 1; -- 替换为实际的记录 ID
```

### 重置今日使用次数（用于测试）

```sql
-- 清空某个激活记录的今日使用次数
UPDATE activation_records 
SET usage_by_date = JSON_REMOVE(
  usage_by_date,
  CONCAT('$."', CURDATE(), '"')
)
WHERE id = 1; -- 替换为实际的记录 ID
```

## 日志检查

### 后端日志

启动后端服务后，在控制台查看日志：

```
📊 [验证激活码] 激活码 GMBW-C26A-A9VD 今天所有设备总共使用了 3/3 次
```

这条日志说明：
- ✅ 后端正确计算了所有设备的总使用次数
- ✅ 验证逻辑会在这一步拦截

### 前端日志

打开浏览器开发者工具（F12），查看 Console：

```javascript
// 验证失败时
{
  valid: false,
  error: "今日使用次数已达上限（3次）",
  remainingToday: 0,
  dailyLimit: 3
}
```

## 常见问题

### Q1: 测试时发现还是可以进入测评页面？

**可能原因**：
1. 后端服务没有重启，还在使用旧代码
2. 数据库中的使用次数没有正确记录

**解决方法**：
1. 停止后端服务，重新启动
2. 运行测试脚本检查数据库中的使用次数
3. 检查后端日志，确认是否输出了正确的日志

### Q2: 如何模拟"今日次数已用完"的情况？

**方法 1**：真实使用
- 使用激活码完成 3 次测评

**方法 2**：修改数据库
- 使用上面的 SQL 语句手动设置今日使用次数为 3

**方法 3**：使用测试脚本
- 运行 `node test-daily-limit-fix.js` 查看当前状态

### Q3: 如何模拟"跨设备使用"的情况？

**方法 1**：使用不同的浏览器
- Chrome、Firefox、Edge 等会有不同的 deviceId

**方法 2**：清除浏览器缓存
- 清除 localStorage 会生成新的 deviceId

**方法 3**：使用隐私模式
- 每次打开隐私模式都会生成新的 deviceId

## 验收标准

修复成功的标志：

- ✅ 激活码今日使用 3 次后，在激活页面就被拦截
- ✅ 跨设备使用时，次数限制仍然生效
- ✅ 清除浏览器缓存后，次数限制仍然生效
- ✅ 错误提示友好，用户体验良好
- ✅ 后端日志正确显示所有设备的总使用次数

## 回归测试

确保修复没有影响其他功能：

- ✅ 新激活码可以正常激活
- ✅ 激活码过期检查仍然有效
- ✅ 激活码总次数限制（21 次）仍然有效
- ✅ 测评提交时的次数扣除仍然正常
- ✅ 导航栏的激活状态显示仍然正常

## 总结

本次修复的核心改进：

**修复前**：
- 只检查当前设备的使用次数
- 新设备可以绕过次数限制
- 用户浪费时间填写问卷后才发现无法提交

**修复后**：
- 检查所有设备的总使用次数
- 任何设备都无法绕过次数限制
- 用户在激活页面就能得到明确提示

这大大提升了用户体验和系统的安全性！

