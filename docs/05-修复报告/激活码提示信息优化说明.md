# 激活码提示信息优化说明

## 优化目标

让用户在不同情况下收到更加准确、友好的提示信息，特别是区分以下两种情况：
1. **今日次数已用完**：激活码还有效，但今天的 3 次机会已用完，明天可以继续使用
2. **激活码已过期**：激活码的 7 天有效期已结束，无法再使用

## 各种情况的提示信息

### 1. 激活码不存在

**触发条件**：输入的激活码在数据库中不存在

**提示信息**：
- 主要信息：`激活码不存在，请检查后重试`
- 提示信息：`请确认激活码是否输入正确，或联系客服获取激活码`
- 图标：无

**用户操作**：
- 检查激活码是否输入正确
- 联系客服获取正确的激活码

---

### 2. 激活码已失效/被撤销

**触发条件**：激活码的状态为 `revoked`（已撤销）

**提示信息**：
- 主要信息：`该激活码已失效，无法继续使用`
- 提示信息：`请联系客服了解详情或获取新的激活码`
- 图标：无

**用户操作**：
- 联系客服了解为什么激活码被撤销
- 获取新的激活码

---

### 3. 激活码已过期（7天有效期已结束）

**触发条件**：激活码的 `expires_at` 时间已过，或激活记录的 `expires_at` 时间已过

**提示信息**：
- 主要信息：`激活码已过期，有效期已结束`
- 提示信息：`激活码有效期为 7 天，请联系客服获取新的激活码`
- 图标：`⏰`

**用户操作**：
- 联系客服获取新的激活码
- 无法再使用该激活码

**注意**：这是真正的"过期"，与"今日次数已用完"不同

---

### 4. 使用次数已达上限（总次数 21 次）

**触发条件**：激活码的总使用次数达到 `max_uses`（通常是 21 次 = 7天 × 3次/天）

**提示信息**：
- 主要信息：`该激活码使用次数已用完`
- 提示信息：`每个激活码最多可使用 21 次（7天×3次/天），请联系客服获取新码`
- 图标：`🔒`

**用户操作**：
- 联系客服获取新的激活码
- 无法再使用该激活码

---

### 5. 今日使用次数已达上限（每天 3 次）⭐ 重点优化

**触发条件**：激活码今天在所有设备上的总使用次数达到 `daily_limit`（通常是 3 次）

**提示信息**：根据剩余天数显示不同的提示

#### 5.1 今天是最后一天（剩余 0 天）

**提示信息**：
- 主要信息：`今日测评次数已用完，激活码今天到期`
- 提示信息：`该激活码今天到期，明天将无法使用。如需继续测评，请联系客服获取新码`
- 图标：`⏰`

**用户操作**：
- 今天无法再测评
- 明天激活码将过期，需要联系客服获取新码

#### 5.2 还剩 1 天

**提示信息**：
- 主要信息：`今日测评次数已用完，明天再来吧～`
- 提示信息：`激活码还剩 1 天有效期，明天 00:00 恢复 3 次测评机会`
- 图标：`😊`

**用户操作**：
- 今天无法再测评
- 明天 00:00 后可以继续使用（最后一天）

#### 5.3 还剩 2-3 天

**提示信息**：
- 主要信息：`今日测评次数已用完，明天再来吧～`
- 提示信息：`激活码还剩 X 天有效期，明天 00:00 恢复 3 次测评机会`（X 为实际剩余天数）
- 图标：`😊`

**用户操作**：
- 今天无法再测评
- 明天 00:00 后可以继续使用

#### 5.4 还剩 4-7 天

**提示信息**：
- 主要信息：`今日测评次数已用完，明天再来吧～`
- 提示信息：`激活码还剩 X 天有效期，每天可测评 3 次`（X 为实际剩余天数）
- 图标：`😊`

**用户操作**：
- 今天无法再测评
- 明天 00:00 后可以继续使用
- 还有充足的时间

#### 5.5 无法获取剩余天数（兜底方案）

**提示信息**：
- 主要信息：`今日测评次数已用完，明天再来吧～`
- 提示信息：`每天可测评 3 次，明天 00:00 自动恢复`
- 图标：`😊`

**用户操作**：
- 今天无法再测评
- 明天 00:00 后可以继续使用

---

### 6. 激活码状态异常

**触发条件**：激活码的状态不是 `active`、`expired`、`used`、`revoked` 中的任何一个

**提示信息**：
- 主要信息：`激活码状态异常，请联系客服`
- 提示信息：`请提供激活码以便客服帮您查询`
- 图标：无

**用户操作**：
- 联系客服，提供激活码
- 等待客服处理

---

### 7. 系统错误/网络错误

**触发条件**：后端服务不可用、网络异常等

**提示信息**：
- 主要信息：`验证服务暂时不可用，请稍后重试`
- 提示信息：`请确保后端服务运行在 http://localhost:3000`（或其他配置的地址）
- 图标：无

**用户操作**：
- 检查网络连接
- 检查后端服务是否运行
- 稍后重试

---

## 关键区别说明

### "今日次数已用完" vs "激活码已过期"

| 项目 | 今日次数已用完 | 激活码已过期 |
|------|---------------|-------------|
| **原因** | 今天使用了 3 次 | 7 天有效期已结束 |
| **能否继续使用** | ✅ 明天可以继续使用 | ❌ 无法再使用 |
| **图标** | 😊（友好） | ⏰（警告） |
| **提示语气** | 轻松、鼓励 | 严肃、提醒 |
| **用户操作** | 明天再来 | 联系客服获取新码 |

### 示例对比

**场景 1**：用户今天使用了 3 次，激活码还剩 5 天有效期
- ✅ 提示：`今日测评次数已用完，明天再来吧～`
- ✅ 详情：`激活码还剩 5 天有效期，每天可测评 3 次`
- ✅ 图标：😊

**场景 2**：用户的激活码 7 天有效期已结束
- ✅ 提示：`激活码已过期，有效期已结束`
- ✅ 详情：`激活码有效期为 7 天，请联系客服获取新的激活码`
- ✅ 图标：⏰

**场景 3**：用户今天使用了 3 次，激活码今天到期
- ✅ 提示：`今日测评次数已用完，激活码今天到期`
- ✅ 详情：`该激活码今天到期，明天将无法使用。如需继续测评，请联系客服获取新码`
- ✅ 图标：⏰

---

## 技术实现

### 后端修改（`backend/activationService.js`）

1. **查询激活记录时获取过期时间**：
   ```javascript
   const [allRecordsForCode] = await pool.query(
     'SELECT usage_by_date, expires_at FROM activation_records WHERE code_id = ?',
     [code.id]
   );
   ```

2. **计算剩余天数**：
   ```javascript
   let daysLeft = code.validity_days;
   if (earliestExpiresAt) {
     const msLeft = earliestExpiresAt.getTime() - Date.now();
     daysLeft = Math.max(0, Math.ceil(msLeft / (24 * 60 * 60 * 1000)));
   }
   ```

3. **返回剩余天数**：
   ```javascript
   if (totalUsedToday >= code.daily_limit) {
     return {
       valid: false,
       error: `今日使用次数已达上限（${code.daily_limit}次）`,
       remainingToday: 0,
       dailyLimit: code.daily_limit,
       daysLeft: daysLeft, // 新增：返回剩余天数
       isActivated: allRecordsForCode.length > 0
     };
   }
   ```

### 前端修改（`src/utils/activation.js`）

1. **接收额外数据**：
   ```javascript
   function parseBackendError(errorMsg, extraData = {}) {
     const daysLeft = extraData.daysLeft !== undefined ? extraData.daysLeft : null
     // ...
   }
   ```

2. **根据剩余天数生成不同提示**：
   ```javascript
   if (daysLeft === 0) {
     message = '今日测评次数已用完，激活码今天到期'
     tip = '该激活码今天到期，明天将无法使用。如需继续测评，请联系客服获取新码'
     icon = '⏰'
   } else if (daysLeft === 1) {
     message = '今日测评次数已用完，明天再来吧～'
     tip = `激活码还剩 1 天有效期，明天 00:00 恢复 3 次测评机会`
     icon = '😊'
   }
   // ... 更多情况
   ```

3. **传递额外数据**：
   ```javascript
   return parseBackendError(result.error || '验证失败', {
     daysLeft: result.daysLeft,
     remainingToday: result.remainingToday,
     dailyLimit: result.dailyLimit,
     isActivated: result.isActivated
   })
   ```

---

## 用户体验提升

### 优化前

- ❌ 所有"今日次数已用完"的情况都显示相同的提示
- ❌ 用户不知道激活码还剩多少天
- ❌ 容易混淆"今日次数已用完"和"激活码已过期"

### 优化后

- ✅ 根据剩余天数显示不同的提示
- ✅ 用户清楚知道激活码还能用多久
- ✅ 明确区分"今日次数已用完"和"激活码已过期"
- ✅ 提示语气更加友好和准确

---

## 测试场景

### 场景 1：今日次数已用完，还剩 5 天

1. 使用激活码完成 3 次测评
2. 再次输入激活码
3. **预期提示**：
   - 主要信息：`今日测评次数已用完，明天再来吧～`
   - 详情：`激活码还剩 5 天有效期，每天可测评 3 次`
   - 图标：😊

### 场景 2：今日次数已用完，今天是最后一天

1. 使用激活码完成 3 次测评（激活码今天到期）
2. 再次输入激活码
3. **预期提示**：
   - 主要信息：`今日测评次数已用完，激活码今天到期`
   - 详情：`该激活码今天到期，明天将无法使用。如需继续测评，请联系客服获取新码`
   - 图标：⏰

### 场景 3：激活码已过期

1. 等待激活码过期（7 天后）
2. 输入激活码
3. **预期提示**：
   - 主要信息：`激活码已过期，有效期已结束`
   - 详情：`激活码有效期为 7 天，请联系客服获取新的激活码`
   - 图标：⏰

---

## 总结

本次优化让提示信息更加**准确**、**友好**、**有用**：

1. ✅ **准确**：区分"今日次数已用完"和"激活码已过期"
2. ✅ **友好**：根据剩余天数调整语气和图标
3. ✅ **有用**：告诉用户具体还剩多少天，何时可以继续使用

用户不会再困惑于"为什么提示已过期，但明天又能用了"这样的问题！

