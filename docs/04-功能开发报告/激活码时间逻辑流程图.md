# 激活码时间逻辑流程图

## 📊 完整流程概览

```
┌─────────────────────────────────────────────────────────────────┐
│                      激活码生命周期                              │
└─────────────────────────────────────────────────────────────────┘

第1步：管理员创建激活码
┌──────────────────────────────────────┐
│  管理后台 AdminCodes.vue             │
│  ┌────────────────────────────────┐  │
│  │ 输入参数：                      │  │
│  │ • validity_days: 7 (有效天数)  │  │
│  │ • daily_limit: 3 (每日上限)    │  │
│  │ • max_uses: 21 (总次数)        │  │
│  └────────────────────────────────┘  │
│           ↓                          │
│  ┌────────────────────────────────┐  │
│  │ POST /api/admin/codes          │  │
│  └────────────────────────────────┘  │
└──────────────────────────────────────┘
            ↓
┌──────────────────────────────────────┐
│  后端 createActivationCode()         │
│  ┌────────────────────────────────┐  │
│  │ INSERT INTO activation_codes   │  │
│  │   code: 'AB12-CD34-EF56'       │  │
│  │   validity_days: 7              │  │
│  │   daily_limit: 3                │  │
│  │   max_uses: 21                  │  │
│  │   status: 'active'              │  │
│  │   current_uses: 0               │  │
│  └────────────────────────────────┘  │
└──────────────────────────────────────┘
            ↓
    ✅ 激活码已创建（等待用户激活）


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


第2步：用户首次激活（⭐ 时间倒计时从这里开始）
┌──────────────────────────────────────┐
│  用户端 ActivationPage.vue           │
│  ┌────────────────────────────────┐  │
│  │ 输入激活码：AB12-CD34-EF56      │  │
│  │ 点击【激活】按钮                │  │
│  └────────────────────────────────┘  │
│           ↓                          │
│  ┌────────────────────────────────┐  │
│  │ verifyActivationCode()         │  │
│  │ POST /api/activation/verify    │  │
│  │ body: {                        │  │
│  │   code: 'AB12-CD34-EF56',      │  │
│  │   deviceId: 'device-xxx'       │  │
│  │ }                              │  │
│  └────────────────────────────────┘  │
└──────────────────────────────────────┘
            ↓
┌──────────────────────────────────────┐
│  后端 verifyActivationCode()         │
│  ┌────────────────────────────────┐  │
│  │ 1. 检查激活码状态               │  │
│  │    ✅ status = 'active'         │  │
│  │    ✅ current_uses < max_uses   │  │
│  └────────────────────────────────┘  │
│           ↓                          │
│  ┌────────────────────────────────┐  │
│  │ 2. 检查是否已激活过             │  │
│  │    ❌ 未找到记录 → 首次激活     │  │
│  └────────────────────────────────┘  │
│           ↓                          │
│  ┌────────────────────────────────┐  │
│  │ 3. ⭐⭐⭐ 计算过期时间 ⭐⭐⭐      │  │
│  │    const expiresAt = new Date()│  │
│  │    expiresAt.setDate(          │  │
│  │      expiresAt.getDate() + 7   │  │ ← 当前时间 + validity_days
│  │    )                           │  │
│  │                                │  │
│  │    例如：                       │  │
│  │    激活时间: 2025-11-05 15:00  │  │
│  │    过期时间: 2025-11-12 15:00  │  │ ← 激活时间 + 7天
│  └────────────────────────────────┘  │
│           ↓                          │
│  ┌────────────────────────────────┐  │
│  │ 4. 创建激活记录                 │  │
│  │    INSERT INTO                 │  │
│  │    activation_records          │  │
│  │      code_id: 1                │  │
│  │      activation_code:          │  │
│  │        'AB12-CD34-EF56'        │  │
│  │      user_device_id:           │  │
│  │        'device-xxx'            │  │
│  │      activated_at:             │  │
│  │        '2025-11-05 15:00:00'  │  │ ← 激活时刻
│  │      expires_at:               │  │
│  │        '2025-11-12 15:00:00'  │  │ ← 过期时刻（+7天）
│  │      usage_count: 0            │  │
│  │      usage_by_date: {}         │  │
│  └────────────────────────────────┘  │
│           ↓                          │
│  ┌────────────────────────────────┐  │
│  │ 5. 更新激活码使用数              │  │
│  │    UPDATE activation_codes     │  │
│  │    SET current_uses += 1       │  │ ← 已激活设备数 +1
│  │    WHERE id = 1                │  │
│  └────────────────────────────────┘  │
└──────────────────────────────────────┘
            ↓
┌──────────────────────────────────────┐
│  返回前端                            │
│  {                                   │
│    valid: true,                      │
│    recordId: 1,                      │
│    expiresAt: '2025-11-12 15:00',    │
│    daysLeft: 7,         ← 剩余7天    │
│    remainingToday: 3    ← 今日3次    │
│  }                                   │
└──────────────────────────────────────┘
            ↓
    ✅ 用户激活成功，时间倒计时开始！


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


第3步：用户完成测评（扣除次数）
┌──────────────────────────────────────┐
│  测评页面 AssessmentPage.vue         │
│  ┌────────────────────────────────┐  │
│  │ 用户完成测评                    │  │
│  │ 点击【提交测评】                │  │
│  └────────────────────────────────┘  │
│           ↓                          │
│  ┌────────────────────────────────┐  │
│  │ recordOneUsage()               │  │
│  │ POST /api/activation/          │  │
│  │      record-usage              │  │
│  │ body: {                        │  │
│  │   recordId: 1                  │  │
│  │ }                              │  │
│  └────────────────────────────────┘  │
└──────────────────────────────────────┘
            ↓
┌──────────────────────────────────────┐
│  后端 recordUsage()                  │
│  ┌────────────────────────────────┐  │
│  │ 1. 获取激活记录                 │  │
│  │    SELECT ar.*, ac.daily_limit │  │
│  │    FROM activation_records ar  │  │
│  │    WHERE ar.id = 1             │  │
│  └────────────────────────────────┘  │
│           ↓                          │
│  ┌────────────────────────────────┐  │
│  │ 2. 更新使用记录                 │  │
│  │    const today = '2025-11-05'  │  │
│  │    usageByDate[today] += 1     │  │ ← 今日次数 +1
│  │                                │  │
│  │    UPDATE activation_records   │  │
│  │    SET                         │  │
│  │      usage_count += 1,         │  │ ← 总次数 +1
│  │      last_used_at = NOW(),     │  │
│  │      usage_by_date =           │  │
│  │        '{"2025-11-05": 1}'     │  │ ← 今日使用记录
│  │    WHERE id = 1                │  │
│  └────────────────────────────────┘  │
│           ↓                          │
│  ┌────────────────────────────────┐  │
│  │ 3. ⭐⭐⭐ 计算剩余状态 ⭐⭐⭐      │  │
│  │                                │  │
│  │    // 计算剩余天数              │  │
│  │    const now = new Date()      │  │
│  │    const expiresAt =           │  │
│  │      new Date(record.expires_at)│ │
│  │    const msLeft =              │  │
│  │      expiresAt - now           │  │
│  │    const daysLeft =            │  │
│  │      Math.ceil(msLeft/86400000)│  │ ← 向上取整
│  │                                │  │
│  │    例如：                       │  │
│  │    当前时间: 2025-11-05 16:00  │  │
│  │    过期时间: 2025-11-12 15:00  │  │
│  │    剩余毫秒: 604800000ms       │  │
│  │    剩余天数: 7天                │  │
│  └────────────────────────────────┘  │
│           ↓                          │
│  ┌────────────────────────────────┐  │
│  │    // 计算今日剩余次数           │  │
│  │    const dailyLimit = 3        │  │
│  │    const todayUsed =           │  │
│  │      usageByDate[today] = 1    │  │
│  │    const remainingToday =      │  │
│  │      3 - 1 = 2                 │  │ ← 今日剩余2次
│  └────────────────────────────────┘  │
└──────────────────────────────────────┘
            ↓
┌──────────────────────────────────────┐
│  返回前端                            │
│  {                                   │
│    success: true,                    │
│    daysLeft: 7,         ← 剩余7天    │
│    remainingToday: 2,   ← 今日剩2次  │
│    expired: false                    │
│  }                                   │
└──────────────────────────────────────┘
            ↓
    ✅ 测试完成！今日剩余2次 · 剩余7天


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


第4步：检查每日使用限制
┌──────────────────────────────────────┐
│  用户完成第3次测评                    │
│  usage_by_date = {"2025-11-05": 3}   │
└──────────────────────────────────────┘
            ↓
┌──────────────────────────────────────┐
│  用户尝试第4次测评                    │
│  ┌────────────────────────────────┐  │
│  │ verifyActivationCode()         │  │ ← 测评前验证
│  └────────────────────────────────┘  │
└──────────────────────────────────────┘
            ↓
┌──────────────────────────────────────┐
│  后端检查今日使用次数                 │
│  ┌────────────────────────────────┐  │
│  │ const today = '2025-11-05'     │  │
│  │ const todayUsage =             │  │
│  │   usageByDate[today] = 3       │  │
│  │                                │  │
│  │ if (todayUsage >= daily_limit) │  │ ← 3 >= 3
│  │   return {                     │  │
│  │     valid: false,              │  │
│  │     error: '今日使用次数已达上限' │
│  │   }                            │  │
│  └────────────────────────────────┘  │
└──────────────────────────────────────┘
            ↓
    ❌ 今日测评次数已用完，明天再来吧～


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


第5步：第二天自动恢复（凌晨0点）
┌──────────────────────────────────────┐
│  时间到达：2025-11-06 00:00:00       │
│  用户访问页面                        │
└──────────────────────────────────────┘
            ↓
┌──────────────────────────────────────┐
│  getActivationStatus()               │
│  ┌────────────────────────────────┐  │
│  │ const today = '2025-11-06'     │  │ ← 新的一天
│  │ const todayUsage =             │  │
│  │   usageByDate[today] || 0      │  │ ← 今日无记录，为0
│  │                                │  │
│  │ const remainingToday =         │  │
│  │   3 - 0 = 3                    │  │ ← 自动恢复3次！
│  └────────────────────────────────┘  │
└──────────────────────────────────────┘
            ↓
    ✅ 剩余6天 · 今日3次（已恢复）


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


第6步：7天后过期
┌──────────────────────────────────────┐
│  时间到达：2025-11-12 15:01:00       │
│  （超过过期时间 2025-11-12 15:00）   │
└──────────────────────────────────────┘
            ↓
┌──────────────────────────────────────┐
│  verifyActivationCode()              │
│  ┌────────────────────────────────┐  │
│  │ 检查激活记录的 expires_at       │  │
│  │                                │  │
│  │ if (record.expires_at < now)   │  │ ← 已过期
│  │   return {                     │  │
│  │     valid: false,              │  │
│  │     error: '您的激活已过期'     │  │
│  │   }                            │  │
│  └────────────────────────────────┘  │
└──────────────────────────────────────┘
            ↓
    ❌ 您的激活已过期


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


## 📊 数据库状态变化时间轴

```
时间线：2025-11-05 15:00 激活

activation_codes 表（激活码本身）
┌─────────────────────────────────────┐
│ code: 'AB12-CD34-EF56'              │
│ validity_days: 7      ← 配置：7天   │
│ daily_limit: 3        ← 配置：3次/天│
│ max_uses: 21          ← 配置：总21次│
│ current_uses: 1       ← 已激活1个设备│
│ status: 'active'                    │
└─────────────────────────────────────┘

activation_records 表（用户激活记录）
┌─────────────────────────────────────┐
│ 11-05 15:00 激活                    │
│ ┌─────────────────────────────────┐ │
│ │ activated_at: 2025-11-05 15:00  │ │ ← ⭐ 倒计时起点
│ │ expires_at: 2025-11-12 15:00    │ │ ← ⭐ 过期时刻（+7天）
│ │ usage_count: 0                  │ │
│ │ usage_by_date: {}               │ │
│ └─────────────────────────────────┘ │
│                                     │
│ 11-05 16:00 第1次测评               │
│ ┌─────────────────────────────────┐ │
│ │ usage_count: 1                  │ │
│ │ usage_by_date:                  │ │
│ │   {"2025-11-05": 1}             │ │ ← 今日1次
│ └─────────────────────────────────┘ │
│                                     │
│ 11-05 17:00 第2次测评               │
│ ┌─────────────────────────────────┐ │
│ │ usage_count: 2                  │ │
│ │ usage_by_date:                  │ │
│ │   {"2025-11-05": 2}             │ │ ← 今日2次
│ └─────────────────────────────────┘ │
│                                     │
│ 11-05 18:00 第3次测评               │
│ ┌─────────────────────────────────┐ │
│ │ usage_count: 3                  │ │
│ │ usage_by_date:                  │ │
│ │   {"2025-11-05": 3}             │ │ ← 今日3次（达上限）
│ └─────────────────────────────────┘ │
│                                     │
│ 11-06 09:00 第4次测评（新的一天）   │
│ ┌─────────────────────────────────┐ │
│ │ usage_count: 4                  │ │
│ │ usage_by_date:                  │ │
│ │   {                             │ │
│ │     "2025-11-05": 3,            │ │ ← 昨天3次
│ │     "2025-11-06": 1             │ │ ← 今日1次（已恢复）
│ │   }                             │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ... 持续7天 ...                     │
│                                     │
│ 11-12 15:01 过期后尝试测评          │
│ ┌─────────────────────────────────┐ │
│ │ expires_at: 2025-11-12 15:00    │ │
│ │ NOW(): 2025-11-12 15:01         │ │
│ │ expired: true   ← ❌ 已过期      │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

---

## 🎯 关键时间点总结

| 时间节点 | 事件 | 数据变化 | 用户可见状态 |
|---------|------|---------|------------|
| 管理员创建 | 激活码入库 | `activation_codes.status = 'active'` | - |
| 用户激活 | ⭐ **倒计时开始** | `expires_at = activated_at + 7天` | `剩余7天·今日3次` |
| 第1次测评 | 扣除次数 | `usage_count=1, usageByDate={"11-05":1}` | `剩余7天·今日2次` |
| 第3次测评 | 今日达上限 | `usageByDate={"11-05":3}` | `今日0次·明天恢复` |
| 第2天0点 | 自动恢复 | `todayUsage=0` (新日期无记录) | `剩余6天·今日3次` |
| 第8天 | 过期 | `expires_at < now` | `❌ 已过期` |

---

## ✅ 结论

**时间计算逻辑完全正确！**

✅ 时间从**用户激活时刻**开始倒计时
✅ 过期时间 = 激活时间 + 7天（精确到秒）
✅ 每次测评扣除1次，记录在 `usage_by_date`
✅ 每日0点自动恢复（通过日期字符串判断）
✅ 7天后自动过期，无法继续使用

