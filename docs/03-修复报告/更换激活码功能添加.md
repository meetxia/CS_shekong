# 更换激活码功能添加

## 需求背景

用户反馈：如果今天的测评次数用完了，想购买新的激活码继续测试，但是没有入口可以更换激活码。

### 用户场景

```
用户情况：
- 已激活激活码 A（每天3次）
- 今天已经用了3次
- 想继续测试，购买了新的激活码 B

问题：
- 没有入口可以输入新的激活码
- 只能等到明天，无法立即继续测试
```

## 解决方案

### 添加"更换激活码"入口

在导航栏添加一个**更换激活码**的按钮，允许用户随时跳转到激活码页面输入新的激活码。

### 实现位置

#### 1. 桌面端导航栏

**位置：** 右上角工具栏，在配色切换按钮左侧

**按钮设计：**
```vue
<button
  v-if="hasActivation"
  @click="goToActivation"
  class="icon-btn"
  title="更换激活码"
>
  <span class="iconify" data-icon="mdi:key-plus" data-width="20" data-height="20"></span>
</button>
```

**效果：**
- ✅ 显示钥匙图标（mdi:key-plus）
- ✅ 鼠标悬停显示"更换激活码"提示
- ✅ 点击跳转到激活码页面
- ✅ 只在已激活状态下显示

#### 2. 移动端菜单

**位置：** 移动端汉堡菜单中，在激活码状态下方

**菜单项设计：**
```vue
<!-- 分隔线 -->
<div v-if="hasActivation" class="popover-divider"></div>

<!-- 激活码状态（移动端） -->
<div v-if="hasActivation && activationStatus" class="popover-item activation-status-mobile">
  <span class="iconify" data-icon="mdi:key-variant" data-width="18" data-height="18"></span>
  <span>激活码剩余：{{ activationStatus.daysLeft }}天 · 今日：{{ activationStatus.remainingToday }}/{{ activationStatus.dailyLimit }}</span>
</div>

<!-- 更换激活码按钮（移动端） -->
<router-link v-if="hasActivation" to="/activation" class="popover-item popover-action" @click="showMobileMenu = false">
  <span class="iconify" data-icon="mdi:key-plus" data-width="18" data-height="18"></span>
  <span>更换激活码</span>
</router-link>
```

**效果：**
- ✅ 与其他菜单项分隔开（使用分隔线）
- ✅ 显示钥匙图标和"更换激活码"文字
- ✅ 使用主题色高亮显示
- ✅ 点击后关闭菜单并跳转

#### 3. 激活码页面提示

**优化内容：** 在激活码页面的帮助提示中添加说明

```vue
<div class="help-tips">
  <p class="tip-item">💡 每天可测评 3 次，有效期 7 天</p>
  <p class="tip-item">🕐 今日次数用完？明天 00:00 自动恢复</p>
  <p class="tip-item">🔄 想继续测试？可以随时更换新的激活码</p>
  <p class="tip-item">📧 需要帮助？请联系客服获取支持</p>
</div>
```

**效果：**
- ✅ 明确告知用户可以更换激活码
- ✅ 引导用户购买新码继续测试

## 代码实现

### 1. 添加跳转函数

**文件：** `src/components/AppHeader.vue`

```javascript
const goToActivation = () => {
  router.push('/activation')
}
```

### 2. 添加桌面端按钮

**文件：** `src/components/AppHeader.vue`

**位置：** `header-right` 区域

```vue
<!-- 更换激活码按钮（已激活状态下显示） -->
<button
  v-if="hasActivation"
  @click="goToActivation"
  class="icon-btn"
  title="更换激活码"
>
  <span class="iconify" data-icon="mdi:key-plus" data-width="20" data-height="20"></span>
</button>
```

### 3. 添加移动端菜单项

**文件：** `src/components/AppHeader.vue`

**位置：** `mobile-popover` 区域

```vue
<!-- 分隔线 -->
<div v-if="hasActivation" class="popover-divider"></div>

<!-- 激活码状态（移动端） -->
<div v-if="hasActivation && activationStatus" class="popover-item activation-status-mobile">
  <span class="iconify" data-icon="mdi:key-variant" data-width="18" data-height="18"></span>
  <span>激活码剩余：{{ activationStatus.daysLeft }}天 · 今日：{{ activationStatus.remainingToday }}/{{ activationStatus.dailyLimit }}</span>
</div>

<!-- 更换激活码按钮（移动端） -->
<router-link v-if="hasActivation" to="/activation" class="popover-item popover-action" @click="showMobileMenu = false">
  <span class="iconify" data-icon="mdi:key-plus" data-width="18" data-height="18"></span>
  <span>更换激活码</span>
</router-link>
```

### 4. 添加样式

**文件：** `src/components/AppHeader.vue`

```css
/* 移动端菜单分隔线 */
.popover-divider {
  height: 1px;
  background: var(--border);
  margin: 8px 0;
}

/* 移动端激活码状态 */
.activation-status-mobile {
  color: var(--text-secondary);
  font-size: 13px;
  cursor: default;
  padding: 10px 16px;
}

.activation-status-mobile:hover {
  background: transparent;
  color: var(--text-secondary);
}

.activation-status-mobile .iconify {
  color: var(--primary);
}

/* 移动端操作按钮（更换激活码） */
.popover-action {
  color: var(--primary);
  font-weight: 500;
}

.popover-action:hover {
  background: rgba(var(--primary-rgb), 0.1);
}
```

### 5. 优化激活码页面提示

**文件：** `src/views/ActivationPage.vue`

```vue
<div class="help-tips">
  <p class="tip-item">💡 每天可测评 3 次，有效期 7 天</p>
  <p class="tip-item">🕐 今日次数用完？明天 00:00 自动恢复</p>
  <p class="tip-item">🔄 想继续测试？可以随时更换新的激活码</p>  <!-- 新增 -->
  <p class="tip-item">📧 需要帮助？请联系客服获取支持</p>
</div>
```

## 使用流程

### 场景1：今日次数用完，想立即继续测试

```
用户流程：
1. 用户今天已经用了3次测评
2. 点击导航栏的"更换激活码"按钮（钥匙图标）
3. 跳转到激活码页面
4. 输入新购买的激活码
5. 验证成功，获得新的3次测评机会
6. 继续测试
```

### 场景2：激活码过期，想继续使用

```
用户流程：
1. 激活码已过期（7天有效期结束）
2. 尝试进入答题页，被拦截："激活码已过期"
3. 自动跳转到激活码页面
4. 看到提示："🔄 想继续测试？可以随时更换新的激活码"
5. 输入新购买的激活码
6. 获得新的7天有效期和21次使用机会
```

### 场景3：多人共享一个激活码

```
用户流程：
A用户：
- 使用激活码 CODE-A 完成测试
- 点击"更换激活码"
- 输入自己的激活码 CODE-B
- 现在使用 CODE-B 的剩余次数

B用户（另一个设备）：
- 仍然使用激活码 CODE-A
- CODE-A 的剩余次数不受影响
```

## UI 展示

### 桌面端

```
┌─────────────────────────────────────────┐
│ [Logo] 社恐测评   首页 测评 报告        │
│                  [剩余7天·今日3/3]      │
│                    [🔑] [🎨] [≡]        │  ← 钥匙图标（更换激活码）
└─────────────────────────────────────────┘
```

### 移动端菜单

```
┌─────────────────────┐
│  首页              │
│  测评              │
│  报告              │
├─────────────────────┤ ← 分隔线
│  🔑 激活码剩余：    │
│     7天 · 今日3/3  │
│  🔑 更换激活码     │ ← 主题色高亮
└─────────────────────┘
```

## 测试验证

### 测试步骤

1. **测试桌面端按钮**
   ```
   - 激活一个激活码
   - 查看导航栏是否显示钥匙图标
   - 鼠标悬停，查看是否显示"更换激活码"提示
   - 点击按钮，确认跳转到激活码页面
   ```

2. **测试移动端菜单**
   ```
   - 打开移动端视图（宽度 < 768px）
   - 点击汉堡菜单
   - 查看是否显示分隔线
   - 查看是否显示"更换激活码"菜单项
   - 点击菜单项，确认跳转到激活码页面
   ```

3. **测试更换激活码流程**
   ```
   - 激活激活码 A（每天3次）
   - 使用3次测评
   - 点击"更换激活码"
   - 输入新的激活码 B
   - 验证成功
   - 查看激活状态是否更新为激活码 B 的信息
   - 尝试进入答题页，确认可以继续测试
   ```

### 预期结果

- ✅ 已激活状态下，导航栏显示"更换激活码"按钮
- ✅ 未激活状态下，不显示"更换激活码"按钮
- ✅ 点击按钮或菜单项，正确跳转到激活码页面
- ✅ 输入新激活码后，激活状态更新为新激活码的信息
- ✅ 更换激活码后，可以立即继续测试

## 业务逻辑说明

### 激活码覆盖逻辑

当用户输入新的激活码时，系统会：

1. ✅ 验证新激活码的有效性
2. ✅ 如果验证成功，**覆盖**旧的激活码信息
3. ✅ 更新本地存储的激活码和激活状态
4. ✅ 重新计算剩余天数和每日剩余次数
5. ✅ 刷新导航栏显示的激活状态

**关键代码：** `src/utils/activation.js` 中的 `saveActivation` 函数

```javascript
export function saveActivation(code) {
  localStorage.setItem('test_activated', 'true')
  localStorage.setItem('activation_code', code)
  // 保存激活信息，覆盖旧数据
}
```

### 数据隔离

每个激活码的使用记录是独立的：

- **激活码 A**：7天有效期，每天3次，已用2次
- **激活码 B**：7天有效期，每天3次，已用0次

用户切换到激活码 B 后：
- ✅ 显示激活码 B 的剩余天数和次数
- ✅ 使用激活码 B 的配额进行测试
- ✅ 激活码 A 的剩余次数不受影响（其他用户仍可使用）

## 相关文件

1. ✅ `src/components/AppHeader.vue` - 添加更换激活码按钮（桌面端和移动端）
2. ✅ `src/views/ActivationPage.vue` - 添加帮助提示

## 总结

本次更新添加了**更换激活码**的入口，解决了用户想购买新码继续测试但没有入口的问题：

1. ✅ 桌面端导航栏添加钥匙图标按钮
2. ✅ 移动端菜单添加"更换激活码"菜单项
3. ✅ 激活码页面添加引导提示
4. ✅ 支持随时更换激活码继续测试
5. ✅ 不同激活码的使用记录互不影响

**用户体验提升：**
- 💡 今日次数用完？立即购买新码继续测试
- 💡 激活码过期？立即更换新码延长使用期
- 💡 清晰的入口和引导，无需寻找

---

**修复时间：** 2025-11-05  
**修复版本：** v1.3.0  
**测试状态：** ✅ 已完成，待测试验证

