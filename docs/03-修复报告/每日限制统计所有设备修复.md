# 每日限制统计所有设备修复

## 问题描述

用户报告：激活码 `AB12-CD34-EF56` 已经用了3次，但是用户还能进入答题页面，显示还有3次可用。

### 数据库实际情况

```sql
-- activation_codes 表
{
  "code": "AB12-CD34-EF56",
  "max_uses": 21,           -- 总共可以使用21次（7天×3次/天）
  "current_uses": 3,        -- 已经激活了3个设备
  "daily_limit": 3,         -- 每天最多3次
  "status": "active"
}

-- activation_records 表（4条记录）
{
  "id": 9,
  "user_device_id": "device_1762333102686_x3tcdm4av",
  "usage_by_date": "{}",                    -- 空，今天没用过
  "usage_count": 0
},
{
  "id": 10,
  "user_device_id": "device_1762333185998_9ah485fgf",
  "usage_by_date": "{\"2025-11-05\":2}",   -- 今天用了2次 ✅
  "usage_count": 2
},
{
  "id": 11,
  "user_device_id": "device_1762333450391_w59qp1fh8",
  "usage_by_date": "{}",                    -- 空，今天没用过
  "usage_count": 0
},
{
  "id": 12,
  "user_device_id": "device_1762333886375_gdr7tbhzf",
  "usage_by_date": "{}",                    -- 空，今天没用过（用户当前设备）
  "usage_count": 0
}
```

## 根本原因

### 用户的误解

用户以为 `current_uses = 3` 表示"今天已经用了3次"，但实际上它表示"已经有3个设备激活了这个激活码"。

### 真正的问题

**原来的逻辑：** 系统只检查**当前设备**今天的使用次数

```javascript
// ❌ 错误逻辑：只检查当前设备
const usageByDate = JSON.parse(rec.usage_by_date || '{}')
const usedToday = usageByDate[today] || 0  // 当前设备今天用了0次
const remainingToday = Math.max(0, dailyLimit - usedToday)  // 3 - 0 = 3
```

**应该的逻辑：** 检查**所有设备**今天的总使用次数

```javascript
// ✅ 正确逻辑：统计所有设备
let totalUsedToday = 0
for (const record of allRecords) {
  const usageByDate = JSON.parse(record.usage_by_date || '{}')
  totalUsedToday += (usageByDate[today] || 0)
}
// totalUsedToday = 0 + 2 + 0 + 0 = 2 ✅
const remainingToday = Math.max(0, dailyLimit - totalUsedToday)  // 3 - 2 = 1 ✅
```

### 为什么会出现这个问题？

1. 用户使用了一个**新设备**（或者清除了浏览器缓存）
2. 系统为这个新设备创建了一个新的激活记录（ID=12）
3. 这个新记录的 `usage_by_date` 是空的 `{}`
4. 系统只检查当前设备的使用次数，所以显示还有3次可用
5. 但实际上，ID=10 的设备今天已经用了2次，所以整个激活码今天只剩1次

## 修复方案

### 修复1：`getActivationStatusByCode` 函数

**文件：** `backend/activationService.js`

**修改位置：** `getActivationStatusByCode` 函数

**修改内容：** 统计所有设备在今天的总使用次数

```javascript
async function getActivationStatusByCode(codeWithHyphen, deviceId) {
  // ... 前面的代码保持不变 ...
  
  const today = new Date().toISOString().split('T')[0]
  
  // 🔧 【重要】统计这个激活码在所有设备上今天的总使用次数
  const [allRecords] = await pool.query(
    'SELECT usage_by_date FROM activation_records WHERE activation_code = ?',
    [norm]
  )
  
  let totalUsedToday = 0
  for (const record of allRecords) {
    const usageByDate = JSON.parse(record.usage_by_date || '{}')
    totalUsedToday += (usageByDate[today] || 0)
  }
  
  console.log(`📊 [激活状态] 激活码 ${norm} 今天所有设备总共使用了 ${totalUsedToday} 次`)
  
  const dailyLimit = ac.daily_limit || 3
  const remainingToday = Math.max(0, dailyLimit - totalUsedToday)  // ✅ 使用总次数计算

  return {
    success: true,
    daysLeft,
    remainingToday,  // ✅ 返回正确的剩余次数
    expired,
    dailyLimit,
    expiresAt,
    totalUsage: rec.usage_count || 0
  }
}
```

### 修复2：`recordUsage` 函数

**文件：** `backend/activationService.js`

**修改位置：** `recordUsage` 函数

**修改内容：** 在记录使用前，检查所有设备的总使用次数

```javascript
async function recordUsage(recordId) {
  // ... 前面的代码保持不变 ...
  
  // 🔒 【重要】检查这个激活码在所有设备上今日使用次数是否已达上限
  const [allRecordsForCode] = await pool.query(
    'SELECT usage_by_date FROM activation_records WHERE code_id = ?',
    [record.code_id]
  );
  
  let totalUsedToday = 0;
  for (const rec of allRecordsForCode) {
    const usageByDate = JSON.parse(rec.usage_by_date || '{}');
    totalUsedToday += (usageByDate[today] || 0);
  }
  
  console.log(`📊 [记录使用前检查] 激活码今天所有设备总共使用了 ${totalUsedToday}/${dailyLimit} 次`);
  
  if (totalUsedToday >= dailyLimit) {
    return { 
      success: false, 
      error: `今日使用次数已达上限（${dailyLimit}次）`,
      remainingToday: 0,
      dailyLimit
    };
  }
  
  // 获取当前设备的使用记录
  const usageByDate = JSON.parse(record.usage_by_date || '{}');
  const currentDeviceUsedToday = usageByDate[today] || 0;
  
  // 通过检查，记录使用（在当前设备的记录上+1）
  usageByDate[today] = currentDeviceUsedToday + 1;
  
  // 更新记录
  await pool.query(/* ... */);
  
  // 计算剩余天数和次数（基于所有设备的总使用次数）
  const daysLeft = Math.max(0, Math.ceil(msLeft / (24 * 60 * 60 * 1000)));
  const newTotalUsedToday = totalUsedToday + 1; // 加上刚才记录的这一次
  const remainingToday = Math.max(0, dailyLimit - newTotalUsedToday);  // ✅ 使用总次数计算
  
  console.log(`✅ [记录使用] 成功！所有设备今日已用 ${newTotalUsedToday}/${dailyLimit} 次，剩余 ${remainingToday} 次`);
  
  return { 
    success: true,
    daysLeft,
    remainingToday,  // ✅ 返回正确的剩余次数
    expired,
    expiresAt: record.expires_at,
    recorded: true
  };
}
```

## 修复效果

### 修复前

```
用户情况：
- 设备A今天用了2次
- 设备B今天用了0次（用户当前设备）

系统检查：
- 只检查设备B：usedToday = 0
- remainingToday = 3 - 0 = 3 ❌

结果：
- 用户看到"剩余3次"
- 用户可以进入答题页面
- 实际上应该只剩1次（3 - 2 = 1）
```

### 修复后

```
用户情况：
- 设备A今天用了2次
- 设备B今天用了0次（用户当前设备）

系统检查：
- 统计所有设备：totalUsedToday = 2 + 0 = 2 ✅
- remainingToday = 3 - 2 = 1 ✅

结果：
- 用户看到"剩余1次"
- 如果用户已经用了3次，remainingToday = 0
- 用户无法进入答题页面
```

## 数据库设计说明

### activation_codes 表

| 字段 | 含义 | 示例值 |
|------|------|--------|
| `max_uses` | 总共可以激活多少个设备 | 21（允许21个设备激活） |
| `current_uses` | 已经激活了多少个设备 | 3（已经有3个设备激活） |
| `daily_limit` | 每天最多使用次数（所有设备共享） | 3（每天最多3次） |

### activation_records 表

| 字段 | 含义 | 示例值 |
|------|------|--------|
| `user_device_id` | 设备ID | `device_xxx` |
| `usage_by_date` | 每天的使用次数 | `{"2025-11-05": 2}` |
| `usage_count` | 总共使用了多少次 | 2 |

### 每日限制的计算方式

```
每日剩余次数 = daily_limit - SUM(所有设备今天的使用次数)
              = 3 - (设备A今天用了2次 + 设备B今天用了0次 + ...)
              = 3 - 2
              = 1
```

## 测试验证

### 测试步骤

1. **准备数据**
   ```sql
   -- 激活码 AB12-CD34-EF56，每天限制3次
   -- 设备A今天用了2次
   -- 设备B今天用了0次（当前设备）
   ```

2. **测试场景1：查看激活状态**
   ```
   用户在设备B查看状态
   期望结果：显示"剩余1次"
   ```

3. **测试场景2：尝试答题**
   ```
   用户在设备B点击"开始测评"
   期望结果：允许进入（还剩1次）
   ```

4. **测试场景3：完成测评**
   ```
   用户在设备B完成测评
   期望结果：
   - 记录成功
   - 显示"剩余0次"
   ```

5. **测试场景4：再次尝试答题**
   ```
   用户在任意设备点击"开始测评"
   期望结果：
   - 拦截进入
   - 提示"今日3次已用完"
   ```

### 预期结果

- ✅ 激活状态显示正确的剩余次数（所有设备总计）
- ✅ 达到每日限制后，任何设备都无法进入答题页面
- ✅ 记录使用时正确检查所有设备的总使用次数
- ✅ 后台显示的使用次数与实际情况一致

## 相关文件

- `backend/activationService.js` - 修改了 `getActivationStatusByCode` 和 `recordUsage` 函数

## 总结

本次修复解决了**每日限制只检查当前设备**的问题，改为**统计所有设备的总使用次数**，确保：

1. ✅ 无论用户切换多少个设备，每日限制都严格生效
2. ✅ 激活状态显示的剩余次数是所有设备共享的总次数
3. ✅ 防止用户通过切换设备绕过每日限制

---

**修复时间：** 2025-11-05  
**修复版本：** v1.2.1  
**测试状态：** ✅ 已修复，待测试验证

