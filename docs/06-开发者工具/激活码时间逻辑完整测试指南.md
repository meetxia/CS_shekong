# 激活码时间逻辑完整测试指南

## 📋 测试目标

验证激活码系统是否符合以下需求：
1. ✅ 创建7天激活码，每天只能用3次
2. ✅ 用户激活时，激活码开始倒计时
3. ✅ 后台计算时间
4. ✅ 每次测试扣一次测试次数
5. ✅ 每天最多只能测试3次
6. ✅ 时间结束后激活码失效

---

## 🔧 准备工作

### 1. 确保后端服务运行

```powershell
cd backend
npm run dev
```

确认控制台输出：
```
✅ MySQL 连接成功
🚀 后端服务已启动: http://localhost:3001
```

### 2. 确保前端服务运行

```powershell
npm run dev
```

确认控制台输出：
```
VITE ready in xxx ms
➜  Local:   http://localhost:5173/
```

### 3. 检查数据库连接

运行检查脚本：
```powershell
cd backend
node -e "const {pool} = require('./db'); pool.query('SELECT 1', (err) => { if(err) console.error('❌', err); else console.log('✅ 数据库连接正常'); process.exit(); })"
```

---

## 📊 第一步：数据库诊断

### 1.1 运行诊断脚本

使用 MySQL 客户端或 phpMyAdmin 执行：
```sql
source docs/06-数据库脚本/检查激活码时间逻辑.sql
```

或者在 MySQL Workbench 中打开并执行该文件。

### 1.2 检查输出结果

查看以下关键输出：

#### ✅ 正常情况：
- 激活码配置中 `validity_days = 7`，`daily_limit = 3`
- 激活记录中 `实际计算天数 = 7`，状态为 `✅ 正常`
- 无 `❌ 缺失过期时间` 的记录
- 无 `⚠️ 天数不匹配` 的记录

#### ❌ 异常情况：
如果发现以下问题：
- `❌ 缺失过期时间`：激活记录的 expires_at 为 NULL
- `⚠️ 天数不匹配`：实际天数与配置不符
- `❌ 激活码状态未更新`：已过期但状态还是 active

**解决方案**：执行修复脚本（见下一步）

---

## 🛠️ 第二步：修复数据问题（如果有）

### 2.1 备份数据库

```powershell
# Windows PowerShell
mysqldump -u root -p shekong_ai > backup_before_fix.sql
```

输入 MySQL 密码后，会在当前目录生成备份文件。

### 2.2 执行修复脚本

```sql
source docs/06-数据库脚本/修复激活码时间数据.sql
```

### 2.3 验证修复结果

检查输出中的验证部分，确保所有项显示 `✅ 正常`。

---

## 🧪 第三步：完整功能测试

### 测试场景1：创建新激活码

#### 步骤1：登录管理后台
1. 访问 `http://localhost:5173/#/admin/login`
2. 输入用户名 `admin`，密码 `admin123`
3. 点击登录

#### 步骤2：创建激活码
1. 进入【激活码管理】页面
2. 点击【➕ 新建激活码】
3. 检查默认值：
   - ✅ 有效天数：`7` 天
   - ✅ 每日上限：`3` 次/天
   - ✅ 最大使用次数：`21` 次（7天 × 3次/天）
4. 填写备注：`测试激活码 - 验证时间逻辑`
5. 点击【保存】
6. **记录生成的激活码**，例如：`AB12-CD34-EF56`

#### 步骤3：数据库验证
```sql
SELECT 
    code, 
    validity_days, 
    daily_limit, 
    max_uses, 
    status 
FROM activation_codes 
WHERE notes LIKE '%测试激活码%'
ORDER BY created_at DESC 
LIMIT 1;
```

**预期结果**：
```
code: AB12-CD34-EF56
validity_days: 7
daily_limit: 3
max_uses: 21
status: active
```

---

### 测试场景2：用户首次激活（时间倒计时开始）

#### 步骤1：用户端激活
1. 打开浏览器隐私/无痕模式（模拟新设备）
2. 访问 `http://localhost:5173/#/activation`
3. 输入激活码 `AB12-CD34-EF56`
4. 点击【激活】

#### 步骤2：验证激活成功
- ✅ 页面显示：`激活成功！您有 7 天使用期限，每天可测评 3 次`
- ✅ 自动跳转到首页
- ✅ 导航栏显示：`剩余 7 天 · 今日 3 次`

#### 步骤3：数据库验证
```sql
SELECT 
    ar.activation_code,
    ar.activated_at AS '激活时间',
    ar.expires_at AS '过期时间',
    TIMESTAMPDIFF(DAY, ar.activated_at, ar.expires_at) AS '有效天数',
    TIMESTAMPDIFF(DAY, NOW(), ar.expires_at) AS '剩余天数',
    ar.usage_count AS '已使用次数',
    ar.usage_by_date AS '每日使用记录'
FROM activation_records ar
WHERE ar.activation_code = 'AB12-CD34-EF56'
ORDER BY ar.activated_at DESC 
LIMIT 1;
```

**预期结果**：
```
激活时间: 2025-11-05 14:30:00
过期时间: 2025-11-12 14:30:00  -- ✅ 激活时间 + 7天
有效天数: 7                      -- ✅ 准确7天
剩余天数: 7                      -- ✅ 刚激活，剩余7天
已使用次数: 0                    -- ✅ 尚未使用
每日使用记录: {}                 -- ✅ 空对象
```

**✅ 验证通过**：时间从用户激活时刻开始倒计时！

---

### 测试场景3：第一次测评（扣除次数）

#### 步骤1：完成测评
1. 在激活的浏览器中，点击【开始测评】
2. 随机回答所有题目
3. 填写基本信息（昵称、性别、年龄）
4. 点击【提交测评】

#### 步骤2：验证扣次数提示
- ✅ 页面显示：`测试完成！今日剩余 2 次 · 剩余 7 天`
- ✅ 导航栏更新为：`剩余 7 天 · 今日 2 次`

#### 步骤3：数据库验证
```sql
SELECT 
    activation_code,
    usage_count AS '总使用次数',
    usage_by_date AS '每日使用记录',
    last_used_at AS '最后使用时间'
FROM activation_records
WHERE activation_code = 'AB12-CD34-EF56';
```

**预期结果**：
```
总使用次数: 1
每日使用记录: {"2025-11-05": 1}  -- ✅ 今日使用1次
最后使用时间: 2025-11-05 14:35:00
```

**✅ 验证通过**：成功扣除1次使用次数！

---

### 测试场景4：今日使用3次后限制

#### 步骤1：继续测评
1. 重复测评流程 2 次（第2次、第3次）
2. 观察每次的提示

**预期提示**：
- 第2次：`测试完成！今日剩余 1 次 · 剩余 7 天`
- 第3次：`测试完成！今日剩余 0 次 · 剩余 7 天`

#### 步骤2：尝试第4次测评
1. 点击【开始测评】
2. 尝试提交

**预期结果**：
- ❌ 提交失败
- ❌ 提示：`今日测评次数已用完，明天再来吧～`
- ℹ️ 提示：`每天可测评 3 次，明天 00:00 自动恢复`

#### 步骤3：数据库验证
```sql
SELECT 
    usage_count AS '总使用次数',
    usage_by_date AS '每日使用记录'
FROM activation_records
WHERE activation_code = 'AB12-CD34-EF56';
```

**预期结果**：
```
总使用次数: 3
每日使用记录: {"2025-11-05": 3}  -- ✅ 今日达到上限
```

**✅ 验证通过**：每日3次限制生效！

---

### 测试场景5：第二天自动恢复

#### 方法1：修改系统时间（测试环境）

**⚠️ 警告**：此方法会影响系统时间，请谨慎使用！

```powershell
# Windows PowerShell（需管理员权限）
# 将系统时间前进1天
$tomorrow = (Get-Date).AddDays(1)
Set-Date -Date $tomorrow
```

然后刷新页面，尝试测评。

**完成测试后恢复时间**：
```powershell
# 同步到网络时间
w32tm /resync
```

#### 方法2：手动修改数据库（推荐）

```sql
-- 将今日使用记录改为昨天
UPDATE activation_records
SET usage_by_date = '{"2025-11-04": 3}'  -- 修改为昨天的日期
WHERE activation_code = 'AB12-CD34-EF56';
```

#### 步骤：验证恢复
1. 刷新页面
2. 导航栏应显示：`剩余 7 天 · 今日 3 次` ✅
3. 可以继续测评

**✅ 验证通过**：每日次数自动恢复！

---

### 测试场景6：时间过期（7天后）

#### 方法1：修改数据库（推荐）

```sql
-- 将过期时间改为过去
UPDATE activation_records
SET expires_at = DATE_SUB(NOW(), INTERVAL 1 DAY)  -- 设置为昨天
WHERE activation_code = 'AB12-CD34-EF56';
```

#### 步骤：验证过期
1. 刷新页面
2. 导航栏应显示：`已过期 ❌`
3. 尝试测评

**预期结果**：
- ❌ 提交失败
- ❌ 提示：`您的激活已过期`
- ℹ️ 提示：`激活码有效期为 7 天，请联系客服获取新的激活码`

#### 步骤：数据库验证
```sql
SELECT 
    activation_code,
    expires_at AS '过期时间',
    TIMESTAMPDIFF(DAY, NOW(), expires_at) AS '剩余天数',
    CASE 
        WHEN expires_at < NOW() THEN '❌ 已过期'
        ELSE '✅ 有效'
    END AS '状态'
FROM activation_records
WHERE activation_code = 'AB12-CD34-EF56';
```

**预期结果**：
```
过期时间: 2025-11-04 14:30:00
剩余天数: -1
状态: ❌ 已过期
```

**✅ 验证通过**：过期后无法使用！

---

## 📈 第四步：压力测试

### 测试场景7：边界情况

#### 1. 最后一天测试
```sql
-- 设置为还剩1天
UPDATE activation_records
SET expires_at = DATE_ADD(NOW(), INTERVAL 1 DAY)
WHERE activation_code = 'AB12-CD34-EF56';
```

验证：
- ✅ 导航栏显示：`剩余 1 天 · 今日 3 次`
- ✅ 可以正常测评

#### 2. 最后1小时测试
```sql
-- 设置为还剩1小时
UPDATE activation_records
SET expires_at = DATE_ADD(NOW(), INTERVAL 1 HOUR)
WHERE activation_code = 'AB12-CD34-EF56';
```

验证：
- ✅ 导航栏显示：`剩余 1 天 · 今日 3 次`（向上取整）
- ✅ 可以正常测评

#### 3. 刚好过期时刻
```sql
-- 设置为刚好过期（误差1秒）
UPDATE activation_records
SET expires_at = NOW()
WHERE activation_code = 'AB12-CD34-EF56';
```

验证：
- ❌ 无法测评
- ❌ 提示：`您的激活已过期`

---

## 🎯 第五步：完整流程验证

### 创建新设备完整测试

1. **清空浏览器数据**（模拟新设备）
   - 清除 localStorage
   - 或使用新的无痕窗口

2. **激活新激活码**
   - 记录激活时间：`2025-11-05 15:00:00`
   - 预期过期时间：`2025-11-12 15:00:00`（+7天）

3. **测试第1天**（11-05）
   - 测试3次：`usage_by_date = {"2025-11-05": 3}`
   - 剩余：`7天 · 今日0次`

4. **测试第2天**（11-06）
   - 测试2次：`usage_by_date = {"2025-11-05": 3, "2025-11-06": 2}`
   - 剩余：`6天 · 今日1次`

5. **测试第7天**（11-11）
   - 测试1次：`usage_by_date = {..., "2025-11-11": 1}`
   - 剩余：`1天 · 今日2次`

6. **测试第8天**（11-12）
   - 已过期：无法测评
   - 提示：`您的激活已过期`

**✅ 如果所有步骤都符合预期，说明系统完全正常！**

---

## 📋 测试检查清单

- [ ] ✅ 创建激活码时，validity_days=7, daily_limit=3
- [ ] ✅ 用户激活时，expires_at = activated_at + 7天
- [ ] ✅ 每次测评扣除1次，usage_count +1
- [ ] ✅ 每日使用记录正确统计（usage_by_date）
- [ ] ✅ 今日使用3次后无法再测试
- [ ] ✅ 第二天0点后自动恢复3次
- [ ] ✅ 剩余天数实时计算正确
- [ ] ✅ 过期后无法继续使用
- [ ] ✅ 导航栏显示实时更新
- [ ] ✅ 错误提示友好清晰

---

## 🐛 常见问题排查

### 问题1：导航栏不显示剩余次数

**原因**：前端未调用后端API获取最新状态

**检查**：
1. 打开浏览器控制台（F12）
2. 查找日志：`[getActivationStatus] 调用本地后端`
3. 检查网络请求：`POST /api/activation/status`

**解决方案**：
- 刷新页面
- 检查后端服务是否运行
- 检查 localStorage 中是否有 `activation_code`

---

### 问题2：扣次数不生效

**原因**：recordUsage API调用失败

**检查**：
1. 查看控制台日志：`[扣次数] 调用本地后端记录使用次数...`
2. 检查网络请求：`POST /api/activation/record-usage`
3. 查看响应：`{ success: true, remainingToday: 2, daysLeft: 7 }`

**解决方案**：
- 检查 localStorage 中是否有 `recordId`
- 查看数据库 activation_records 表
- 查看后端日志

---

### 问题3：时间不准确

**原因**：时区问题或数据库时间不同步

**检查**：
```sql
-- 检查数据库时间
SELECT NOW() AS '数据库时间';

-- 检查激活记录的时间
SELECT 
    activated_at,
    expires_at,
    TIMESTAMPDIFF(HOUR, activated_at, expires_at) AS '小时差'
FROM activation_records
WHERE activation_code = 'AB12-CD34-EF56';
```

**解决方案**：
- 确保服务器、数据库、客户端时间一致
- 使用 UTC 时间（需修改代码）

---

### 问题4：每日次数未重置

**原因**：日期计算使用本地时区，可能跨时区

**检查**：
```javascript
// 前端控制台执行
const today = new Date().toISOString().split('T')[0]
console.log('今日日期:', today)  // 应该是 2025-11-05

const usage = JSON.parse(localStorage.getItem('activation_usage'))
console.log('使用记录:', usage.usageByDate)
```

**解决方案**：
- 确保前后端使用相同的日期格式
- 等待0点后刷新页面

---

## ✅ 测试结论

如果所有测试场景都通过，说明激活码系统的时间逻辑**完全正确**，符合以下需求：

1. ✅ 创建7天激活码，每天3次
2. ✅ 用户激活时开始倒计时
3. ✅ 后台实时计算时间
4. ✅ 每次测试扣除1次
5. ✅ 每天最多3次
6. ✅ 时间结束后失效

**系统逻辑设计完善，实现正确！** 🎉

