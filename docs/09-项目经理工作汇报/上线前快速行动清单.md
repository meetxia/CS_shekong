# 🚀 项目上线前快速行动清单

> **目标**: 在15个工作日内完成所有必须项（P0），使项目达到可上线状态

---

## 📅 第1-2天：环境配置和安全加固

### Day 1 上午 - 环境变量配置

**后端环境变量**
```bash
# 在 backend/ 目录创建 .env.example
cd backend
```

创建文件 `backend/.env.example`:
```env
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=请填写数据库密码
DB_NAME=shekong_ai

# Claude API配置
CLAUDE_API_KEY=请填写Claude API Key
CLAUDE_API_URL=https://dpapi.cn/v1/chat/completions
CLAUDE_MODEL=claude-4.5-sonnet

# 服务器配置
PORT=3001
NODE_ENV=production

# 管理员配置（首次初始化用）
ADMIN_USERNAME=admin
ADMIN_PASSWORD=请设置强密码
ADMIN_NICKNAME=系统管理员
```

**前端环境变量**

创建文件 `.env.example`:
```env
# Supabase配置（如果使用）
VITE_SUPABASE_URL=请填写Supabase URL
VITE_SUPABASE_ANON_KEY=请填写Supabase Anon Key

# 后端API地址
VITE_API_BASE_URL=http://localhost:3001/api
```

创建文件 `.env.development`:
```env
VITE_API_BASE_URL=http://localhost:3001/api
```

创建文件 `.env.production`:
```env
VITE_API_BASE_URL=https://your-domain.com/api
```

### Day 1 下午 - 移除硬编码配置

**需要修改的文件**:

1. `backend/initDb.js` (第16行)
```javascript
// 修改前
password: process.env.DB_PASSWORD || 'mojz168168',

// 修改后
password: process.env.DB_PASSWORD,
```

2. `backend/aiConfigService.js` (第63-65行)
```javascript
// 修改前
api_key: process.env.CLAUDE_API_KEY || '',

// 修改后 - 如果没有配置则抛出错误
if (!process.env.CLAUDE_API_KEY) {
  throw new Error('CLAUDE_API_KEY environment variable is required');
}
api_key: process.env.CLAUDE_API_KEY,
```

3. `backend/initAdmin.js`
```javascript
// 添加环境变量验证
const requiredEnvVars = ['DB_HOST', 'DB_USER', 'DB_PASSWORD', 'DB_NAME'];
for (const envVar of requiredEnvVars) {
  if (!process.env[envVar]) {
    throw new Error(`Missing required environment variable: ${envVar}`);
  }
}
```

### Day 2 上午 - 清理开发日志

**需要清理的文件** (使用条件编译):

创建 `src/utils/logger.js`:
```javascript
export const logger = {
  log: (...args) => {
    if (import.meta.env.MODE === 'development') {
      console.log(...args);
    }
  },
  error: (...args) => {
    console.error(...args);
  },
  warn: (...args) => {
    if (import.meta.env.MODE === 'development') {
      console.warn(...args);
    }
  }
};
```

然后批量替换所有 `.vue` 文件中的 `console.log` 为 `logger.log`

**快速操作**:
```bash
# 搜索所有console.log
grep -r "console.log" src/

# 需要手动替换的文件（约25处）
src/components/AppHeader.vue
src/views/ActivationPage.vue
src/views/AssessmentPage.vue
```

### Day 2 下午 - 安全配置

**添加请求频率限制**

安装依赖:
```bash
cd backend
npm install express-rate-limit
```

修改 `backend/server.js`:
```javascript
const rateLimit = require('express-rate-limit');

// 通用限流
const generalLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分钟
  max: 100 // 最多100个请求
});

// 激活码验证限流
const activationLimiter = rateLimit({
  windowMs: 60 * 1000, // 1分钟
  max: 10 // 最多10次
});

// AI生成限流
const aiLimiter = rateLimit({
  windowMs: 60 * 1000, // 1分钟
  max: 5 // 最多5次
});

app.use('/api/', generalLimiter);
app.use('/api/activation/verify', activationLimiter);
app.use('/api/ai/generate', aiLimiter);
```

---

## 📅 第3-5天：核心功能测试

### Day 3 - 配置测试框架

**安装Vitest**:
```bash
npm install -D vitest @vue/test-utils happy-dom
```

修改 `package.json`:
```json
{
  "scripts": {
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage"
  }
}
```

修改 `vite.config.js`:
```javascript
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { resolve } from 'path'

export default defineConfig({
  plugins: [vue()],
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src')
    }
  },
  test: {
    globals: true,
    environment: 'happy-dom'
  }
})
```

### Day 4 - 编写核心测试

**创建测试文件**:

`src/utils/__tests__/activation.test.js`:
```javascript
import { describe, it, expect } from 'vitest';
import { formatActivationCode, validateActivationCode } from '../activation';

describe('激活码工具函数', () => {
  it('应该正确格式化激活码', () => {
    expect(formatActivationCode('TEST2024ABCD')).toBe('TEST-2024-ABCD');
    expect(formatActivationCode('test-2024-abcd')).toBe('TEST-2024-ABCD');
  });

  it('应该验证正确的激活码格式', () => {
    expect(validateActivationCode('TEST-2024-ABCD')).toBe(true);
    expect(validateActivationCode('1234-5678-9ABC')).toBe(true);
  });

  it('应该拒绝错误的激活码格式', () => {
    expect(validateActivationCode('TEST-2024')).toBe(false);
    expect(validateActivationCode('TEST-2024-ABC')).toBe(false);
    expect(validateActivationCode('test-2024-abcd')).toBe(false); // 小写
  });
});
```

`src/utils/__tests__/scoring.test.js`:
```javascript
import { describe, it, expect } from 'vitest';
import { calculateDimensionScores, getLevel, getType } from '../scoring';

describe('计分系统', () => {
  it('应该正确计算维度分数', () => {
    const answers = {
      q1: 5, q2: 4, q3: 3, q4: 2, q5: 1, // 维度1: 15
      q6: 3, q7: 3, q8: 3, q9: 3, q10: 3, // 维度2: 15
      // ... 其他维度
    };
    const dimensions = calculateDimensionScores(answers);
    expect(dimensions.dimension1).toBe(15);
    expect(dimensions.dimension2).toBe(15);
  });

  it('应该正确判断等级', () => {
    expect(getLevel(50).id).toBe('mild');
    expect(getLevel(75).id).toBe('moderate');
    expect(getLevel(105).id).toBe('severe');
    expect(getLevel(130).id).toBe('extreme');
  });

  it('应该正确判断社恐类型', () => {
    // 预演型测试
    const dimensions1 = {
      预期焦虑: 20,
      社交反刍: 18,
      // ... 其他维度较低
    };
    expect(getType(dimensions1, 100).id).toBe('rehearsal');
  });
});
```

### Day 5 - 后端接口测试

创建 `backend/__tests__/activation.test.js`:
```javascript
const { verifyActivationCode } = require('../activationService');

describe('激活码服务', () => {
  it('应该拒绝无效的激活码', async () => {
    const result = await verifyActivationCode('INVALID-CODE', 'device1');
    expect(result.success).toBe(false);
  });

  // 更多测试...
});
```

**运行测试**:
```bash
npm test
```

---

## 📅 第6-8天：安全测试和加固

### Day 6 - 依赖包漏洞扫描

```bash
# 检查漏洞
npm audit

# 自动修复
npm audit fix

# 查看详细报告
npm audit --json > audit-report.json
```

**如果有高危漏洞无法自动修复**:
1. 查看是否有可升级的版本
2. 寻找替代包
3. 评估风险并记录到文档

### Day 7 - SQL注入和XSS测试

**SQL注入测试清单**:
```
测试激活码验证接口:
□ code='; DROP TABLE activation_codes; --
□ code=' OR '1'='1
□ code=1' UNION SELECT * FROM admin_users --

测试管理后台接口:
□ username=admin' OR '1'='1
□ id=1 OR 1=1
```

**验证防护措施**:
- 确认所有查询使用参数化查询（已使用 `mysql2` 的 `?` 占位符）✅
- 添加输入验证中间件

**XSS测试清单**:
```
测试输入框:
□ <script>alert('XSS')</script>
□ <img src=x onerror=alert('XSS')>
□ javascript:alert('XSS')
```

**添加防护**:

创建 `backend/middleware/sanitize.js`:
```javascript
const sanitize = (req, res, next) => {
  // 清理字符串输入
  const sanitizeString = (str) => {
    if (typeof str !== 'string') return str;
    return str
      .replace(/[<>]/g, '') // 移除尖括号
      .trim();
  };

  // 递归清理对象
  const sanitizeObject = (obj) => {
    for (let key in obj) {
      if (typeof obj[key] === 'string') {
        obj[key] = sanitizeString(obj[key]);
      } else if (typeof obj[key] === 'object') {
        sanitizeObject(obj[key]);
      }
    }
    return obj;
  };

  if (req.body) {
    req.body = sanitizeObject(req.body);
  }
  
  next();
};

module.exports = sanitize;
```

在 `backend/server.js` 中使用:
```javascript
const sanitize = require('./middleware/sanitize');
app.use(sanitize);
```

### Day 8 - HTTPS和安全头配置

**创建 `nginx.conf`**:
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # 强制HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    # SSL证书
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://code.iconify.design; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:;" always;
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;
    
    # 静态文件
    location / {
        root /www/wwwroot/shekong/dist;
        try_files $uri $uri/ /index.html;
        
        # 静态资源缓存
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # API代理
    location /api/ {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

---

## 📅 第9-11天：部署配置和脚本

### Day 9 - PM2配置

创建 `backend/ecosystem.config.js`:
```javascript
module.exports = {
  apps: [{
    name: 'shekong-ai-backend',
    script: './server.js',
    instances: 2,
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3001
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss',
    merge_logs: true,
    autorestart: true,
    max_restarts: 10,
    min_uptime: '10s',
    max_memory_restart: '500M',
    watch: false
  }]
};
```

### Day 10 - 部署脚本

创建 `deploy.sh`:
```bash
#!/bin/bash

echo "========================================"
echo "社恐测评项目部署脚本"
echo "========================================"

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 检查环境变量
check_env() {
  echo -e "${YELLOW}检查环境变量...${NC}"
  
  if [ ! -f "backend/.env" ]; then
    echo -e "${RED}错误: backend/.env 文件不存在${NC}"
    echo "请复制 backend/.env.example 并配置正确的值"
    exit 1
  fi
  
  if [ ! -f ".env.production" ]; then
    echo -e "${RED}错误: .env.production 文件不存在${NC}"
    exit 1
  fi
  
  echo -e "${GREEN}✓ 环境变量检查通过${NC}"
}

# 安装依赖
install_deps() {
  echo -e "${YELLOW}安装依赖...${NC}"
  
  # 前端依赖
  npm install
  
  # 后端依赖
  cd backend
  npm install --production
  cd ..
  
  echo -e "${GREEN}✓ 依赖安装完成${NC}"
}

# 运行测试
run_tests() {
  echo -e "${YELLOW}运行测试...${NC}"
  
  npm test
  
  if [ $? -ne 0 ]; then
    echo -e "${RED}测试失败，部署终止${NC}"
    exit 1
  fi
  
  echo -e "${GREEN}✓ 测试通过${NC}"
}

# 构建前端
build_frontend() {
  echo -e "${YELLOW}构建前端...${NC}"
  
  npm run build
  
  if [ $? -ne 0 ]; then
    echo -e "${RED}构建失败${NC}"
    exit 1
  fi
  
  echo -e "${GREEN}✓ 前端构建完成${NC}"
}

# 备份旧版本
backup_old() {
  echo -e "${YELLOW}备份旧版本...${NC}"
  
  BACKUP_DIR="backups/$(date +%Y%m%d_%H%M%S)"
  mkdir -p $BACKUP_DIR
  
  if [ -d "dist" ]; then
    cp -r dist $BACKUP_DIR/
  fi
  
  echo -e "${GREEN}✓ 备份完成: $BACKUP_DIR${NC}"
}

# 部署前端
deploy_frontend() {
  echo -e "${YELLOW}部署前端...${NC}"
  
  # 复制到nginx目录（根据实际路径修改）
  NGINX_ROOT="/www/wwwroot/shekong"
  
  if [ -d "$NGINX_ROOT" ]; then
    rm -rf $NGINX_ROOT/dist
    cp -r dist $NGINX_ROOT/
    echo -e "${GREEN}✓ 前端部署完成${NC}"
  else
    echo -e "${RED}Nginx目录不存在: $NGINX_ROOT${NC}"
    exit 1
  fi
}

# 重启后端
restart_backend() {
  echo -e "${YELLOW}重启后端服务...${NC}"
  
  cd backend
  
  # 使用PM2重启
  pm2 restart ecosystem.config.js --update-env
  
  if [ $? -ne 0 ]; then
    echo -e "${RED}后端重启失败${NC}"
    exit 1
  fi
  
  cd ..
  
  echo -e "${GREEN}✓ 后端重启完成${NC}"
}

# 健康检查
health_check() {
  echo -e "${YELLOW}执行健康检查...${NC}"
  
  sleep 3
  
  # 检查后端
  HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/health)
  
  if [ "$HTTP_CODE" == "200" ]; then
    echo -e "${GREEN}✓ 后端健康检查通过${NC}"
  else
    echo -e "${RED}后端健康检查失败: HTTP $HTTP_CODE${NC}"
    exit 1
  fi
}

# 主流程
main() {
  echo ""
  check_env
  echo ""
  install_deps
  echo ""
  run_tests
  echo ""
  build_frontend
  echo ""
  backup_old
  echo ""
  deploy_frontend
  echo ""
  restart_backend
  echo ""
  health_check
  echo ""
  echo -e "${GREEN}========================================"
  echo -e "部署成功完成！"
  echo -e "========================================${NC}"
}

# 执行主流程
main
```

赋予执行权限:
```bash
chmod +x deploy.sh
```

### Day 11 - 数据库备份脚本

创建 `backend/scripts/backup-db.sh`:
```bash
#!/bin/bash

# 配置
DB_USER="root"
DB_PASS="your_password"
DB_NAME="shekong_ai"
BACKUP_DIR="/www/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/${DB_NAME}_$DATE.sql"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 执行备份
mysqldump -u$DB_USER -p$DB_PASS $DB_NAME > $BACKUP_FILE

# 压缩
gzip $BACKUP_FILE

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

echo "备份完成: ${BACKUP_FILE}.gz"
```

**设置定时任务**:
```bash
# 编辑crontab
crontab -e

# 添加每日凌晨2点备份
0 2 * * * /www/wwwroot/shekong/backend/scripts/backup-db.sh
```

---

## 📅 第12-13天：监控和告警

### Day 12 - 集成Sentry

**前端集成**:
```bash
npm install @sentry/vue
```

修改 `src/main.js`:
```javascript
import { createApp } from 'vue'
import * as Sentry from "@sentry/vue"
import App from './App.vue'
import router from './router'

const app = createApp(App)

// 生产环境启用Sentry
if (import.meta.env.PROD) {
  Sentry.init({
    app,
    dsn: "your-sentry-dsn",
    integrations: [
      new Sentry.BrowserTracing({
        routingInstrumentation: Sentry.vueRouterInstrumentation(router),
      }),
      new Sentry.Replay(),
    ],
    tracesSampleRate: 0.1,
    replaysSessionSampleRate: 0.1,
    replaysOnErrorSampleRate: 1.0,
  })
}

app.use(router)
app.mount('#app')
```

**后端集成**:
```bash
cd backend
npm install @sentry/node
```

修改 `backend/server.js`:
```javascript
const Sentry = require("@sentry/node");

// 生产环境启用Sentry
if (process.env.NODE_ENV === 'production') {
  Sentry.init({
    dsn: process.env.SENTRY_DSN,
    tracesSampleRate: 0.1,
  });
  
  app.use(Sentry.Handlers.requestHandler());
  app.use(Sentry.Handlers.tracingHandler());
}

// ... 其他代码 ...

// 错误处理（放在最后）
if (process.env.NODE_ENV === 'production') {
  app.use(Sentry.Handlers.errorHandler());
}
```

### Day 13 - 性能监控

创建 `backend/middleware/performance.js`:
```javascript
const performance = (req, res, next) => {
  const startTime = Date.now();
  
  res.on('finish', () => {
    const duration = Date.now() - startTime;
    
    // 记录慢请求（超过1秒）
    if (duration > 1000) {
      console.warn(`慢请求: ${req.method} ${req.path} - ${duration}ms`);
    }
    
    // 可以发送到监控系统
    // sendToMonitoring({
    //   method: req.method,
    //   path: req.path,
    //   duration,
    //   status: res.statusCode
    // });
  });
  
  next();
};

module.exports = performance;
```

使用:
```javascript
const performance = require('./middleware/performance');
app.use(performance);
```

---

## 📅 第14-15天：文档和最终检查

### Day 14 - 完善运维文档

创建 `docs/DEPLOYMENT.md`:
```markdown
# 部署手册

## 前置要求

- Node.js 16+
- MySQL 5.7+
- Nginx 1.18+
- PM2（全局安装）

## 部署步骤

### 1. 服务器准备

### 2. 环境配置

### 3. 数据库初始化

### 4. 部署应用

### 5. 配置Nginx

### 6. 启动服务

## 验证

## 常见问题
```

创建 `docs/OPERATION.md`:
```markdown
# 运维手册

## 日常巡检

## 常见问题处理

## 应急预案

## 备份恢复
```

### Day 15 - 最终检查

**使用此清单进行最终检查**:

```
环境配置 ✓
□ .env文件配置正确
□ 无硬编码密码
□ API密钥已配置

安全性 ✓
□ npm audit 无高危漏洞
□ HTTPS配置正确
□ 安全头配置完整
□ 请求频率限制生效
□ 输入验证完整

功能测试 ✓
□ 激活码验证正常
□ 测评流程完整
□ AI生成正常
□ 管理后台正常
□ 报告展示正确

性能测试 ✓
□ 首屏加载<2秒
□ 接口响应<200ms
□ 并发支持100+用户

部署准备 ✓
□ 部署脚本测试通过
□ 备份机制运行正常
□ PM2配置正确
□ Nginx配置正确

监控告警 ✓
□ Sentry正常工作
□ 日志输出正常
□ 性能监控生效

文档完整 ✓
□ 部署文档完整
□ 运维文档完整
□ API文档完整
□ 用户协议准备
```

---

## 🎯 快速参考

### 关键命令

```bash
# 安装依赖
npm install
cd backend && npm install

# 运行测试
npm test

# 构建生产版本
npm run build

# 启动后端（开发）
cd backend && npm run dev

# 启动后端（生产）
cd backend && pm2 start ecosystem.config.js

# 部署
./deploy.sh

# 查看日志
pm2 logs shekong-ai-backend

# 数据库备份
./backend/scripts/backup-db.sh
```

### 关键文件位置

- 环境变量: `.env`, `backend/.env`
- Nginx配置: `nginx.conf`
- PM2配置: `backend/ecosystem.config.js`
- 部署脚本: `deploy.sh`
- 备份脚本: `backend/scripts/backup-db.sh`

### 应急联系

- 技术负责人: xxx
- 运维负责人: xxx
- 产品负责人: xxx

---

**最后更新**: 2025-11-07  
**负责人**: 项目经理  
**状态**: Ready for Production ✅
