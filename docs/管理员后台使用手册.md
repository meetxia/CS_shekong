# 管理员后台使用手册

## 🚀 快速开始

### 访问地址
- **管理后台**: http://localhost:5173/admin
- **后端API**: http://localhost:3001

## 📊 功能导航

### 1. 数据总览 (`/admin/dashboard`)

展示系统的整体运营数据：
- **激活码总数**: 系统中所有激活码的总数
- **启用中**: 当前可用的激活码数量
- **已过期**: 超过有效期的激活码数量
- **已撤销**: 被管理员手动撤销的激活码数量
- **总激活次数**: 激活码被用户激活的总次数
- **总使用次数**: 用户使用测评功能的总次数

**按激活码统计表**：展示每个激活码的详细使用情况

---

## 🎫 激活码管理 (`/admin/codes`)

### 功能概览

#### 1️⃣ 查询与筛选

**搜索框**：
- 输入激活码或备注关键词
- 按 `Enter` 键搜索

**状态筛选**：
- `active` - 有效激活码
- `expired` - 已过期
- `revoked` - 已撤销
- `used` - 使用次数已达上限
- `all` - 全部状态

#### 2️⃣ 新建单个激活码

点击 **"新建激活码"** 按钮：

**配置项说明**：
- **激活码**: 留空则自动生成（格式：XXXX-XXXX-XXXX）
- **最大使用次数**: 该激活码最多可被多少个设备激活（默认：21）
- **有效天数**: 激活后的有效期天数（默认：7天）
- **每日上限**: 每个激活用户每天可测评的次数（默认：3次）
- **过期时间**: 可选，设置激活码的绝对过期时间
- **备注**: 可选，用于标记激活码用途（如：学校A班级、企业B部门等）

**示例配置**：
```
激活码: 留空（自动生成）
最大使用次数: 50
有效天数: 30
每日上限: 5
备注: 2025年春季班
```

#### 3️⃣ 批量新建激活码

点击 **"批量新建"** 按钮：

**方式一：自动生成**
1. 设置批量参数（最大使用、有效天数、每日上限）
2. 输入生成数量（如：10）
3. 点击 **"生成并填入"** 按钮
4. 系统自动生成激活码列表
5. 点击 **"提交创建"**

**方式二：手动输入**
1. 在文本框中每行输入一个激活码
2. 格式：`XXXX-XXXX-XXXX`
3. 点击 **"提交创建"**

**示例**：批量生成100个激活码，供某学校使用
```
批量参数：
- 最大使用次数: 1（每个激活码只能一人使用）
- 有效天数: 90（3个月有效期）
- 每日上限: 3（每天最多测3次）

自动生成数量: 100
```

#### 4️⃣ 编辑激活码

点击表格中的 **"编辑"** 按钮：
- 可修改：最大使用次数、有效天数、每日上限、过期时间、备注
- **注意**：激活码本身（code）不建议修改

#### 5️⃣ 撤销激活码

点击表格中的 **"撤销"** 按钮：
- 激活码状态变为 `revoked`
- 用户将无法使用该激活码
- **使用场景**：发现某激活码被滥用、需要临时禁用等

#### 6️⃣ 删除激活码

点击表格中的 **"删除"** 按钮：
- ⚠️ **危险操作**：将永久删除激活码及相关记录
- 确认后不可恢复
- **建议**：通常使用"撤销"而非"删除"

---

## 📋 常见使用场景

### 场景1：为学校班级发放激活码

**需求**：某学校有3个班级，每班30人，需要发放激活码

**操作步骤**：
1. 进入 `/admin/codes`
2. 点击"批量新建"
3. 配置：
   ```
   最大使用次数: 1（一人一码）
   有效天数: 180（半年有效期）
   每日上限: 3
   ```
4. 自动生成数量：90
5. 点击"生成并填入" → "提交创建"
6. 导出激活码列表（可手动复制表格数据）

### 场景2：发放企业团队测评码

**需求**：企业50人团队，允许多次测评

**操作步骤**：
1. 新建单个激活码
2. 配置：
   ```
   最大使用次数: 100（允许多人多次使用）
   有效天数: 365（一年有效期）
   每日上限: 10
   备注: XX企业2025年度心理健康测评
   ```
3. 保存后将该激活码分享给企业

### 场景3：临时禁用某激活码

**需求**：发现某激活码被恶意传播，需要立即禁用

**操作步骤**：
1. 在激活码列表中搜索该激活码
2. 点击"撤销"按钮
3. 确认后，该激活码立即失效

### 场景4：查看激活码使用情况

**操作步骤**：
1. 进入 `/admin/dashboard`
2. 查看"按激活码统计"表格
3. 关注以下指标：
   - **激活次数**：有多少设备激活了该码
   - **总使用次数**：用户实际测评的次数
   - **当前使用/最大使用**：使用率

---

## 🔧 数据库直接操作（高级）

如需直接操作数据库，可使用以下SQL：

### 查询所有有效激活码
```sql
SELECT code, status, current_uses, max_uses, expires_at, notes
FROM activation_codes
WHERE status = 'active'
ORDER BY created_at DESC;
```

### 查询某激活码的激活记录
```sql
SELECT ar.*, ac.notes
FROM activation_records ar
JOIN activation_codes ac ON ar.code_id = ac.id
WHERE ar.activation_code = 'XXXX-XXXX-XXXX'
ORDER BY ar.activated_at DESC;
```

### 统计每天的测评次数
```sql
SELECT DATE(created_at) as date, COUNT(*) as count
FROM reports
GROUP BY DATE(created_at)
ORDER BY date DESC
LIMIT 30;
```

### 重置某激活码的使用次数
```sql
UPDATE activation_codes
SET current_uses = 0, status = 'active'
WHERE code = 'XXXX-XXXX-XXXX';
```

---

## 🚨 注意事项

### 安全建议
1. **管理后台暂无认证机制**：
   - ⚠️ 生产环境请务必添加登录认证
   - 建议：IP白名单、管理员账号密码、JWT Token等

2. **数据备份**：
   - 定期备份 `activation_codes`、`activation_records`、`reports` 表
   - 使用 `mysqldump` 或数据库管理工具

3. **激活码安全**：
   - 避免在公开场合分享激活码
   - 对不同场景使用不同的激活码，便于追踪

### 性能优化
1. **大量激活码场景**：
   - 数据库表已添加索引（`idx_code`、`idx_status`等）
   - 分页查询避免一次加载过多数据

2. **统计数据缓存**：
   - 如统计数据计算较慢，可考虑添加 Redis 缓存

---

## 🛠️ API接口文档

### 管理端API列表

| 方法 | 路径 | 说明 |
|-----|------|------|
| GET | `/api/admin/codes` | 获取激活码列表 |
| POST | `/api/admin/codes` | 创建单个激活码 |
| POST | `/api/admin/codes/bulk` | 批量创建激活码 |
| PUT | `/api/admin/codes/:id` | 更新激活码 |
| POST | `/api/admin/codes/:id/revoke` | 撤销激活码 |
| DELETE | `/api/admin/codes/:id` | 删除激活码 |
| GET | `/api/admin/stats` | 获取统计数据 |
| GET | `/api/admin/records/:code` | 获取激活记录 |

### 示例：使用API批量创建激活码

```bash
curl -X POST http://localhost:3001/api/admin/codes/bulk \
  -H "Content-Type: application/json" \
  -d '{
    "items": [
      {
        "max_uses": 1,
        "validity_days": 30,
        "daily_limit": 3,
        "notes": "测试激活码1"
      },
      {
        "max_uses": 1,
        "validity_days": 30,
        "daily_limit": 3,
        "notes": "测试激活码2"
      }
    ]
  }'
```

---

## 📞 技术支持

如遇到问题，请检查：
1. 后端服务是否正常运行（`http://localhost:3001/health`）
2. 数据库连接是否正常
3. 浏览器控制台是否有错误信息

**查看后端日志**：
```bash
cd backend
node server.js
```

**数据库初始化**：
```bash
cd backend
node initDb.js
```

