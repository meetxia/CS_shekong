# 宝塔面板部署清单

**项目**: 社恐测评H5应用  
**部署方式**: 阿里云服务器 + 宝塔面板  
**时间**: 2025-11-07

---

## 📋 部署前准备

### 1. 确认宝塔面板已安装的软件

请在宝塔面板检查以下软件是否已安装：

- [x] **Nginx** (推荐1.20+)
- [x] **MySQL** (推荐5.7或8.0)
- [x] **PM2管理器** (Node.js进程管理)
- [x] **Node.js** (16.x或以上版本)

### 2. 准备工作清单

- [ ] 阿里云服务器公网IP地址
- [ ] 域名（如有，建议配置）
- [ ] SSL证书（推荐使用Let's Encrypt免费证书）
- [ ] 数据库root密码（已在宝塔设置）

---

## 🚀 部署步骤（分步执行）

### 第一步：创建网站和数据库

#### 1.1 创建网站

在宝塔面板：
1. 点击 **网站** → **添加站点**
2. 配置如下：
   - **域名**: 填写您的域名（如：shekong.yourdomain.com）或直接使用IP地址
   - **根目录**: `/www/wwwroot/shekong`
   - **PHP版本**: 纯静态
   - **创建FTP**: 否
   - **创建数据库**: 否（稍后手动创建）

#### 1.2 创建数据库

在宝塔面板：
1. 点击 **数据库** → **添加数据库**
2. 配置如下：
   - **数据库名**: `shekong_ai`
   - **用户名**: `shekong_user`（或root）
   - **密码**: 自动生成（记下来）
   - **访问权限**: 本地服务器
   - **备注**: 社恐测评数据库

**重要**: 记录数据库信息到下方：
```
数据库地址: localhost
端口: 3306
数据库名: shekong_ai
用户名: _____________
密码: _____________
```

---

### 第二步：上传项目代码

#### 2.1 在本地打包项目

在您的本地项目目录执行：

```bash
# 1. 构建前端生产版本
npm run build

# 2. 打包前端dist文件夹
# Windows PowerShell执行：
Compress-Archive -Path dist -DestinationPath shekong-frontend.zip

# 3. 打包后端文件夹（排除node_modules）
# 手动压缩backend文件夹，排除node_modules目录
# 或使用命令：
Compress-Archive -Path backend\*.* -DestinationPath shekong-backend.zip
```

#### 2.2 上传到服务器

**方式一：宝塔面板文件管理上传**

1. 登录宝塔面板
2. 点击 **文件** → 进入 `/www/wwwroot/shekong`
3. 上传 `shekong-frontend.zip`
4. 解压后，将 `dist` 文件夹内的所有文件移动到 `/www/wwwroot/shekong` 根目录
5. 创建 `backend` 文件夹，上传 `shekong-backend.zip`
6. 解压 `backend` 文件夹

**方式二：使用宝塔远程下载（如果代码在Git）**

```bash
# SSH连接服务器后
cd /www/wwwroot/shekong
git clone your-git-repository .
npm install
npm run build
```

**最终目录结构应该是**：
```
/www/wwwroot/shekong/
├── index.html          # 前端入口
├── assets/             # 前端资源
├── backend/            # 后端代码
│   ├── server.js
│   ├── package.json
│   ├── .env           # 需要创建
│   └── ...
└── nginx配置文件会在第四步配置
```

---

### 第三步：配置后端环境

#### 3.1 创建后端环境变量文件

在宝塔面板：
1. 进入 `/www/wwwroot/shekong/backend/` 目录
2. 点击 **创建文件** → 文件名：`.env`
3. 编辑 `.env` 文件，填入以下内容：

```bash
# 数据库配置（填写第一步记录的数据库信息）
DB_HOST=localhost
DB_PORT=3306
DB_USER=shekong_user
DB_PASSWORD=你的数据库密码
DB_NAME=shekong_ai

# Claude API配置（使用您现有的配置）
CLAUDE_API_KEY=sk-neZiqN36Qh4HbF7WB3633aC322844cB09c5474D64d5fA657
CLAUDE_API_URL=https://dpapi.cn/v1/chat/completions
CLAUDE_MODEL=claude-4.5-sonnet

# 服务器配置
PORT=3001
NODE_ENV=production

# 管理员配置（首次初始化）
ADMIN_USERNAME=admin
ADMIN_PASSWORD=Admin@123456
ADMIN_NICKNAME=系统管理员
```

**保存后检查**: 确保文件名是 `.env` 而不是 `.env.txt`

#### 3.2 安装后端依赖

**方式一：SSH终端执行（推荐）**

在宝塔面板：
1. 点击 **终端** 图标打开SSH终端
2. 执行以下命令：

```bash
cd /www/wwwroot/shekong/backend
npm install --production
```

**方式二：宝塔Node.js项目管理器**

1. 点击 **软件商店** → 找到 **Node.js版本管理器**
2. 点击 **设置** → **项目管理**
3. 添加项目路径：`/www/wwwroot/shekong/backend`

#### 3.3 初始化数据库

在SSH终端执行：

```bash
cd /www/wwwroot/shekong/backend

# 初始化数据库表结构
node initDb.js

# 初始化管理员账号
node initAdmin.js
```

**成功标志**: 看到 `✅ 数据库初始化完成` 和 `✅ 管理员账号创建成功`

---

### 第四步：配置Nginx反向代理

#### 4.1 修改网站Nginx配置

在宝塔面板：
1. 点击 **网站** → 找到您的站点 → 点击 **设置**
2. 选择 **配置文件** 标签
3. 找到 `server { }` 块，在 `location / { }` 前面添加以下内容：

```nginx
# API反向代理到后端
location /api/ {
    proxy_pass http://127.0.0.1:3001;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    
    # 超时设置
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}

# 健康检查接口
location /health {
    proxy_pass http://127.0.0.1:3001/health;
    access_log off;
}
```

4. 找到 `location / { }` 块，修改为：

```nginx
location / {
    try_files $uri $uri/ /index.html;
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

5. 点击 **保存**
6. 点击 **服务** → **Nginx** → **重载配置**

#### 4.2 配置SSL证书（推荐）

在宝塔面板：
1. 进入网站设置 → **SSL** 标签
2. 选择 **Let's Encrypt** 免费证书
3. 填写邮箱，点击 **申请**
4. 申请成功后，开启 **强制HTTPS**

---

### 第五步：启动后端服务（使用PM2）

#### 5.1 通过宝塔PM2管理器启动

**方式一：宝塔PM2管理器（推荐）**

1. 在宝塔面板，点击 **软件商店**
2. 找到 **PM2管理器**，点击 **设置**
3. 点击 **添加项目**：
   - **项目名称**: `shekong-backend`
   - **启动文件路径**: `/www/wwwroot/shekong/backend/server.js`
   - **项目路径**: `/www/wwwroot/shekong/backend`
   - **端口**: `3001`
   - **运行模式**: `cluster`（集群模式）
   - **进程数**: `2`
4. 点击 **提交**

**方式二：SSH命令行启动**

```bash
cd /www/wwwroot/shekong/backend

# 使用ecosystem.config.js配置启动
pm2 start ecosystem.config.js

# 或者简单启动
pm2 start server.js --name shekong-backend -i 2

# 设置开机自启
pm2 startup
pm2 save
```

#### 5.2 检查服务状态

```bash
# 查看PM2进程列表
pm2 list

# 查看详细日志
pm2 logs shekong-backend

# 查看实时监控
pm2 monit
```

**成功标志**: 
- 进程状态显示 `online`
- 访问 `http://您的IP:3001/health` 返回 `{"status":"ok"}`

---

### 第六步：验证部署

#### 6.1 测试前端访问

打开浏览器访问：
- `http://您的域名` 或 `http://您的服务器IP`
- 应该能看到项目首页

#### 6.2 测试后端API

访问以下地址测试：
- 健康检查: `http://您的域名/health`
- 应该返回: `{"status":"ok","timestamp":"...","uptime":...}`

#### 6.3 完整功能测试

1. **激活码验证**:
   - 打开网站
   - 输入测试激活码（可在数据库 `activation_codes` 表查看）
   - 验证是否能进入测评页面

2. **管理后台登录**:
   - 访问: `http://您的域名/admin/login`
   - 使用管理员账号登录（在.env中配置的）
   - 默认: `admin` / `Admin@123456`

3. **测评流程**:
   - 完成35道题
   - 提交后查看报告
   - 检查AI生成是否正常

---

## 🔧 常见问题处理

### 问题1: 前端页面404

**解决方案**:
1. 检查nginx配置中的 `try_files $uri $uri/ /index.html;`
2. 确认前端文件已正确解压到网站根目录
3. 重载nginx: 宝塔面板 → 服务 → Nginx → 重载配置

### 问题2: API接口404或500

**排查步骤**:
```bash
# 1. 检查PM2进程是否运行
pm2 list

# 2. 查看错误日志
pm2 logs shekong-backend --lines 50

# 3. 测试后端直接访问
curl http://localhost:3001/health

# 4. 检查端口是否被占用
netstat -tlnp | grep 3001
```

### 问题3: 数据库连接失败

**排查步骤**:
1. 检查 `.env` 文件中数据库配置是否正确
2. 在宝塔面板 → 数据库，确认 `shekong_ai` 存在
3. 测试数据库连接：
   ```bash
   cd /www/wwwroot/shekong/backend
   node -e "require('./db.js').testConnection()"
   ```

### 问题4: PM2进程频繁重启

**查看原因**:
```bash
pm2 logs shekong-backend --err --lines 100
```

**常见原因**:
- 端口被占用（检查3001端口）
- 环境变量配置错误
- 缺少依赖包（重新执行 `npm install`）

### 问题5: SSL证书申请失败

**解决方案**:
1. 确保域名已正确解析到服务器IP
2. 检查80端口是否开放（Let's Encrypt需要）
3. 关闭防火墙或添加白名单：
   - 宝塔面板 → 安全 → 放行 80、443、3001 端口

---

## 🔒 安全加固（重要）

### 1. 修改默认管理员密码

首次登录管理后台后，立即修改密码：
1. 登录 `http://您的域名/admin/login`
2. 进入个人设置修改密码

### 2. 配置防火墙

在宝塔面板 → 安全：
- ✅ 开放端口: 80 (HTTP)
- ✅ 开放端口: 443 (HTTPS)
- ✅ 开放端口: 22 (SSH，仅您的IP)
- ❌ 关闭端口: 3001 (后端端口不对外暴露，仅Nginx内部访问)

### 3. 定期备份

#### 3.1 配置宝塔自动备份

在宝塔面板 → 计划任务：
1. **备份网站**:
   - 任务类型: 备份网站
   - 网站: 选择您的站点
   - 执行周期: 每天 凌晨2点
   - 保留份数: 7份

2. **备份数据库**:
   - 任务类型: 备份数据库
   - 数据库: shekong_ai
   - 执行周期: 每天 凌晨3点
   - 保留份数: 7份

#### 3.2 备份到云存储（推荐）

在宝塔面板 → 面板设置 → 备份设置：
- 开启阿里云OSS备份
- 填入AccessKey和Bucket信息

---

## 📊 性能优化建议

### 1. 启用Nginx缓存

已在配置中添加静态资源缓存，无需额外操作。

### 2. 开启Gzip压缩

在宝塔面板：
1. 网站设置 → 配置文件
2. 确认已包含：
```nginx
gzip on;
gzip_min_length 1k;
gzip_comp_level 6;
gzip_types text/plain text/css text/javascript application/json application/javascript;
```

### 3. 配置CDN（可选）

如果使用阿里云CDN：
1. 将静态资源目录（assets、js、css）配置到CDN
2. 修改前端构建配置中的资源路径

---

## 📝 部署后检查清单

完成部署后，请逐项检查：

### 前端检查
- [ ] 首页能正常访问
- [ ] 激活页面显示正常
- [ ] 静态资源（图片、CSS、JS）加载正常
- [ ] 移动端适配正常

### 后端检查
- [ ] PM2进程状态为 `online`
- [ ] `/health` 接口返回正常
- [ ] 数据库连接成功
- [ ] 日志没有错误信息

### 功能检查
- [ ] 激活码验证功能正常
- [ ] 测评流程完整
- [ ] AI分析生成正常
- [ ] 管理后台登录正常
- [ ] 激活码管理功能正常

### 安全检查
- [ ] HTTPS正常工作
- [ ] 管理员密码已修改
- [ ] 防火墙配置正确
- [ ] 3001端口未对外开放

### 性能检查
- [ ] 首屏加载时间 < 3秒
- [ ] API响应时间 < 1秒
- [ ] Gzip压缩已启用
- [ ] 静态资源缓存生效

---

## 🆘 紧急联系

如遇到无法解决的问题：

1. **查看错误日志**:
   ```bash
   # 后端日志
   pm2 logs shekong-backend --lines 100
   
   # Nginx日志
   tail -f /www/wwwroot/shekong/log/error.log
   ```

2. **重启服务**:
   ```bash
   # 重启后端
   pm2 restart shekong-backend
   
   # 重启Nginx
   service nginx reload
   ```

3. **回滚到备份**:
   - 宝塔面板 → 文件 → 回收站
   - 或使用计划任务中的备份文件

---

## ✅ 部署完成

恭喜！如果所有检查项都通过，您的项目已成功部署到阿里云服务器！

**下一步建议**:
1. 分享网站地址给测试用户
2. 监控服务器资源使用情况
3. 定期查看PM2日志
4. 关注API调用次数（Claude费用）

---

**部署清单版本**: V1.0  
**更新时间**: 2025-11-07  
**适用环境**: 宝塔面板 7.x + Nginx + MySQL + PM2
