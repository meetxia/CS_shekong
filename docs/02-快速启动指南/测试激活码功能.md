# 测试激活码功能 - 快速指南

## ✅ 已完成步骤

1. ✅ Supabase 数据库脚本已执行
2. ✅ `.env` 文件已创建

## 🔍 步骤 1：检查环境变量配置

确保你的 `.env` 文件配置完整：

```env
VITE_SUPABASE_URL=https://mtadwsrwloheujiwrfgg.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...（完整的key）
```

**⚠️ 注意：** `VITE_SUPABASE_ANON_KEY` 必须是一个完整的 JWT token，通常很长。如果图片中显示被截断了，请确保复制完整的 key。

### 如何获取完整的 Anon Key：

1. 打开 Supabase Dashboard
2. 点击左侧菜单 **Settings** → **API**
3. 找到 **anon public** key
4. 点击右侧的复制按钮，复制完整的 key
5. 粘贴到 `.env` 文件中

## 🔄 步骤 2：重启开发服务器

环境变量只在服务器启动时加载，所以需要重启：

1. **停止当前服务器**：
   - 在终端按 `Ctrl + C`

2. **重新启动**：
   ```bash
   npm run dev
   ```

3. **检查控制台**：
   - 如果看到 Supabase 相关的警告，说明配置有问题
   - 如果没有警告，说明配置成功

## 🧪 步骤 3：测试激活码

### 测试步骤：

1. **打开激活页面**：
   - 访问：`http://localhost:5173/activation`
   - 或者从首页点击"开始测评"

2. **输入测试激活码**：
   - `TEST-2024-ABCD`
   - `DEMO-1234-5678`
   - `MVPX-XXXX-YYYY`

3. **点击"开始测评"按钮**

4. **预期结果**：
   - ✅ 显示"激活成功！"提示
   - ✅ 自动跳转到测评页面
   - ✅ 浏览器控制台没有错误

### 如果出现错误：

#### 错误 1：激活码验证失败

**检查：**
- 打开浏览器开发者工具（F12）
- 查看 Console 标签页的错误信息

**常见原因：**
- 环境变量未正确配置
- Supabase URL 或 Key 错误
- 数据库函数未创建成功

**解决方法：**
1. 检查 `.env` 文件中的值是否正确
2. 确认 Supabase 项目 URL 和 API Key 匹配
3. 重新执行数据库脚本

#### 错误 2：找不到数据库函数

**检查：**
在 Supabase SQL Editor 中执行：

```sql
SELECT routine_name 
FROM information_schema.routines 
WHERE routine_schema = 'public' 
AND routine_name IN ('verify_activation_code', 'get_activation_status');
```

**如果查询结果为空：**
重新执行 `docs/06-数据库脚本/supabase_activation_setup.sql`

#### 错误 3：RLS 策略错误

**检查：**
在 Supabase Dashboard 中：
1. 点击 **Authentication** → **Policies**
2. 确认 RLS 策略已创建

**如果策略缺失：**
重新执行数据库脚本中的 RLS 策略部分

## 🔍 步骤 4：验证数据库记录

### 查看激活记录：

1. 在 Supabase Dashboard 中，点击 **Table Editor**
2. 选择 `activation_records` 表
3. 应该能看到刚才激活的记录

### 查看激活码：

1. 选择 `activation_codes` 表
2. 确认测试激活码存在且状态为 `active`

## 📊 步骤 5：测试使用次数限制

### 测试每日限制：

1. 完成一次测评
2. 再次访问激活页面
3. 再次输入激活码（或使用已激活的状态）
4. 应该能看到剩余次数提示

### 测试过期时间：

1. 在激活页面查看激活状态
2. 应该显示剩余天数（默认 7 天）

## 🎉 成功标志

如果以下都正常，说明配置成功：

- ✅ 激活码可以成功验证
- ✅ 激活后可以进入测评页面
- ✅ 使用次数限制正常工作
- ✅ 浏览器控制台没有错误
- ✅ 数据库中有激活记录

## 🚀 下一步

配置成功后，你可以：

1. **生成自己的激活码**（见下方）
2. **测试完整流程**（激活 → 测评 → 报告）
3. **部署到生产环境**

### 生成激活码示例：

在 Supabase SQL Editor 中执行：

```sql
INSERT INTO activation_codes (
  code, 
  status, 
  max_uses, 
  validity_days, 
  daily_limit,
  notes
) VALUES (
  'YOUR-NEW-CODE',  -- 替换为你的激活码
  'active',
  100,              -- 最大使用次数
  7,                -- 有效期（天）
  3,                -- 每天限制
  '你的备注'
);
```

