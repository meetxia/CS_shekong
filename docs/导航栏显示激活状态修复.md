# å¯¼èˆªæ æ˜¾ç¤ºæ¿€æ´»çŠ¶æ€ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼š**æ±‰å ¡èœå•å’Œå¯¼èˆªæ ä¸æ˜¾ç¤ºå½“å‰å‰©ä½™æµ‹è¯•æ¬¡æ•°å’Œå¤©æ•°ï¼Œæ•°æ®æ¥å£æ²¡å¯¹é½**ã€‚

### é—®é¢˜è¡¨ç°
1. âŒ æ¡Œé¢ç«¯å¯¼èˆªæ ï¼šåº”æ˜¾ç¤º"å‰©ä½™Xå¤© Â· ä»Šæ—¥X/3"ï¼Œä½†ä¸æ˜¾ç¤º
2. âŒ ç§»åŠ¨ç«¯æ±‰å ¡èœå•ï¼šåº”æ˜¾ç¤ºæ¿€æ´»ç çŠ¶æ€ï¼Œä½†ä¸æ˜¾ç¤º
3. âŒ æäº¤æµ‹è¯„åï¼šå¯¼èˆªæ çŠ¶æ€ä¸æ›´æ–°ï¼Œä»æ˜¾ç¤ºæ—§çš„æ¬¡æ•°

## ğŸ” é—®é¢˜æ ¹æºåˆ†æ

### ä»£ç å®¡æŸ¥å‘ç°

#### é—®é¢˜1ï¼šæ•°æ®æ¥å£ä¸å®Œæ•´

**ä½ç½®ï¼š** `src/utils/activation.js` ç¬¬471è¡Œ

```javascript
// âŒ ä¿®å¤å‰ï¼šç¼ºå°‘ dailyLimit å­—æ®µ
if (!usage) return { daysLeft: 0, remainingToday: 0, expired: true }

// âœ… ä¿®å¤åï¼šåŒ…å«å®Œæ•´å­—æ®µ
if (!usage) return { daysLeft: 0, remainingToday: 0, expired: true, dailyLimit: 3 }
```

**é—®é¢˜åˆ†æï¼š**
- AppHeader æ¨¡æ¿ä¸­ä½¿ç”¨ `activationStatus.dailyLimit` æ˜¾ç¤ºæ¯æ—¥é™é¢
- å½“æ²¡æœ‰æ¿€æ´»æ•°æ®æ—¶ï¼Œè¿”å›å€¼ç¼ºå°‘ `dailyLimit` å­—æ®µ
- å¯¼è‡´æ¨¡æ¿æ¸²æŸ“å¤±è´¥ï¼Œæ•´ä¸ªçŠ¶æ€åŒºåŸŸä¸æ˜¾ç¤º

#### é—®é¢˜2ï¼šç¼ºå°‘é»˜è®¤å€¼ä¿æŠ¤

**ä½ç½®ï¼š** `src/utils/activation.js` ç¬¬480è¡Œ

```javascript
// âŒ ä¿®å¤å‰ï¼šæ²¡æœ‰é»˜è®¤å€¼
const remainingToday = Math.max(0, usage.dailyLimit - usedToday)

// âœ… ä¿®å¤åï¼šæœ‰é»˜è®¤å€¼ä¿æŠ¤
const dailyLimit = usage.dailyLimit || 3
const remainingToday = Math.max(0, dailyLimit - usedToday)
```

**é—®é¢˜åˆ†æï¼š**
- å¦‚æœ `usage.dailyLimit` ä¸º `undefined` æˆ– `null`
- è®¡ç®— `remainingToday` ä¼šå¾—åˆ° `NaN`
- å¯¼è‡´æ˜¾ç¤ºå¼‚å¸¸

#### é—®é¢˜3ï¼šæäº¤æµ‹è¯„åçŠ¶æ€ä¸æ›´æ–°

**ä½ç½®ï¼š** `src/components/AppHeader.vue`

**é—®é¢˜åˆ†æï¼š**
- AppHeader åœ¨ `onMounted` æ—¶åŠ è½½çŠ¶æ€
- åœ¨è·¯ç”±å˜åŒ–æ—¶åˆ·æ–°çŠ¶æ€
- ä½†**æäº¤æµ‹è¯„åä¸åˆ‡æ¢è·¯ç”±**ï¼ˆåªæ˜¯è·³è½¬åˆ° /reportï¼‰
- å¯¼è‡´çŠ¶æ€æ²¡æœ‰å®æ—¶æ›´æ–°

**ç¼ºå°‘çš„æœºåˆ¶ï¼š**
1. âŒ æ²¡æœ‰ç›‘å¬æµ‹è¯„æäº¤äº‹ä»¶
2. âŒ æ²¡æœ‰å®šæ—¶åˆ·æ–°æœºåˆ¶
3. âŒ æ²¡æœ‰æ‰‹åŠ¨è§¦å‘åˆ·æ–°çš„æ–¹å¼

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤1ï¼šå®Œå–„æ•°æ®æ¥å£

#### `src/utils/activation.js`

```javascript
// æœ¬åœ°æ¨¡å¼æˆ– Supabase å¤±è´¥æ—¶ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®
const usage = readUsage()
// âœ… æ·»åŠ  dailyLimit å­—æ®µï¼Œç¡®ä¿æ¥å£å®Œæ•´
if (!usage) return { daysLeft: 0, remainingToday: 0, expired: true, dailyLimit: 3 }

const now = new Date()
const expiresAt = new Date(usage.expiresAt)
const msLeft = expiresAt - now
const daysLeft = Math.max(0, Math.ceil(msLeft / (24 * 60 * 60 * 1000)))
const expired = msLeft <= 0

const usedToday = usage.usageByDate[todayStr()] || 0
// âœ… æ·»åŠ é»˜è®¤å€¼ä¿æŠ¤
const dailyLimit = usage.dailyLimit || 3
const remainingToday = Math.max(0, dailyLimit - usedToday)

// âœ… è¿”å›å®Œæ•´çš„æ•°æ®å¯¹è±¡
return { daysLeft, remainingToday, expired, dailyLimit }
```

### ä¿®å¤2ï¼šæ·»åŠ äº‹ä»¶ç›‘å¬æœºåˆ¶

#### `src/components/AppHeader.vue`

```javascript
// ğŸ”§ ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶ï¼Œåœ¨æµ‹è¯„æäº¤ååˆ·æ–°çŠ¶æ€
const handleActivationUpdate = () => {
  console.log('ğŸ”„ [AppHeader] æ”¶åˆ°æ¿€æ´»çŠ¶æ€æ›´æ–°é€šçŸ¥ï¼Œåˆ·æ–°çŠ¶æ€...')
  loadActivationStatus()
}

// ğŸ”§ å®šæ—¶åˆ·æ–°æ¿€æ´»ç çŠ¶æ€ï¼ˆæ¯30ç§’ï¼‰
let refreshTimer = null

onMounted(() => {
  window.addEventListener('keydown', handleKeydown)
  window.addEventListener('activation-updated', handleActivationUpdate)  // âœ… ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶
  loadActivationStatus()
  
  // âœ… æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡çŠ¶æ€
  refreshTimer = setInterval(() => {
    if (hasActivation.value) {
      loadActivationStatus()
    }
  }, 30000)
})

onBeforeUnmount(() => {
  window.removeEventListener('keydown', handleKeydown)
  window.removeEventListener('activation-updated', handleActivationUpdate)  // âœ… æ¸…ç†ç›‘å¬
  document.body.style.overflow = ''
  if (refreshTimer) {
    clearInterval(refreshTimer)  // âœ… æ¸…ç†å®šæ—¶å™¨
  }
})
```

**ä¼˜åŒ–ç‚¹ï¼š**
1. âœ… **äº‹ä»¶ç›‘å¬**ï¼šç›‘å¬ `activation-updated` è‡ªå®šä¹‰äº‹ä»¶
2. âœ… **å®šæ—¶åˆ·æ–°**ï¼šæ¯30ç§’è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
3. âœ… **èµ„æºæ¸…ç†**ï¼šç»„ä»¶å¸è½½æ—¶æ¸…é™¤ç›‘å¬å™¨å’Œå®šæ—¶å™¨

### ä¿®å¤3ï¼šè§¦å‘çŠ¶æ€æ›´æ–°äº‹ä»¶

#### `src/views/AssessmentPage.vue`

```javascript
// è®°å½•ä¸€æ¬¡ä½¿ç”¨å¹¶æç¤ºå‰©ä½™æ¬¡æ•°/æœ‰æ•ˆæœŸ
const rec = await recordOneUsage()
if (rec && rec.recorded) {
  showToast(`æµ‹è¯•å®Œæˆï¼ä»Šæ—¥å‰©ä½™${rec.remainingToday}æ¬¡ Â· å‰©ä½™${rec.daysLeft}å¤©`, 2200, 'success')
  // ğŸ”§ è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥å¯¼èˆªæ åˆ·æ–°æ¿€æ´»ç çŠ¶æ€
  window.dispatchEvent(new Event('activation-updated'))
  console.log('ğŸ“¢ [æäº¤æµ‹è¯„] å·²è§¦å‘æ¿€æ´»çŠ¶æ€æ›´æ–°äº‹ä»¶')
} else {
  const s = await getActivationStatus()
  if (s.expired) {
    showToast('æ¿€æ´»ç å·²è¿‡æœŸï¼Œå®Œæˆæœ¬æ¬¡åæ— æ³•ç»§ç»­ä½¿ç”¨', 2500, 'warning')
  } else if (s.remainingToday === 0) {
    showToast('ä»Šæ—¥3æ¬¡å·²ç”¨å®Œï¼Œæ˜å¤©0ç‚¹è‡ªåŠ¨æ¢å¤', 2200, 'warning')
  } else {
    showToast('æµ‹è¯„å®Œæˆï¼', 1500, 'success')
  }
  // ğŸ”§ æ— è®ºæ‰£é™¤æ˜¯å¦æˆåŠŸï¼Œéƒ½è§¦å‘åˆ·æ–°äº‹ä»¶
  window.dispatchEvent(new Event('activation-updated'))
  console.log('ğŸ“¢ [æäº¤æµ‹è¯„] å·²è§¦å‘æ¿€æ´»çŠ¶æ€æ›´æ–°äº‹ä»¶')
}
```

**ä¼˜åŒ–ç‚¹ï¼š**
1. âœ… æ‰£é™¤æˆåŠŸæ—¶è§¦å‘äº‹ä»¶
2. âœ… æ‰£é™¤å¤±è´¥æ—¶ä¹Ÿè§¦å‘äº‹ä»¶ï¼ˆç¡®ä¿çŠ¶æ€åŒæ­¥ï¼‰
3. âœ… æ·»åŠ æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰

| åœºæ™¯ | æ¡Œé¢ç«¯å¯¼èˆªæ  | ç§»åŠ¨ç«¯èœå• | æ•°æ®æ¥å£ |
|------|-------------|-----------|---------|
| é¦–æ¬¡åŠ è½½ | âŒ ä¸æ˜¾ç¤º | âŒ ä¸æ˜¾ç¤º | âŒ ç¼ºå­—æ®µ |
| æäº¤æµ‹è¯„å | âŒ ä¸æ›´æ–° | âŒ ä¸æ›´æ–° | âŒ ç¼ºå­—æ®µ |
| åˆ‡æ¢è·¯ç”±å | âš ï¸ å¯èƒ½æ˜¾ç¤º | âš ï¸ å¯èƒ½æ˜¾ç¤º | âŒ ç¼ºå­—æ®µ |

### ä¿®å¤å

| åœºæ™¯ | æ¡Œé¢ç«¯å¯¼èˆªæ  | ç§»åŠ¨ç«¯èœå• | æ•°æ®æ¥å£ |
|------|-------------|-----------|---------|
| é¦–æ¬¡åŠ è½½ | âœ… æ­£ç¡®æ˜¾ç¤º | âœ… æ­£ç¡®æ˜¾ç¤º | âœ… å®Œæ•´ |
| æäº¤æµ‹è¯„å | âœ… å®æ—¶æ›´æ–° | âœ… å®æ—¶æ›´æ–° | âœ… å®Œæ•´ |
| åˆ‡æ¢è·¯ç”±å | âœ… è‡ªåŠ¨åˆ·æ–° | âœ… è‡ªåŠ¨åˆ·æ–° | âœ… å®Œæ•´ |
| 30ç§’å | âœ… è‡ªåŠ¨åˆ·æ–° | âœ… è‡ªåŠ¨åˆ·æ–° | âœ… å®Œæ•´ |

## ğŸ¯ æ•°æ®æµç¨‹å›¾

### ä¿®å¤å‰çš„æµç¨‹
```
ç”¨æˆ·æäº¤æµ‹è¯„
  â†“
æ‰£é™¤ä½¿ç”¨æ¬¡æ•°ï¼ˆåç«¯ï¼‰
  â†“
è·³è½¬åˆ°æŠ¥å‘Šé¡µ
  â†“
âŒ AppHeader ä¸çŸ¥é“çŠ¶æ€å˜åŒ–
  â†“
âŒ å¯¼èˆªæ æ˜¾ç¤ºæ—§çŠ¶æ€
```

### ä¿®å¤åçš„æµç¨‹
```
ç”¨æˆ·æäº¤æµ‹è¯„
  â†“
æ‰£é™¤ä½¿ç”¨æ¬¡æ•°ï¼ˆåç«¯ï¼‰
  â†“
è§¦å‘ 'activation-updated' äº‹ä»¶ âœ…
  â†“
AppHeader ç›‘å¬åˆ°äº‹ä»¶ âœ…
  â†“
é‡æ–°è°ƒç”¨ getActivationStatus() âœ…
  â†“
æ›´æ–°å¯¼èˆªæ æ˜¾ç¤º âœ…
  â†“
è·³è½¬åˆ°æŠ¥å‘Šé¡µ
  â†“
å®šæ—¶å™¨æ¯30ç§’è‡ªåŠ¨åˆ·æ–° âœ…
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯1ï¼šé¦–æ¬¡åŠ è½½
1. æ‰“å¼€ç½‘ç«™
2. è¾“å…¥æ¿€æ´»ç æ¿€æ´»
3. æŸ¥çœ‹å¯¼èˆªæ 

**é¢„æœŸç»“æœï¼š**
- âœ… æ¡Œé¢ç«¯æ˜¾ç¤ºï¼š"å‰©ä½™7å¤© Â· ä»Šæ—¥3/3"
- âœ… ç§»åŠ¨ç«¯èœå•æ˜¾ç¤ºï¼š"æ¿€æ´»ç å‰©ä½™ï¼š7å¤© Â· ä»Šæ—¥ï¼š3/3"

### æµ‹è¯•åœºæ™¯2ï¼šæäº¤æµ‹è¯„
1. å®Œæˆ35é¢˜æµ‹è¯„
2. æäº¤æµ‹è¯„
3. è§‚å¯Ÿå¯¼èˆªæ å˜åŒ–

**é¢„æœŸç»“æœï¼š**
- âœ… æ§åˆ¶å°æ˜¾ç¤ºï¼š`ğŸ“¢ [æäº¤æµ‹è¯„] å·²è§¦å‘æ¿€æ´»çŠ¶æ€æ›´æ–°äº‹ä»¶`
- âœ… æ§åˆ¶å°æ˜¾ç¤ºï¼š`ğŸ”„ [AppHeader] æ”¶åˆ°æ¿€æ´»çŠ¶æ€æ›´æ–°é€šçŸ¥ï¼Œåˆ·æ–°çŠ¶æ€...`
- âœ… å¯¼èˆªæ å®æ—¶æ›´æ–°ä¸ºï¼š"å‰©ä½™7å¤© Â· ä»Šæ—¥2/3"
- âœ… Toast æç¤ºï¼š`æµ‹è¯•å®Œæˆï¼ä»Šæ—¥å‰©ä½™2æ¬¡ Â· å‰©ä½™7å¤©`

### æµ‹è¯•åœºæ™¯3ï¼šé‡å¤æµ‹è¯„
1. åœ¨æŠ¥å‘Šé¡µç‚¹å‡»"å†æµ‹ä¸€æ¬¡"
2. å®Œæˆæµ‹è¯„å¹¶æäº¤
3. è§‚å¯Ÿå¯¼èˆªæ å˜åŒ–

**é¢„æœŸç»“æœï¼š**
- âœ… å¯¼èˆªæ æ›´æ–°ä¸ºï¼š"å‰©ä½™7å¤© Â· ä»Šæ—¥1/3"
- âœ… Toast æç¤ºï¼š`æµ‹è¯•å®Œæˆï¼ä»Šæ—¥å‰©ä½™1æ¬¡ Â· å‰©ä½™7å¤©`

### æµ‹è¯•åœºæ™¯4ï¼šå®šæ—¶åˆ·æ–°
1. ä¿æŒé¡µé¢æ‰“å¼€
2. ç­‰å¾…30ç§’
3. è§‚å¯Ÿæ§åˆ¶å°

**é¢„æœŸç»“æœï¼š**
- âœ… æ¯30ç§’è‡ªåŠ¨è°ƒç”¨ `getActivationStatus()`
- âœ… ç¡®ä¿çŠ¶æ€ä¸åç«¯åŒæ­¥

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### 1. è‡ªå®šä¹‰äº‹ä»¶æœºåˆ¶

```javascript
// å‘é€äº‹ä»¶ï¼ˆAssessmentPage.vueï¼‰
window.dispatchEvent(new Event('activation-updated'))

// ç›‘å¬äº‹ä»¶ï¼ˆAppHeader.vueï¼‰
window.addEventListener('activation-updated', handleActivationUpdate)
```

**ä¼˜ç‚¹ï¼š**
- âœ… ç®€å•ç›´æ¥ï¼Œæ— éœ€å¼•å…¥çŠ¶æ€ç®¡ç†åº“
- âœ… è·¨ç»„ä»¶é€šä¿¡æ–¹ä¾¿
- âœ… ç¬¦åˆæµè§ˆå™¨åŸç”ŸAPI

**æ³¨æ„äº‹é¡¹ï¼š**
- âš ï¸ éœ€è¦åœ¨ç»„ä»¶å¸è½½æ—¶æ¸…é™¤ç›‘å¬å™¨
- âš ï¸ äº‹ä»¶åç§°è¦ç»Ÿä¸€ï¼Œé¿å…æ‹¼å†™é”™è¯¯

### 2. å®šæ—¶åˆ·æ–°æœºåˆ¶

```javascript
refreshTimer = setInterval(() => {
  if (hasActivation.value) {
    loadActivationStatus()
  }
}, 30000)  // 30ç§’
```

**ä¼˜ç‚¹ï¼š**
- âœ… ç¡®ä¿çŠ¶æ€å®æ—¶åŒæ­¥
- âœ… é˜²æ­¢å› ç½‘ç»œé—®é¢˜å¯¼è‡´çŠ¶æ€ä¸å‡†ç¡®
- âœ… ç”¨æˆ·é•¿æ—¶é—´åœç•™æ—¶ä¹Ÿèƒ½åŠæ—¶æ›´æ–°

**æ€§èƒ½è€ƒè™‘ï¼š**
- âœ… åªåœ¨æœ‰æ¿€æ´»ç æ—¶æ‰åˆ·æ–°
- âœ… é—´éš”30ç§’ï¼Œä¸ä¼šé€ æˆè¿‡å¤§è´Ÿè½½
- âœ… ç»„ä»¶å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨

### 3. æ•°æ®æ¥å£è§„èŒƒ

æ‰€æœ‰æ¿€æ´»çŠ¶æ€æ¥å£å¿…é¡»è¿”å›ä»¥ä¸‹å­—æ®µï¼š

```typescript
interface ActivationStatus {
  daysLeft: number        // å‰©ä½™å¤©æ•°
  remainingToday: number  // ä»Šæ—¥å‰©ä½™æ¬¡æ•°
  expired: boolean        // æ˜¯å¦è¿‡æœŸ
  dailyLimit: number      // æ¯æ—¥é™é¢ï¼ˆå¿…é¡»ï¼‰
  totalUsage?: number     // æ€»ä½¿ç”¨æ¬¡æ•°ï¼ˆå¯é€‰ï¼‰
}
```

**å…³é”®ç‚¹ï¼š**
- âœ… `dailyLimit` å¿…é¡»æœ‰é»˜è®¤å€¼ï¼ˆ3ï¼‰
- âœ… æ‰€æœ‰æ•°å€¼å­—æ®µéƒ½è¦æœ‰ä¿æŠ¤ï¼Œé¿å… `NaN`
- âœ… æ¥å£åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½è¦è¿”å›å®Œæ•´å¯¹è±¡

## ğŸ“ ç»éªŒæ•™è®­

### 1. æ¥å£è®¾è®¡è¦å®Œæ•´
- âŒ ä¸è¦é—æ¼ä»»ä½•å­—æ®µ
- âœ… æ‰€æœ‰å­—æ®µéƒ½è¦æœ‰æ˜ç¡®çš„ç±»å‹å’Œé»˜è®¤å€¼
- âœ… åœ¨æ¥å£å®šä¹‰æ—¶å°±è€ƒè™‘æ‰€æœ‰ä½¿ç”¨åœºæ™¯

### 2. çŠ¶æ€åŒæ­¥å¾ˆé‡è¦
- âŒ ä¸èƒ½åªåœ¨åˆå§‹åŒ–æ—¶åŠ è½½çŠ¶æ€
- âœ… è¦åœ¨çŠ¶æ€å˜åŒ–æ—¶åŠæ—¶åˆ·æ–°
- âœ… å¯ä»¥è€ƒè™‘å¤šç§åˆ·æ–°æœºåˆ¶ï¼ˆäº‹ä»¶+å®šæ—¶å™¨ï¼‰

### 3. é˜²å¾¡æ€§ç¼–ç¨‹
- âŒ ä¸è¦å‡è®¾æ•°æ®ä¸€å®šå­˜åœ¨
- âœ… æ‰€æœ‰æ•°æ®è®¿é—®éƒ½è¦æœ‰é»˜è®¤å€¼æˆ–ç©ºå€¼æ£€æŸ¥
- âœ… ä½¿ç”¨ `||` æˆ– `??` æ“ä½œç¬¦æä¾›åå¤‡å€¼

### 4. ç”¨æˆ·ä½“éªŒä¼˜å…ˆ
- âœ… çŠ¶æ€å˜åŒ–è¦å®æ—¶åé¦ˆç»™ç”¨æˆ·
- âœ… å¯¼èˆªæ çš„ä¿¡æ¯è¦å‡†ç¡®ã€åŠæ—¶
- âœ… ä¸è¦è®©ç”¨æˆ·ç–‘æƒ‘"ä¸ºä»€ä¹ˆæ¬¡æ•°æ²¡å˜"

## ğŸ“… ä¿®å¤æ—¥æœŸ
2025-11-05

## ğŸ‘¤ ä¿®å¤äººå‘˜
AI Assistant (Claude)

## ğŸ”— ç›¸å…³æ–‡ä»¶
- âœ… `src/components/AppHeader.vue` - å¯¼èˆªæ ç»„ä»¶
- âœ… `src/views/AssessmentPage.vue` - æµ‹è¯„é¡µé¢
- âœ… `src/utils/activation.js` - æ¿€æ´»ç å·¥å…·

