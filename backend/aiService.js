// AIæœåŠ¡ - è°ƒç”¨AI API (æ”¯æŒå¤šä¾›åº”å•†)
const fetch = require('node-fetch');
require('dotenv').config();
const { getActiveAIConfig } = require('./aiConfigService');

/**
 * æ„å»ºAIæç¤ºè¯ï¼ˆä¼˜åŒ–ç‰ˆ - æ¸©æš–ã€ç”Ÿæ´»åŒ–çš„è¯­è¨€é£æ ¼ï¼‰
 */
function buildPrompt(report, answers, basicInfo) {
  const { totalScore, dimensions, type } = report;

  const dimensionDesc = dimensions.map(d =>
    `${d.name}: ${d.score}/${d.maxScore} (${d.percentage}%) - ${d.level.level}`
  ).join('\n');

  const highScoreQuestions = Object.entries(answers)
    .filter(([id, score]) => score >= 4 && parseInt(id) <= 33)
    .map(([id]) => `Q${id}`)
    .join(', ');

  const ageMap = {
    'teen': '12-17å²ï¼ˆé’å°‘å¹´ï¼‰',
    'college': '18-22å²ï¼ˆå¤§å­¦ç”Ÿï¼‰',
    'young_adult': '23-29å²ï¼ˆé’å¹´ï¼‰',
    'adult': '30-39å²ï¼ˆä¸­å¹´ï¼‰',
    'mature': '40å²ä»¥ä¸Šï¼ˆæˆç†ŸæœŸï¼‰'
  };

  const genderMap = { 'male': 'ç”·', 'female': 'å¥³', 'other': 'å…¶ä»–' };

  const occupationMap = {
    'student': 'å­¦ç”Ÿ',
    'employee': 'èŒåœºäºº',
    'freelancer': 'è‡ªç”±èŒä¸š',
    'entrepreneur': 'åˆ›ä¸šè€…',
    'unemployed': 'å¾…ä¸š',
    'other': 'å…¶ä»–'
  };

  const frequencyMap = {
    'rarely': 'å‡ ä¹ä¸å‚åŠ ',
    'occasional': '1-2æ¬¡/å‘¨',
    'regular': '3-4æ¬¡/å‘¨',
    'frequent': '5æ¬¡ä»¥ä¸Š/å‘¨'
  };

  return `ä½ æ˜¯ä¸€ä½æ¸©æš–ã€å–„è§£äººæ„çš„å¿ƒç†é™ªä¼´è€…ï¼Œå°±åƒç”¨æˆ·æœ€ä¿¡ä»»çš„æœ‹å‹æˆ–è´´å¿ƒçš„å¿ƒç†å’¨è¯¢å¸ˆã€‚ä½ çš„ä»»åŠ¡æ˜¯ç”¨æœ€æ¸©æš–ã€æœ€é€šä¿—çš„è¯­è¨€ï¼Œå¸®åŠ©ç”¨æˆ·ç†è§£è‡ªå·±çš„ç¤¾äº¤ç„¦è™‘æ¨¡å¼ã€‚

ã€é‡è¦ï¼šè¯­è¨€é£æ ¼è¦æ±‚ã€‘
ğŸ¯ **æ ¸å¿ƒåŸåˆ™ï¼šåƒæœ‹å‹èŠå¤©ï¼Œä¸æ˜¯å†™ä¸“ä¸šæŠ¥å‘Š**
- æƒ³è±¡ä½ æ­£åœ¨å’Œä¸€ä½å¥½æœ‹å‹é¢å¯¹é¢èŠå¤©ï¼Œç”¨æ—¥å¸¸å¯¹è¯çš„è¯­æ°”
- å®Œå…¨é¿å…å¿ƒç†å­¦æœ¯è¯­ï¼ˆå¦‚"éšœç¢"ã€"ç—‡çŠ¶"ã€"ç—…ç†"ã€"è®¤çŸ¥åå·®"ç­‰ï¼‰
- ç”¨ç”Ÿæ´»åŒ–çš„æ¯”å–»å’Œåœºæ™¯æ¥è§£é‡Šï¼Œè€Œä¸æ˜¯ç†è®ºæ¦‚å¿µ
- è®©ç”¨æˆ·æ„Ÿåˆ°"è¢«çœ‹è§"ã€"è¢«ç†è§£"ï¼Œè€Œä¸æ˜¯"è¢«è¯Šæ–­"
- è¯­æ°”è¦æ¸©æŸ”ã€æ¥çº³ã€å……æ»¡å¸Œæœ›ï¼Œåƒåœ¨è¯´"æˆ‘æ‡‚ä½ çš„æ„Ÿå—"

ã€ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ã€‘
å¹´é¾„æ®µ: ${ageMap[basicInfo.age] || 'æœªçŸ¥'}
æ€§åˆ«: ${genderMap[basicInfo.gender] || 'æœªçŸ¥'}
èŒä¸š: ${occupationMap[basicInfo.occupation] || 'æœªçŸ¥'}
ç¤¾äº¤é¢‘ç‡: ${frequencyMap[basicInfo.social_frequency] || 'æœªçŸ¥'}

ã€æµ‹è¯„ç»“æœã€‘
æ€»åˆ†: ${totalScore}/100
ç­‰çº§: ${report.level.name}
åˆæ­¥ç±»å‹: ${type.name}

ã€ç»´åº¦å¾—åˆ†è¯¦æƒ…ã€‘
${dimensionDesc}

ã€é«˜ç„¦è™‘é¢˜ç›®ã€‘
${highScoreQuestions}

ã€ä»»åŠ¡è¦æ±‚ã€‘
è¯·ç”Ÿæˆä»¥ä¸‹å†…å®¹ï¼ˆJSONæ ¼å¼ï¼‰ï¼š

1. **ä¸ªæ€§åŒ–ç±»å‹åç§°**ï¼ˆ15å­—ä»¥å†…ï¼Œè¦æ–°é¢–ã€ç²¾å‡†ã€è®©äººä¸€çœ‹å°±æœ‰å…±é¸£ï¼‰
   - ç”¨ç”ŸåŠ¨çš„æ¯”å–»æˆ–å½¢è±¡çš„æè¿°ï¼Œä¸è¦ç”¨ä¸“ä¸šæœ¯è¯­
   - ç¤ºä¾‹ï¼š"è„‘å†…å½©æ’ä¸€ç™¾éæ˜Ÿäºº"ã€"ç¤¾äº¤ç”µæ± ç§’æ²¡ç”µå‹"ã€"äººç¾¤ä¸­çš„éšå½¢äºº"
   - è¦è®©ç”¨æˆ·çœ‹åˆ°åä¼šå¿ƒä¸€ç¬‘ï¼Œè§‰å¾—"è¿™å°±æ˜¯æˆ‘å•Šï¼"

2. **è‹±æ–‡åç§°**ï¼ˆç®€æ´ä¼˜é›…å³å¯ï¼‰

3. **æ ¸å¿ƒç‰¹å¾**ï¼ˆ3-5æ¡ï¼Œæ¯æ¡ç”¨æœ€æ—¥å¸¸çš„è¯­è¨€æè¿°ï¼‰
   âœ¨ **è¯­è¨€é£æ ¼ç¤ºä¾‹ï¼š**
   - âŒ ä¸è¦å†™ï¼š"åœ¨ç¤¾äº¤åœºæ™¯ä¸­è¡¨ç°å‡ºæ˜¾è‘—çš„é¢„æœŸç„¦è™‘"
   - âœ… è¦å†™ï¼š"è¿˜æ²¡åˆ°èšä¼šç°åœºï¼Œä½ å°±å·²ç»åœ¨è„‘å­é‡ŒæŠŠå¯èƒ½å‘ç”Ÿçš„å°´å°¬åœºæ™¯æ¼”äº†ä¸€éåˆä¸€é"

   - âŒ ä¸è¦å†™ï¼š"å¯¹è´Ÿé¢è¯„ä»·å…·æœ‰é«˜åº¦æ•æ„Ÿæ€§"
   - âœ… è¦å†™ï¼š"åˆ«äººä¸€ä¸ªä¸ç»æ„çš„çœ¼ç¥ï¼Œä½ éƒ½èƒ½è„‘è¡¥å‡ºä¸€éƒ¨'ä»–æ˜¯ä¸æ˜¯è§‰å¾—æˆ‘å¾ˆå¥‡æ€ª'çš„è¿ç»­å‰§"

   - æ¯æ¡ç‰¹å¾è¦åƒåœ¨å¯¹æœ‹å‹è¯´"æˆ‘å‘ç°ä½ æœ‰ä¸ªç‰¹ç‚¹..."
   - ç”¨å…·ä½“çš„åœºæ™¯å’Œç»†èŠ‚ï¼Œè€Œä¸æ˜¯æŠ½è±¡çš„æ¦‚å¿µ
   - è®©ç”¨æˆ·è¯»å®Œä¼šæƒ³"å¤©å“ªï¼Œä½ æ€ä¹ˆè¿™ä¹ˆæ‡‚æˆ‘ï¼"

4. **ä¸ºä»€ä¹ˆä¼šè¿™æ ·**ï¼ˆ2-3ä¸ªåŸå› ï¼Œæ¯ä¸ªåŒ…å«æ ‡é¢˜å’Œè¯´æ˜ï¼‰
   âš ï¸ **æ³¨æ„ï¼šä¸è¦å«"å¿ƒç†æ ¹æº"ï¼Œè¿™å¤ªä¸“ä¸šäº†ï¼**

   âœ¨ **æ ‡é¢˜è¦æ±‚**ï¼ˆ8-12å­—ï¼‰ï¼š
   - ç”¨æ¸©æŸ”ã€ç†è§£çš„è¯­æ°”ï¼Œåƒåœ¨è¯´"æˆ‘ç†è§£ä½ ä¸ºä»€ä¹ˆä¼šè¿™æ ·"
   - ç¤ºä¾‹ï¼š"ä½ åªæ˜¯å¤ªæƒ³åšåˆ°å®Œç¾"ã€"å°æ—¶å€™çš„ç»å†åœ¨å½±å“ä½ "ã€"ä½ çš„å¤§è„‘å¤ªå–„äºä¿æŠ¤ä½ äº†"

   âœ¨ **è¯´æ˜è¦æ±‚**ï¼ˆ50-80å­—ï¼‰ï¼š
   - å®Œå…¨ä¸è¦ç”¨å¿ƒç†å­¦æœ¯è¯­ï¼
   - ç”¨ç”Ÿæ´»åŒ–çš„æ¯”å–»æ¥è§£é‡Š
   - ç¤ºä¾‹ï¼š
     âŒ ä¸è¦å†™ï¼š"è¿™æºäºè´Ÿå¼ºåŒ–æœºåˆ¶å¯¼è‡´çš„å›é¿è¡Œä¸ºå›ºåŒ–"
     âœ… è¦å†™ï¼š"å°±åƒä½ å°æ—¶å€™è¢«ç‹—å“è¿‡ä¸€æ¬¡ï¼Œä¹‹åè§åˆ°ç‹—éƒ½ä¼šç»•é“èµ°ã€‚æ¯æ¬¡ä½ é€ƒé¿ç¤¾äº¤ï¼ŒçŸ­æœŸå†…ç¡®å®è½»æ¾äº†ï¼Œä½†å¤§è„‘å°±è®°ä½äº†'é€ƒé¿=å®‰å…¨'è¿™ä¸ªå…¬å¼ï¼Œä¸‹æ¬¡å°±æ›´æƒ³é€ƒäº†ã€‚"

   - è®©ç”¨æˆ·æ„Ÿåˆ°è¢«ç†è§£ï¼Œè€Œä¸æ˜¯è¢«åˆ†æ
   - è¯­æ°”è¦åƒæœ‹å‹åœ¨è¯´"å…¶å®å•Šï¼Œä½ ä¼šè¿™æ ·æ˜¯å› ä¸º..."

5. **æ¢ä¸ªè§’åº¦çœ‹è‡ªå·±**ï¼ˆ60-80å­—ï¼‰
   âš ï¸ **ä¸è¦å«"æ­£å‘é‡æ„"ï¼Œå¤ªä¸“ä¸šï¼**

   âœ¨ **è¯­è¨€é£æ ¼è¦æ±‚ï¼š**
   - åƒæœ‹å‹åœ¨é¼“åŠ±ä½ ï¼š"ä½ çŸ¥é“å—ï¼Œä½ è¿™ä¸ªç‰¹ç‚¹å…¶å®ä¹Ÿæœ‰å¥½çš„ä¸€é¢"
   - çœŸè¯šåœ°æŒ‡å‡ºè¿™äº›ç‰¹è´¨çš„ç§¯æé¢ï¼Œä¸è¦ç©ºæ´çš„é¸¡æ±¤
   - ç»™äºˆå…·ä½“çš„å¸Œæœ›ï¼Œè€Œä¸æ˜¯æ³›æ³›çš„å®‰æ…°
   - ç¤ºä¾‹ï¼š
     âŒ ä¸è¦å†™ï¼š"ä½ çš„é«˜æ•æ„Ÿæ€§å¯ä»¥è½¬åŒ–ä¸ºå…±æƒ…èƒ½åŠ›ä¼˜åŠ¿"
     âœ… è¦å†™ï¼š"ä½ å¯¹åˆ«äººæƒ…ç»ªçš„æ•æ„Ÿï¼Œå…¶å®è¯´æ˜ä½ æ˜¯ä¸ªå¾ˆç»†è…»ã€å¾ˆä¼šç…§é¡¾åˆ«äººæ„Ÿå—çš„äººã€‚è¿™ç§ç‰¹è´¨ç”¨å¯¹åœ°æ–¹ï¼Œä¼šè®©ä½ æˆä¸ºæœ‹å‹åœˆé‡Œæœ€æ¸©æš–ã€æœ€æ‡‚äººå¿ƒçš„é‚£ä¸ªäººã€‚"

ã€è¯­è¨€é£æ ¼æ€»ç»“ - è¯·åŠ¡å¿…éµå®ˆã€‘
âœ… è¦ç”¨çš„è¡¨è¾¾ï¼š
- "ä½ æ˜¯ä¸æ˜¯ç»å¸¸..."ã€"æ¯æ¬¡...çš„æ—¶å€™"
- "å°±åƒ..."ï¼ˆç”¨æ¯”å–»ï¼‰
- "å…¶å®å•Š..."ã€"ä½ çŸ¥é“å—..."
- "æˆ‘æ‡‚é‚£ç§æ„Ÿè§‰..."
- å…·ä½“çš„åœºæ™¯æè¿°

âŒ ç»å¯¹ä¸è¦ç”¨çš„è¯æ±‡ï¼š
- éšœç¢ã€ç—‡çŠ¶ã€ç—…ç†ã€ç–¾ç—…
- è®¤çŸ¥åå·®ã€è´Ÿå¼ºåŒ–ã€æ³›åŒ–
- åŠŸèƒ½æŸå®³ã€ä¸´åºŠè¡¨ç°
- ä»»ä½•æ•™ç§‘ä¹¦å¼çš„ä¸“ä¸šæœ¯è¯­

ã€ç‰¹æ®Šæƒ…å†µå¤„ç†ã€‘
- å¦‚æœæ€»åˆ†å¾ˆé«˜ï¼ˆ>80ï¼‰ï¼Œè¦æ¸©æŸ”åœ°å»ºè®®å¯»æ±‚ä¸“ä¸šå¸®åŠ©ï¼Œä½†ä¸è¦å“å”¬ç”¨æˆ·
- ç”¨"æ‰¾ä¸ªä¸“ä¸šçš„å¿ƒç†å’¨è¯¢å¸ˆèŠèŠï¼Œå¯èƒ½ä¼šå¸®åˆ°ä½ "ï¼Œè€Œä¸æ˜¯"éœ€è¦ä¸´åºŠå¹²é¢„"

ã€è¾“å‡ºæ ¼å¼ã€‘
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—ï¼š

{
  "typeName": "ä½ çš„ä¸ªæ€§åŒ–ç±»å‹åç§°",
  "englishName": "Personalized Type Name",
  "features": [
    "æ ¸å¿ƒç‰¹å¾1ï¼ˆç”¨æ—¥å¸¸è¯­è¨€ï¼Œåƒæœ‹å‹åœ¨è¯´è¯ï¼‰",
    "æ ¸å¿ƒç‰¹å¾2",
    "æ ¸å¿ƒç‰¹å¾3"
  ],
  "rootCauses": [
    {
      "title": "åŸå› 1æ ‡é¢˜ï¼ˆæ¸©æŸ”ã€ç†è§£çš„è¯­æ°”ï¼‰",
      "desc": "åŸå› 1è¯´æ˜ï¼ˆç”Ÿæ´»åŒ–çš„æ¯”å–»ï¼Œå®Œå…¨ä¸ç”¨æœ¯è¯­ï¼‰"
    },
    {
      "title": "åŸå› 2æ ‡é¢˜",
      "desc": "åŸå› 2è¯´æ˜"
    }
  ],
  "positiveReframe": "æ¢ä¸ªè§’åº¦çœ‹è‡ªå·±çš„å†…å®¹ï¼ˆåƒæœ‹å‹åœ¨é¼“åŠ±ä½ ï¼‰"
}`;
}

/**
 * è°ƒç”¨AI APIç”Ÿæˆåˆ†æ (æ”¯æŒå¤šä¾›åº”å•†)
 */
async function generateAIAnalysis(report, answers, basicInfo) {
  const startTime = Date.now();

  try {
    // è·å–å½“å‰æ¿€æ´»çš„AIé…ç½®
    const configResult = await getActiveAIConfig();
    if (!configResult.success) {
      throw new Error('è·å–AIé…ç½®å¤±è´¥: ' + configResult.error);
    }

    const config = configResult.data;
    const prompt = buildPrompt(report, answers, basicInfo);

    console.log(`ğŸ¤– è°ƒç”¨ ${config.provider} AI API...`);
    console.log(`ğŸ“¡ APIåœ°å€: ${config.api_url}`);
    console.log(`ğŸ¤– æ¨¡å‹: ${config.model}`);

    const requestBody = {
      model: config.model,
      messages: [
        {
          role: 'system',
          content: 'ä½ æ˜¯ä¸€ä½æ¸©æš–ã€å–„è§£äººæ„çš„å¿ƒç†é™ªä¼´è€…ï¼Œåƒç”¨æˆ·æœ€ä¿¡ä»»çš„æœ‹å‹ã€‚ä½ ç”¨æœ€é€šä¿—æ˜“æ‡‚ã€æœ€æœ‰æ¸©åº¦çš„è¯­è¨€å¸®åŠ©äººä»¬ç†è§£è‡ªå·±ï¼Œä»ä¸ä½¿ç”¨å†°å†·çš„ä¸“ä¸šæœ¯è¯­ï¼Œè€Œæ˜¯ç”¨ç”Ÿæ´»åŒ–çš„æ¯”å–»å’ŒçœŸè¯šçš„å…±æƒ…è®©äººæ„Ÿåˆ°è¢«ç†è§£ã€è¢«æ¥çº³ã€‚'
        },
        {
          role: 'user',
          content: prompt
        }
      ],
      temperature: parseFloat(config.temperature) || 0.7,
      max_tokens: parseInt(config.max_tokens) || 2000
    };

    // ğŸš€ ã€æ–°å¢ã€‘é˜¿é‡Œäº‘ç™¾ç‚¼ç‰¹æ®Šå‚æ•°æ”¯æŒ
    if (config.provider === 'aliyun_bailian') {
      console.log('ğŸš€ [é˜¿é‡Œäº‘ç™¾ç‚¼] ä½¿ç”¨æ ‡å‡†æ¨¡å¼ï¼ˆæš‚ä¸å¯ç”¨æ·±åº¦æ€è€ƒï¼Œé¿å…æµå¼å¤„ç†å¤æ‚æ€§ï¼‰');
      // æ³¨æ„ï¼šenable_thinkingéœ€è¦stream=trueï¼Œä½†æµå¼å¤„ç†è¾ƒå¤æ‚ï¼Œæš‚æ—¶ä½¿ç”¨æ ‡å‡†æ¨¡å¼
    }

    console.log('ğŸ“¤ è¯·æ±‚ä½“:', JSON.stringify(requestBody, null, 2));

    const response = await fetch(config.api_url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${config.api_key}`
      },
      body: JSON.stringify(requestBody)
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`AI APIé”™è¯¯: ${response.status} - ${errorText}`);
    }

    const data = await response.json();
    const aiResponse = data.choices?.[0]?.message?.content || '';
    
    console.log('ğŸ” [è°ƒè¯•] AIåŸå§‹å“åº”å†…å®¹:', aiResponse);
    
    // è§£æJSON
    const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
    if (!jsonMatch) {
      console.error('âŒ [è°ƒè¯•] æ— æ³•ä»AIå“åº”ä¸­æå–JSON:', aiResponse);
      throw new Error('AIè¿”å›æ ¼å¼é”™è¯¯ï¼Œæ— æ³•æå–JSON');
    }

    console.log('ğŸ” [è°ƒè¯•] æå–çš„JSONå­—ç¬¦ä¸²:', jsonMatch[0]);
    const analysis = JSON.parse(jsonMatch[0]);
    console.log('ğŸ” [è°ƒè¯•] è§£æåçš„å¯¹è±¡:', analysis);
    
    // éªŒè¯å¿…è¦å­—æ®µ
    if (!analysis.typeName || !analysis.features || !analysis.rootCauses) {
      console.error('âŒ AIè¿”å›æ•°æ®éªŒè¯å¤±è´¥:', {
        hasTypeName: !!analysis.typeName,
        hasFeatures: !!analysis.features,
        hasRootCauses: !!analysis.rootCauses,
        actualKeys: Object.keys(analysis)
      });
      throw new Error('AIè¿”å›æ•°æ®ä¸å®Œæ•´');
    }

    const responseTime = Date.now() - startTime;
    const tokens = data.usage?.total_tokens || 0;
    
    console.log(`âœ… AIç”ŸæˆæˆåŠŸ (${responseTime}ms, ${tokens} tokens)`);
    
    return {
      success: true,
      data: {
        id: 'ai_generated',
        name: analysis.typeName,
        englishName: analysis.englishName || 'AI Generated Type',
        features: analysis.features,
        rootCauses: analysis.rootCauses,
        positiveReframe: analysis.positiveReframe
      },
      responseTime,
      tokens
    };

  } catch (error) {
    const responseTime = Date.now() - startTime;
    console.error('âŒ AIç”Ÿæˆå¤±è´¥:', error.message);
    
    return {
      success: false,
      error: error.message,
      responseTime,
      tokens: 0
    };
  }
}

module.exports = {
  generateAIAnalysis
};

